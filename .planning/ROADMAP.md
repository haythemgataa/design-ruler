# Roadmap: Design Ruler

## Milestones

- ✅ **v1.0 Enhancement** — Phases 1-5 (shipped 2026-02-13)
- ✅ **v1.1 Hint Bar Redesign** — Phases 6-8 (shipped 2026-02-14)
- ✅ **v1.2 Alignment Guides** — Phases 9-11 (shipped 2026-02-16)
- **v1.3 Code Unification** — Phases 12-16 (in progress)

## Phases

<details>
<summary>v1.0 Enhancement (Phases 1-5) — SHIPPED 2026-02-13</summary>

- [x] Phase 1: Debug Cleanup and Process Safety (1/1 plans) — completed 2026-02-13
- [x] Phase 2: Cursor State Machine (1/1 plans) — completed 2026-02-13
- [x] Phase 3: Snap Failure Shake (1/1 plans) — completed 2026-02-13
- [x] Phase 4: Selection Pill Clamping (1/1 plans) — completed 2026-02-13
- [x] Phase 5: Help Toggle System (1/1 plans) — completed 2026-02-13

</details>

<details>
<summary>v1.1 Hint Bar Redesign (Phases 6-8) — SHIPPED 2026-02-14</summary>

- [x] Phase 6: Remove Help Toggle System (1/1 plans) — completed 2026-02-14
- [x] Phase 7: Hint Bar Visual Redesign (2/2 plans) — completed 2026-02-14
- [x] Phase 8: Launch-to-Collapse Animation (1/1 plans) — completed 2026-02-14

</details>

<details>
<summary>v1.2 Alignment Guides (Phases 9-11) — SHIPPED 2026-02-16</summary>

- [x] Phase 9: Scaffold + Preview Line + Placement (1/1 plans) — completed 2026-02-16
- [x] Phase 10: Remove Interaction + Color System (2/2 plans) — completed 2026-02-16
- [x] Phase 11: Hint Bar + Multi-Monitor + Polish (6/6 plans) — completed 2026-02-16

</details>

### v1.3 Code Unification (In Progress)

**Milestone Goal:** Eliminate ~400 lines of duplicated code across both commands by extracting shared utilities, base classes, and centralized tokens — while preserving identical runtime behavior.

- [ ] **Phase 12: Leaf Utilities** - Design tokens, animation constants, and CATransaction helpers that everything else depends on
- [ ] **Phase 13: Rendering Unification** - Shared pill rendering (font, paths, text layers, shadows) replacing 3 duplicated implementations
- [ ] **Phase 14: Coordinator Base** - Shared lifecycle extraction (warmup, permissions, signal handler, exit, screen capture) from both command entry points
- [ ] **Phase 15: Window Base + Cursor** - Shared overlay window configuration and unified cursor management including resize states
- [ ] **Phase 16: Final Cleanup** - HintBarContent internal deduplication

## Phase Details

### Phase 12: Leaf Utilities
**Goal**: Both commands share a single source of truth for design constants and transaction boilerplate
**Depends on**: Nothing (leaf utilities, no upstream dependencies)
**Requirements**: TOKN-01, TOKN-02, TOKN-03, TXNS-01, TXNS-02
**Success Criteria** (what must be TRUE):
  1. All pill background colors, shadow colors, radii, heights, and kerning values come from one DesignTokens definition — no inline hex/numeric literals for these values remain in CrosshairView, GuideLine, or SelectionOverlay
  2. Animation durations across all files reference named constants (e.g., `AnimationDuration.fast`, `.standard`) instead of scattered magic numbers — changing a tier value in one place changes it everywhere
  3. The `"differenceBlendMode"` string appears exactly once as a constant, referenced by all blend mode assignments
  4. `CATransaction.instant { }` and `CATransaction.animated(duration:) { }` are used throughout — no remaining raw `begin()`/`setDisableActions(true)`/`commit()` boilerplate blocks
  5. Both commands build and run with identical behavior to before (crosshair, guides, pills, animations all unchanged)
**Plans:** 2 plans

Plans:
- [ ] 12-01-PLAN.md — Create DesignTokens.swift (tokens + BlendMode) and TransactionHelpers.swift
- [ ] 12-02-PLAN.md — Sweep all files to consume shared tokens and transaction helpers

### Phase 13: Rendering Unification
**Goal**: Pill rendering code exists in one shared location, consumed by CrosshairView, GuideLine, and SelectionOverlay
**Depends on**: Phase 12 (uses tokens for colors, radii, heights)
**Requirements**: REND-01, REND-02, REND-03, REND-04, REND-05
**Success Criteria** (what must be TRUE):
  1. CrosshairView, GuideLine, and SelectionOverlay all call a single `makeDesignFont(size:)` factory — no duplicated OpenType feature array setup
  2. Squircle and section pill paths are generated by shared functions (`squirclePath`, `sectionPath`) — no per-file path geometry duplication
  3. Label and value text formatting (`labelText(_:)`, `valueText(_:)`) exist once and are called from both CrosshairView and GuideLine
  4. Pill shadow configuration (offset, radius, color, opacity) is applied via a single shared helper — not repeated in 3 places
  5. Both commands render pills identically to before (same font, same shape, same shadow, same text formatting)
**Plans**: TBD

Plans:
- [ ] 13-01: TBD

### Phase 14: Coordinator Base
**Goal**: Ruler.swift and AlignmentGuides.swift delegate shared lifecycle operations to a common coordinator base, each retaining only command-specific logic
**Depends on**: Phase 12 (coordinator uses transaction helpers and tokens)
**Requirements**: CORD-01, CORD-02, CORD-03, CORD-04, CORD-05
**Success Criteria** (what must be TRUE):
  1. Warmup capture, permission check, and cursor screen detection exist once in a shared base — not duplicated between Ruler.swift and AlignmentGuides.swift
  2. Window lifecycle (cleanup, show loop, key window setup) is managed by the base — each command only provides its window factory
  3. `handleExit()`, `handleFirstMove()`, `setupSignalHandler()`, and `resetInactivityTimer()` exist once in the base — not reimplemented per command
  4. Screen capture (`captureScreen()`) is a shared utility called by both EdgeDetector and AlignmentGuides — not duplicated
  5. Both commands launch, run, and exit identically to before (same capture order, same permission flow, same signal handling, same 10-minute timeout)
**Plans**: TBD

Plans:
- [ ] 14-01: TBD
- [ ] 14-02: TBD

### Phase 15: Window Base + Cursor
**Goal**: RulerWindow and AlignmentGuidesWindow share a common overlay window base, and CursorManager handles all cursor states including resize
**Depends on**: Phase 14 (window base integrates with coordinator lifecycle)
**Requirements**: WIND-01, WIND-02, WIND-03, WIND-04, CURS-01
**Success Criteria** (what must be TRUE):
  1. Shared NSWindow configuration (level, styleMask, backgroundColor, acceptsMouseMoved, etc.) exists once in a base class — not repeated across both window subclasses
  2. `setupTrackingArea()`, `collapseHintBar()`, `mouseEntered`, and `canBecomeKey`/`canBecomeMain` are implemented once in the base
  3. Mouse move throttle (0.014s guard) and first-move detection logic exist once in the base — each subclass only overrides `handleMouseMoved(to:)`
  4. CursorManager handles `resizeUpDown` and `resizeLeftRight` states — AlignmentGuidesWindow no longer manages resize cursors independently
  5. Both commands exhibit identical window behavior (tracking, throttling, hint bar positioning, cursor transitions) as before
**Plans**: TBD

Plans:
- [ ] 15-01: TBD
- [ ] 15-02: TBD

### Phase 16: Final Cleanup
**Goal**: HintBarContent has no remaining internal duplication
**Depends on**: Phase 12 (may reference tokens for tint colors)
**Requirements**: CLNP-01
**Success Criteria** (what must be TRUE):
  1. `escTint` color, `text()` helper, and `exitText()` helper are each defined once and shared across the 3 HintBarContent structs — not copy-pasted per struct
  2. HintBarContent renders identically in both inspect and alignment guides modes (same keycap layout, same colors, same text)
**Plans**: TBD

Plans:
- [ ] 16-01: TBD

## Progress

**Execution Order:**
Phases execute in numeric order: 12 -> 13 -> 14 -> 15 -> 16

| Phase | Milestone | Plans Complete | Status | Completed |
|-------|-----------|----------------|--------|-----------|
| 1. Debug Cleanup and Process Safety | v1.0 | 1/1 | Complete | 2026-02-13 |
| 2. Cursor State Machine | v1.0 | 1/1 | Complete | 2026-02-13 |
| 3. Snap Failure Shake | v1.0 | 1/1 | Complete | 2026-02-13 |
| 4. Selection Pill Clamping | v1.0 | 1/1 | Complete | 2026-02-13 |
| 5. Help Toggle System | v1.0 | 1/1 | Complete | 2026-02-13 |
| 6. Remove Help Toggle System | v1.1 | 1/1 | Complete | 2026-02-14 |
| 7. Hint Bar Visual Redesign | v1.1 | 2/2 | Complete | 2026-02-14 |
| 8. Launch-to-Collapse Animation | v1.1 | 1/1 | Complete | 2026-02-14 |
| 9. Scaffold + Preview Line + Placement | v1.2 | 1/1 | Complete | 2026-02-16 |
| 10. Remove Interaction + Color System | v1.2 | 2/2 | Complete | 2026-02-16 |
| 11. Hint Bar + Multi-Monitor + Polish | v1.2 | 6/6 | Complete | 2026-02-16 |
| 12. Leaf Utilities | v1.3 | 0/? | Not started | - |
| 13. Rendering Unification | v1.3 | 0/? | Not started | - |
| 14. Coordinator Base | v1.3 | 0/? | Not started | - |
| 15. Window Base + Cursor | v1.3 | 0/? | Not started | - |
| 16. Final Cleanup | v1.3 | 0/? | Not started | - |
