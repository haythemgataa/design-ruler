---
phase: 12-leaf-utilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - swift/Ruler/Sources/Utilities/DesignTokens.swift
  - swift/Ruler/Sources/Utilities/TransactionHelpers.swift
autonomous: true

must_haves:
  truths:
    - "All shared pill colors, shadow values, radii, heights, and kerning live in one DesignTokens enum"
    - "Animation durations are named constants grouped by speed tier"
    - "The differenceBlendMode string appears exactly once as BlendMode.difference"
    - "CATransaction.instant {} and CATransaction.animated(duration:timing:) {} helpers exist and compile"
  artifacts:
    - path: "swift/Ruler/Sources/Utilities/DesignTokens.swift"
      provides: "Design tokens (colors, radii, heights, kerning, animation durations) and BlendMode enum"
      contains: "enum DesignTokens"
    - path: "swift/Ruler/Sources/Utilities/TransactionHelpers.swift"
      provides: "CATransaction extension with instant and animated helpers"
      contains: "extension CATransaction"
  key_links: []
---

<objective>
Create the two new shared utility files that all subsequent refactoring depends on: `DesignTokens.swift` containing centralized design constants and the `BlendMode` enum, and `TransactionHelpers.swift` containing `CATransaction` convenience extensions.

Purpose: Establish the single source of truth for design values and transaction boilerplate that Plan 02 will wire into all existing files.
Output: Two new Swift files in `Utilities/` that compile successfully.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@swift/Ruler/Sources/Rendering/CrosshairView.swift
@swift/Ruler/Sources/AlignmentGuides/GuideLine.swift
@swift/Ruler/Sources/Rendering/SelectionOverlay.swift
@swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift
@swift/Ruler/Sources/Rendering/HintBarView.swift
@swift/Ruler/Sources/Utilities/CoordinateConverter.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DesignTokens.swift and BlendMode enum</name>
  <files>swift/Ruler/Sources/Utilities/DesignTokens.swift</files>
  <action>
Create `swift/Ruler/Sources/Utilities/DesignTokens.swift` with two caseless enums: `DesignTokens` and `BlendMode`.

**DesignTokens** — caseless enum with nested caseless enums for grouping. Extract these values from CrosshairView, GuideLine, and SelectionOverlay:

`DesignTokens.Pill`:
- `height: CGFloat = 24` (CrosshairView:34, GuideLine:36, SelectionOverlay:31)
- `cornerRadius: CGFloat = 8` (CrosshairView:36 outerRadius, GuideLine:37, SelectionOverlay:33)
- `innerCornerRadius: CGFloat = 4` (CrosshairView:37 innerRadius — used only in two-section pills)
- `sectionGap: CGFloat = 2` (CrosshairView:35 — gap between W and H sections)
- `backgroundColor: CGColor = CGColor(gray: 0, alpha: 0.8)` (CrosshairView:164, GuideLine:81, SelectionOverlay:27)
- `kerning: CGFloat = -0.36` (CrosshairView:352, GuideLine:340, SelectionOverlay:254)

`DesignTokens.Shadow`:
- `color: CGColor = CGColor(gray: 0, alpha: 0.3)` (CrosshairView:168, GuideLine:84, SelectionOverlay:79)
- `offset: CGSize = CGSize(width: 0, height: -1)` (CrosshairView:169, GuideLine:85, SelectionOverlay:80)
- `radius: CGFloat = 3` (CrosshairView:170, GuideLine:86, SelectionOverlay:81)
- `opacity: Float = 1.0` (CrosshairView:171, GuideLine:87, SelectionOverlay:82)

`DesignTokens.Color`:
- `hoverRed: CGColor = CGColor(srgbRed: 1.0, green: 0.35, blue: 0.35, alpha: 1.0)` (GuideLine:255, SelectionOverlay:24)
- `hoverRedFill: CGColor = CGColor(srgbRed: 1.0, green: 0.35, blue: 0.35, alpha: 0.06)` (SelectionOverlay:26)
- `hoverRedPillBg: CGColor = CGColor(srgbRed: 0.85, green: 0.2, blue: 0.2, alpha: 0.85)` (SelectionOverlay:28)
- `removePillBg: CGColor = CGColor(srgbRed: 1.0, green: 0.35, blue: 0.35, alpha: 0.9)` (GuideLine:165)

`DesignTokens.Animation` — named speed tiers:
- `fast: CFTimeInterval = 0.15` (pill flip, selection hover, guide opacity, circle transition)
- `standard: CFTimeInterval = 0.2` (selection snap, shrink-to-point, circle appear/exit)
- `slow: CFTimeInterval = 0.3` (initial pill fade-in, hint bar slide)
- `collapse: CFTimeInterval = 0.35` (hint bar collapse, entrance animation)

**BlendMode** — separate top-level caseless enum (per user decision):
- `difference: String = "differenceBlendMode"`

Both enums must import `QuartzCore` (for CGColor, CGSize, CGFloat, CFTimeInterval).
Use `static let` for all properties. No initializers (caseless enum prevents instantiation).
  </action>
  <verify>Run `cd /Users/haythem/Developer/design-ruler/swift/Ruler && swift build 2>&1 | tail -20` — must compile with zero errors.</verify>
  <done>DesignTokens.swift exists in Utilities/ with all listed token values and BlendMode.difference, project compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create TransactionHelpers.swift</name>
  <files>swift/Ruler/Sources/Utilities/TransactionHelpers.swift</files>
  <action>
Create `swift/Ruler/Sources/Utilities/TransactionHelpers.swift` with a `CATransaction` extension providing two static helpers:

```swift
import QuartzCore

extension CATransaction {
    /// Execute a block with all implicit animations disabled.
    static func instant(_ body: () -> Void) {
        begin()
        setDisableActions(true)
        body()
        commit()
    }

    /// Execute a block with explicit animation duration and optional timing function.
    /// Defaults to easeOut timing when no timing function is provided.
    static func animated(duration: CFTimeInterval, timing: CAMediaTimingFunctionName = .easeOut, _ body: () -> Void) {
        begin()
        setAnimationDuration(duration)
        setAnimationTimingFunction(CAMediaTimingFunction(name: timing))
        body()
        commit()
    }
}
```

The `animated` helper defaults to `.easeOut` because that is the dominant timing function in the codebase (used in ~90% of animated transactions). The few `.easeIn` uses can pass `timing: .easeIn` explicitly.

Note: Some CATransaction blocks use `setCompletionBlock` — those blocks are NOT candidates for the helpers and should remain as raw begin/commit (the helpers don't support completion blocks, keeping them simple). This is by design.
  </action>
  <verify>Run `cd /Users/haythem/Developer/design-ruler/swift/Ruler && swift build 2>&1 | tail -20` — must compile with zero errors.</verify>
  <done>TransactionHelpers.swift exists in Utilities/ with `instant` and `animated` helpers, project compiles cleanly.</done>
</task>

</tasks>

<verification>
1. Both new files exist: `swift/Ruler/Sources/Utilities/DesignTokens.swift` and `swift/Ruler/Sources/Utilities/TransactionHelpers.swift`
2. `swift build` succeeds with zero errors
3. DesignTokens contains all listed pill, shadow, color, and animation tokens
4. BlendMode.difference equals `"differenceBlendMode"`
5. CATransaction.instant and CATransaction.animated are available as static methods
</verification>

<success_criteria>
Two new utility files compile and provide all the shared constants and helpers needed for Plan 02's codebase-wide sweep. No existing files modified yet.
</success_criteria>

<output>
After completion, create `.planning/phases/12-leaf-utilities/12-01-SUMMARY.md`
</output>
