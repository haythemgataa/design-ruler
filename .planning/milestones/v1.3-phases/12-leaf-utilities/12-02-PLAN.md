---
phase: 12-leaf-utilities
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - swift/Ruler/Sources/Rendering/CrosshairView.swift
  - swift/Ruler/Sources/Rendering/SelectionOverlay.swift
  - swift/Ruler/Sources/AlignmentGuides/GuideLine.swift
  - swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift
  - swift/Ruler/Sources/Rendering/HintBarView.swift
autonomous: true

must_haves:
  truths:
    - "No inline pill bg color, shadow color, shadow offset, shadow radius, shadow opacity, pill height, corner radius, or kerning literals remain in CrosshairView, GuideLine, or SelectionOverlay — all reference DesignTokens"
    - "No inline differenceBlendMode string literals remain anywhere — all reference BlendMode.difference"
    - "No raw CATransaction.begin/setDisableActions(true)/commit boilerplate remains — all converted to CATransaction.instant {}"
    - "No raw CATransaction.begin/setAnimationDuration/setAnimationTimingFunction/commit boilerplate remains — all eligible blocks converted to CATransaction.animated(duration:timing:) {}"
    - "Animation durations reference DesignTokens.Animation named constants instead of magic number literals"
    - "Both commands build and run with identical behavior (crosshair, guides, pills, animations all unchanged)"
  artifacts:
    - path: "swift/Ruler/Sources/Rendering/CrosshairView.swift"
      provides: "Crosshair view using shared tokens and transaction helpers"
    - path: "swift/Ruler/Sources/Rendering/SelectionOverlay.swift"
      provides: "Selection overlay using shared tokens and transaction helpers"
    - path: "swift/Ruler/Sources/AlignmentGuides/GuideLine.swift"
      provides: "Guide line using shared tokens and transaction helpers"
    - path: "swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift"
      provides: "Color circle indicator using transaction helpers"
    - path: "swift/Ruler/Sources/Rendering/HintBarView.swift"
      provides: "Hint bar view using transaction helpers"
  key_links:
    - from: "swift/Ruler/Sources/Rendering/CrosshairView.swift"
      to: "swift/Ruler/Sources/Utilities/DesignTokens.swift"
      via: "DesignTokens.Pill, DesignTokens.Shadow, DesignTokens.Animation, BlendMode.difference"
      pattern: "DesignTokens\\."
    - from: "swift/Ruler/Sources/AlignmentGuides/GuideLine.swift"
      to: "swift/Ruler/Sources/Utilities/DesignTokens.swift"
      via: "DesignTokens.Pill, DesignTokens.Shadow, DesignTokens.Color, BlendMode.difference"
      pattern: "DesignTokens\\."
    - from: "swift/Ruler/Sources/Rendering/SelectionOverlay.swift"
      to: "swift/Ruler/Sources/Utilities/DesignTokens.swift"
      via: "DesignTokens.Pill, DesignTokens.Shadow, DesignTokens.Color, BlendMode.difference"
      pattern: "DesignTokens\\."
---

<objective>
Sweep all 5 files that contain duplicated design values and raw CATransaction boilerplate, replacing them with references to the shared DesignTokens, BlendMode, and CATransaction helpers created in Plan 01.

Purpose: Eliminate all remaining inline magic numbers and transaction boilerplate, completing the phase's goal of a single source of truth.
Output: 5 modified Swift files, zero remaining inline literals for shared design values.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-leaf-utilities/12-01-SUMMARY.md

@swift/Ruler/Sources/Utilities/DesignTokens.swift
@swift/Ruler/Sources/Utilities/TransactionHelpers.swift
@swift/Ruler/Sources/Rendering/CrosshairView.swift
@swift/Ruler/Sources/AlignmentGuides/GuideLine.swift
@swift/Ruler/Sources/Rendering/SelectionOverlay.swift
@swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift
@swift/Ruler/Sources/Rendering/HintBarView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace tokens and transactions in CrosshairView, GuideLine, and SelectionOverlay</name>
  <files>
    swift/Ruler/Sources/Rendering/CrosshairView.swift
    swift/Ruler/Sources/AlignmentGuides/GuideLine.swift
    swift/Ruler/Sources/Rendering/SelectionOverlay.swift
  </files>
  <action>
These 3 files are the primary pill renderers with the most duplication. For each file, perform ALL of the following replacements:

**A. Design Token Replacements (all 3 files)**

Pill background color — replace `CGColor(gray: 0, alpha: 0.8)` with `DesignTokens.Pill.backgroundColor`:
- CrosshairView: line 164 (`let bgColor = ...`)
- GuideLine: line 81 (`let bgColor = ...`) and line 172 (in layoutPill)
- SelectionOverlay: line 27 (`normalPillBg` property)

Shadow properties — replace inline literals with `DesignTokens.Shadow.*`:
- `.shadowColor = CGColor(gray: 0, alpha: 0.3)` → `.shadowColor = DesignTokens.Shadow.color`
- `.shadowOffset = CGSize(width: 0, height: -1)` → `.shadowOffset = DesignTokens.Shadow.offset`
- `.shadowRadius = 3` → `.shadowRadius = DesignTokens.Shadow.radius`
- `.shadowOpacity = 1.0` → `.shadowOpacity = DesignTokens.Shadow.opacity`
- Occurs in CrosshairView:168-171, GuideLine:84-87, SelectionOverlay:79-82

Pill height — replace `24` with `DesignTokens.Pill.height`:
- CrosshairView:34 (`private let pillHeight`)
- GuideLine:36 (`private let pillHeight`)
- SelectionOverlay:31 (`private let pillHeight`)
- Option: Remove the local `pillHeight` property entirely and use `DesignTokens.Pill.height` directly, OR keep the local as `private let pillHeight = DesignTokens.Pill.height` — Claude's discretion on which reads better.

Corner radius — replace `8` with `DesignTokens.Pill.cornerRadius`:
- CrosshairView:36 (`private let outerRadius`)
- GuideLine:37 (`private let outerRadius`)
- SelectionOverlay:33 (`private let pillRadius`)
- Same approach as pillHeight.

Inner corner radius — replace `4` with `DesignTokens.Pill.innerCornerRadius`:
- CrosshairView:37 (`private let innerRadius`)

Section gap — replace `2` with `DesignTokens.Pill.sectionGap`:
- CrosshairView:35 (`private let sectionGap`)

Kerning — replace `-0.36 as CGFloat` with `DesignTokens.Pill.kerning`:
- CrosshairView: lines 352, 363 (labelText, valueText)
- GuideLine: lines 163, 340, 350 (remove mode text, labelText, valueText)
- SelectionOverlay: lines 254, 258, 274 (setDimensionsText, setClearText)

Hover red colors — replace with `DesignTokens.Color.*`:
- GuideLine:165 remove pill bg → `DesignTokens.Color.removePillBg`
- GuideLine:255 hover stroke → `DesignTokens.Color.hoverRed`
- SelectionOverlay:24 `hoveredStroke` → `DesignTokens.Color.hoverRed`
- SelectionOverlay:26 `hoveredFill` → `DesignTokens.Color.hoverRedFill`
- SelectionOverlay:28 `hoveredPillBg` → `DesignTokens.Color.hoverRedPillBg`

**B. BlendMode Replacements (all 3 files)**

Replace every `"differenceBlendMode"` string literal with `BlendMode.difference`:
- CrosshairView: lines 149, 158, 390 (3 occurrences)
- GuideLine: lines 75, 138, 263 (3 occurrences)
- SelectionOverlay: lines 73, 179 (2 occurrences)

**C. CATransaction Replacements (all 3 files)**

Replace `CATransaction.begin() / setDisableActions(true) / ... / commit()` blocks with `CATransaction.instant { ... }`:
- CrosshairView: lines 89-97 (hideForDrag), 102-110 (showAfterDrag), 190-237 (update lines+feet), 256-259 (initial pill opacity)
- GuideLine: lines 119-146 (update), 250-267 (setHovered), 272-277 (hidePill), 282-285 (setLineVisible)
- SelectionOverlay: lines 106-117 (updateRect non-animated path), 141-146 (pill layout instant)

Replace `CATransaction.begin() / setAnimationDuration(X) / setAnimationTimingFunction(.easeOut) / ... / commit()` blocks with `CATransaction.animated(duration: DesignTokens.Animation.X) { ... }`:
- CrosshairView: lines 264-268 (showInitialPill fade-in, 0.3 → `DesignTokens.Animation.slow`)
- SelectionOverlay: lines 128-137 (animateSnap, 0.2 → `DesignTokens.Animation.standard`), 174-190 (setHovered, 0.15 → `DesignTokens.Animation.fast`), 230-236 (remove animated, 0.15 → `DesignTokens.Animation.fast`)
- GuideLine: lines 231-245 (setOpacity animated path — this is a conditional block: if animated use `CATransaction.animated`, else use `CATransaction.instant`)

**Special case — CrosshairView layoutPill (lines 305-343):** This block conditionally animates (if flipped) or is instant. Convert to:
```swift
if flipped {
    CATransaction.animated(duration: DesignTokens.Animation.fast) { ... }
} else {
    CATransaction.instant { ... }
}
```
Or use a single block with conditional setup — Claude's discretion on which is cleaner.

**Blocks to LEAVE as raw begin/commit** (they use setCompletionBlock or have special structure):
- SelectionOverlay: shakeAndRemove (lines 216-224, uses setCompletionBlock)
- GuideLine: shrinkToPoint (lines 300-312, uses setCompletionBlock)

**D. Animation Duration Replacements**

Replace magic number durations with `DesignTokens.Animation.*`:
- `0.15` → `DesignTokens.Animation.fast` (CrosshairView pill flip, SelectionOverlay hover/remove, GuideLine opacity)
- `0.2` → `DesignTokens.Animation.standard` (SelectionOverlay snap, GuideLine shrink pathAnim.duration)
- `0.3` → `DesignTokens.Animation.slow` (CrosshairView initial pill fade-in)
- GuideLine remove asyncAfter delay `0.15` → `DesignTokens.Animation.fast` (line 319)
  </action>
  <verify>Run `cd /Users/haythem/Developer/design-ruler/swift/Ruler && swift build 2>&1 | tail -20` — must compile with zero errors. Then verify: `grep -c '"differenceBlendMode"' Sources/Rendering/CrosshairView.swift Sources/AlignmentGuides/GuideLine.swift Sources/Rendering/SelectionOverlay.swift` — all counts must be 0.</verify>
  <done>All three pill-rendering files use DesignTokens and BlendMode exclusively for shared design values, CATransaction blocks use helpers, animation durations use named constants. Zero inline duplicated literals remain.</done>
</task>

<task type="auto">
  <name>Task 2: Replace transactions in ColorCircleIndicator and HintBarView</name>
  <files>
    swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift
    swift/Ruler/Sources/Rendering/HintBarView.swift
  </files>
  <action>
These files have CATransaction boilerplate but fewer design token duplications. Convert all eligible blocks.

**ColorCircleIndicator.swift — CATransaction replacements:**

Instant blocks → `CATransaction.instant { ... }`:
- Lines 69-80 (show, wasHidden — set model values)
- Lines 128-134 (show, already visible — position update)
- Lines 201-207 (updatePosition)
- Lines 383-392 (fadeOut — set model values)
- Lines 441-450 (fadeOut cleanup)

Animated blocks → `CATransaction.animated(duration:) { ... }`:
- Lines 137-175 (show, already visible — animate size change, 0.15 → `DesignTokens.Animation.fast`)

**Animation duration replacements in ColorCircleIndicator:**
- `duration: 0.2` in appear/exit animations (lines 91, 98, 109, 116, etc.) → `DesignTokens.Animation.standard`
- `duration: 0.15` in dot pulse and size transition → `DesignTokens.Animation.fast`
- `0.2` in fadeOut animations (lines 403, 410, etc.) → `DesignTokens.Animation.standard`

**HintBarView.swift — CATransaction replacements:**

The HintBarView only has one CATransaction block (lines 515-521, animateSlide), and it uses `setCompletionBlock` — so it should remain as raw begin/commit. However, do replace the magic number durations:

**Animation duration replacements in HintBarView:**
- `animateToCollapsed(duration: TimeInterval = 0.35)` default parameter → `DesignTokens.Animation.collapse`
- `group.duration = 0.35` in animateEntrance → `DesignTokens.Animation.collapse`
- `anim.duration = 0.3` in animateSlide → `DesignTokens.Animation.slow`
- `animateToCollapsedFallback(duration:)` receives the duration parameter — no change needed there (it's passed through)

Note: Leave SwiftUI `.bouncy(duration: 0.6)` and `.animation(.easeOut(duration: 0.06))` durations as-is — they are SwiftUI-specific and one-off values not shared anywhere.
  </action>
  <verify>Run `cd /Users/haythem/Developer/design-ruler/swift/Ruler && swift build 2>&1 | tail -20` — must compile with zero errors. Then verify: `grep -rn '"differenceBlendMode"' Sources/` — should return ONLY `DesignTokens.swift` (exactly 1 occurrence in the definition).</verify>
  <done>All 5 target files converted. The `"differenceBlendMode"` string appears exactly once (in DesignTokens.swift). No raw CATransaction boilerplate remains in eligible blocks. Animation durations use named constants. Project compiles and runs identically.</done>
</task>

</tasks>

<verification>
1. `swift build` succeeds with zero errors
2. `grep -rn '"differenceBlendMode"' Sources/` returns only 1 result (in DesignTokens.swift)
3. `grep -rn 'CGColor(gray: 0, alpha: 0.8)' Sources/` returns 0 results outside DesignTokens.swift
4. `grep -rn 'shadowRadius = 3' Sources/` returns 0 results outside DesignTokens.swift
5. `grep -rn 'kern: -0.36' Sources/` returns 0 results outside DesignTokens.swift
6. `grep -c 'CATransaction.instant' Sources/Rendering/CrosshairView.swift Sources/AlignmentGuides/GuideLine.swift Sources/Rendering/SelectionOverlay.swift Sources/AlignmentGuides/ColorCircleIndicator.swift` — all counts > 0
7. `ray build` succeeds (full Raycast build test)
</verification>

<success_criteria>
All 5 files consume shared tokens and transaction helpers. Zero duplicated design literals remain. Both commands build and behave identically to before the refactoring.
</success_criteria>

<output>
After completion, create `.planning/phases/12-leaf-utilities/12-02-SUMMARY.md`
</output>
