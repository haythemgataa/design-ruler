---
phase: 13-rendering-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - swift/Ruler/Sources/Rendering/PillRenderer.swift
autonomous: true

must_haves:
  truths:
    - "PillRenderer.makePill(.dimension, scale:) returns a DimensionPill with 2 background layers, 4 text layers, shadow pre-applied, all added to the provided parent layer"
    - "PillRenderer.makePill(.position, scale:) returns a PositionPill with 1 background layer, 2 text layers, shadow pre-applied"
    - "PillRenderer.makePill(.selection, scale:) returns a SelectionPill with 1 background layer, 1 text layer, shadow pre-applied"
    - "squirclePath and sectionPath generate correct continuous-corner paths matching existing output"
    - "labelText and valueText produce identically styled NSAttributedStrings as the current implementations"
    - "applyCircleShadow is available as a named preset for ColorCircleIndicator"
    - "PillRenderer factories produce visually identical layer configurations to current inline implementations"
    - "Project builds with the new file included"
  artifacts:
    - path: "swift/Ruler/Sources/Rendering/PillRenderer.swift"
      provides: "Pill factory with 3 factory methods (makeDimensionPill, makePositionPill, makeSelectionPill) returning configured layer hierarchies, plus shared path generators, text formatters, and circle shadow preset"
      contains: "enum PillRenderer"
  key_links:
    - from: "swift/Ruler/Sources/Rendering/PillRenderer.swift"
      to: "swift/Ruler/Sources/Utilities/DesignTokens.swift"
      via: "References DesignTokens.Pill, DesignTokens.Shadow, DesignTokens.Color"
      pattern: "DesignTokens\\."
---

<objective>
Create PillRenderer.swift with a full pill factory that returns configured layer hierarchies for each pill variant, plus shared path generators, text formatters, and shadow presets.

Purpose: Centralize all pill rendering into a factory so consumers receive ready-to-use layer hierarchies and only set position and text content. Per user decision: "PillRenderer.makePill() returns a configured layer hierarchy with shadow, paths, and text layers already wired up."
Output: PillRenderer.swift in Rendering/ folder with pill factory, compiling and ready for consumption.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-rendering-unification/13-CONTEXT.md
@.planning/phases/12-leaf-utilities/12-01-SUMMARY.md
@swift/Ruler/Sources/Utilities/DesignTokens.swift
@swift/Ruler/Sources/Rendering/CrosshairView.swift
@swift/Ruler/Sources/AlignmentGuides/GuideLine.swift
@swift/Ruler/Sources/Rendering/SelectionOverlay.swift
@swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PillRenderer.swift with pill factory and shared rendering code</name>
  <files>swift/Ruler/Sources/Rendering/PillRenderer.swift</files>
  <action>
Create `PillRenderer.swift` in `Rendering/` as a caseless enum (matching DesignTokens pattern). Import `AppKit`, `CoreText`, `QuartzCore`.

**Return types — one struct per pill variant:**

Each struct exposes its layers as stored properties so callers can update position/content. All layers are pre-configured with shadow, background color, text layer properties, and added to the parent layer.

```swift
struct DimensionPill {
    let wBgLayer: CAShapeLayer      // W section background
    let hBgLayer: CAShapeLayer      // H section background
    let wLabelLayer: CATextLayer    // "W" label
    let hLabelLayer: CATextLayer    // "H" label
    let wValueLayer: CATextLayer    // width value
    let hValueLayer: CATextLayer    // height value
    var allLayers: [CALayer] { [wBgLayer, hBgLayer, wLabelLayer, hLabelLayer, wValueLayer, hValueLayer] }
}

struct PositionPill {
    let bgLayer: CAShapeLayer
    let labelLayer: CATextLayer
    let valueLayer: CATextLayer
    var allLayers: [CALayer] { [bgLayer, labelLayer, valueLayer] }
}

struct SelectionPill {
    let bgLayer: CAShapeLayer
    let textLayer: CATextLayer
    var allLayers: [CALayer] { [bgLayer, textLayer] }
}
```

NOTE: These structs live inside the `PillRenderer` enum as nested types: `PillRenderer.DimensionPill`, etc.

**Factory methods (static on PillRenderer):**

Each factory accepts `parentLayer: CALayer, scale: CGFloat`, creates all layers, configures them fully (shadow, bg color, text layer properties, contentsScale), adds them to the parent layer, and returns the struct.

- `static func makeDimensionPill(parentLayer: CALayer, scale: CGFloat) -> DimensionPill`
  - Creates 2 CAShapeLayer backgrounds with `DesignTokens.Pill.backgroundColor` fill and standard pill shadow applied directly (shadowColor/offset/radius/opacity from DesignTokens.Shadow)
  - Creates 4 CATextLayer with: contentsScale, truncationMode=.none, isWrapped=false, alignmentMode=.left, allowsFontSubpixelQuantization=true
  - Adds all 6 layers to parentLayer in order: wBgLayer, hBgLayer, wLabelLayer, hLabelLayer, wValueLayer, hValueLayer
  - Match CrosshairView's setupLayers (lines 139-181) exactly

- `static func makePositionPill(parentLayer: CALayer, scale: CGFloat) -> PositionPill`
  - Creates 1 CAShapeLayer background with pill bg color + standard shadow
  - Creates 2 CATextLayer (label + value) with same text layer config
  - Adds all 3 layers to parentLayer
  - Match GuideLine's setupLayers (lines 67-98), specifically the pill layers (not the line layer)

- `static func makeSelectionPill(parentLayer: CALayer, scale: CGFloat) -> SelectionPill`
  - Creates 1 CAShapeLayer background with pill bg color + standard shadow
  - Creates 1 CATextLayer configured for center alignment (unlike others which are left-aligned): alignmentMode=.center
  - **Font/fontSize (CRITICAL — match existing behavior exactly):** Set `textLayer.font` to the NSFont from `makeDesignFont(size: 11)` AND set `textLayer.fontSize = 12`. This is intentional existing behavior from SelectionOverlay lines 86-87 — the fontSize=12 on a size-11 font overrides the display size while preserving the font's metrics. The executor MUST read SelectionOverlay lines 86-87 to verify before implementing.
  - Also set: foregroundColor=CGColor(gray: 1.0, alpha: 1.0), truncationMode=.none, contentsScale=scale
  - Adds layers to parentLayer
  - Layers start hidden (opacity=0), matching SelectionOverlay lines 95-96

**Shared path generators (public static):**
- `static func squirclePath(rect: CGRect, radius: CGFloat) -> CGPath` — continuous-corner rounded rect, kappa=0.72. Radius clamped to `min(radius, min(rect.width, rect.height) / 2)` (defensive variant from SelectionOverlay). Exact path winding from GuideLine lines 357-397.
- `static func sectionPath(rect: CGRect, leftRadius: CGFloat, rightRadius: CGFloat) -> CGPath` — independent left/right radii. Exact copy of CrosshairView lines 385-428. Kappa=0.72.

**Shared text formatters (public static):**
- `static func labelText(_ label: String) -> NSAttributedString` — uses internal font (size 12), foreground `NSColor(white: 1, alpha: 0.5)`, kern `DesignTokens.Pill.kerning`. No font parameter — the formatter enforces styling per user decision.
- `static func valueText(_ value: Int) -> NSAttributedString` — zero-padded 4-digit, dim leading zeros `NSColor(white: 1, alpha: 0.2)`, bright digits `NSColor.white`, kern `DesignTokens.Pill.kerning`. Uses internal font (size 12).
- Note: SelectionOverlay uses size 11 and different formatting (no zero padding, "W x H" composite). It does NOT use these shared formatters — its text is SelectionOverlay-specific. The user decision "SelectionOverlay uses the same formatters" refers to the same font factory approach, not the same output format.

**Private internals:**
- `private static let font12 = makeDesignFont(size: 12)` — cached font for labelText/valueText
- `private static func makeDesignFont(size: CGFloat) -> NSFont` — SF Pro Semibold with 8 OpenType tags (ss01, ss02, cv01, cv02, cv08, cv12, lnum, tnum). Exact implementation from CrosshairView lines 56-67 but parameterized by size.
- `private static func applyShadow(to layer: CAShapeLayer)` — applies DesignTokens.Shadow (color, offset, radius, opacity). Called by every factory method.
- `private static func configureTextLayer(_ layer: CATextLayer, scale: CGFloat)` — sets contentsScale, truncationMode, isWrapped, alignmentMode, allowsFontSubpixelQuantization.

**Public shadow preset for ColorCircleIndicator:**
- `static func applyCircleShadow(to layer: CALayer)` — applies: shadowColor=CGColor(gray:0,alpha:1.0), shadowOffset=(0,-1), shadowRadius=3, shadowOpacity=0.25. This stays public because ColorCircleIndicator's shadow is visually distinct from pill shadow. Named preset per user decision.

**Also expose `makeDesignFont` as public** so SelectionOverlay can create its size-11 font variant:
- `static func makeDesignFont(size: CGFloat) -> NSFont` — make this public, not private. SelectionOverlay needs `PillRenderer.makeDesignFont(size: 11)` since it uses a different font size.
  </action>
  <verify>
Run `cd /Users/haythem/Developer/design-ruler/swift/Ruler && swift build 2>&1 | tail -5` — must compile with zero errors.
Verify file exists: `ls swift/Ruler/Sources/Rendering/PillRenderer.swift`
  </verify>
  <done>
PillRenderer.swift exists with 3 factory methods (makeDimensionPill, makePositionPill, makeSelectionPill) returning configured layer hierarchy structs, plus public squirclePath, sectionPath, labelText, valueText, applyCircleShadow, and makeDesignFont. Shadow is applied automatically inside factories. Project compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify PillRenderer output matches existing implementations</name>
  <files>swift/Ruler/Sources/Rendering/PillRenderer.swift</files>
  <action>
Review the created PillRenderer.swift to ensure exact fidelity with source implementations:

1. **DimensionPill factory**: Confirm it creates the same layer setup as CrosshairView.setupLayers lines 139-181. Specifically: 2 bg layers with fill=DesignTokens.Pill.backgroundColor + shadow, 4 text layers with correct config, all added to parent in correct order.

2. **PositionPill factory**: Confirm it matches GuideLine.setupLayers lines 67-98 (pill portion only). Bg has fill+shadow, 2 text layers configured identically.

3. **SelectionPill factory**: Confirm text layer uses .center alignment, sets textLayer.font to makeDesignFont(size: 11), and sets textLayer.fontSize to 12 (matching SelectionOverlay lines 86-87 exactly). Also foregroundColor=CGColor(gray: 1.0, alpha: 1.0), truncationMode=.none. Bg has shadow. Both layers start at opacity 0.

4. **Font**: Confirm the 8 OpenType tags match: ["ss01", "ss02", "cv01", "cv02", "cv08", "cv12", "lnum", "tnum"]. Weight is .semibold. CTFontCreateCopyWithAttributes passes nil matrix and correct size.

5. **squirclePath**: Confirm kappa=0.72, radius clamped to `min(radius, min(rect.width, rect.height) / 2)`. Path winding matches existing.

6. **sectionPath**: Confirm left/right radii clamped independently to `rect.height / 2`. Path winding matches CrosshairView exactly.

7. **labelText**: foregroundColor is NSColor(white: 1, alpha: 0.5). Kern is DesignTokens.Pill.kerning.

8. **valueText**: Zero-padded "%04d", min(value, 9999). Dim zeros NSColor(white: 1, alpha: 0.2), bright NSColor.white.

9. **applyCircleShadow**: Values match ColorCircleIndicator lines 226-230.

If any mismatch, fix it. Run `swift build` again.
  </action>
  <verify>
Run `cd /Users/haythem/Developer/design-ruler/swift/Ruler && swift build 2>&1 | tail -5` — zero errors.
  </verify>
  <done>
PillRenderer factories and helpers verified to match existing implementations exactly. All layer configurations, font tags, path geometry, text formatting, and shadow values are faithful to the originals.
  </done>
</task>

</tasks>

<verification>
1. `swift build` succeeds in `swift/Ruler/`
2. PillRenderer.swift contains 3 factory methods returning layer hierarchy structs (makeDimensionPill, makePositionPill, makeSelectionPill)
3. PillRenderer.swift contains public squirclePath, sectionPath, labelText, valueText, makeDesignFont, applyCircleShadow
4. Shadow is applied automatically inside factory methods (not as separate helper calls)
5. No existing files were modified (Plan 02 handles consumer wiring)
</verification>

<success_criteria>
PillRenderer.swift compiles and contains 3 pill factories (makeDimensionPill, makePositionPill, makeSelectionPill) each returning a struct with pre-configured layer hierarchies. Shadow, background, and text layer setup happen inside the factory. Shared path generators and text formatters are available. SelectionPill factory sets font to size-11 NSFont with fontSize=12, matching existing SelectionOverlay behavior exactly. Ready for Plan 02 to wire consumers.
</success_criteria>

<output>
After completion, create `.planning/phases/13-rendering-unification/13-01-SUMMARY.md`
</output>
