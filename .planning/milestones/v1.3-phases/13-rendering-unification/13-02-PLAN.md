---
phase: 13-rendering-unification
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - swift/Ruler/Sources/Rendering/CrosshairView.swift
  - swift/Ruler/Sources/AlignmentGuides/GuideLine.swift
  - swift/Ruler/Sources/Rendering/SelectionOverlay.swift
  - swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift
autonomous: true

must_haves:
  truths:
    - "CrosshairView uses PillRenderer.makeDimensionPill() to create its pill layers — no local font, shadow, text layer boilerplate, or path geometry remains"
    - "GuideLine uses PillRenderer.makePositionPill() to create its pill layers — no local font, shadow, text layer boilerplate, or path geometry remains"
    - "SelectionOverlay uses PillRenderer.makeSelectionPill() to create its pill layers and PillRenderer.makeDesignFont(size:) for its font — no local font setup, shadow setup, or squircle path remains"
    - "ColorCircleIndicator uses PillRenderer.applyCircleShadow() — no local shadow literals remain"
    - "CrosshairView and GuideLine call PillRenderer.labelText and PillRenderer.valueText — no local duplicated text formatters remain"
    - "CrosshairView calls PillRenderer.sectionPath and GuideLine/SelectionOverlay call PillRenderer.squirclePath — no per-file path geometry code remains"
    - "Both commands build and render identically to before"
  artifacts:
    - path: "swift/Ruler/Sources/Rendering/CrosshairView.swift"
      provides: "Crosshair view using PillRenderer.makeDimensionPill() factory for pill creation"
      contains: "PillRenderer.makeDimensionPill"
    - path: "swift/Ruler/Sources/AlignmentGuides/GuideLine.swift"
      provides: "Guide line using PillRenderer.makePositionPill() factory for pill creation"
      contains: "PillRenderer.makePositionPill"
    - path: "swift/Ruler/Sources/Rendering/SelectionOverlay.swift"
      provides: "Selection overlay using PillRenderer.makeSelectionPill() factory and PillRenderer.makeDesignFont"
      contains: "PillRenderer.makeSelectionPill"
    - path: "swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift"
      provides: "Color circle indicator using PillRenderer.applyCircleShadow"
      contains: "PillRenderer.applyCircleShadow"
  key_links:
    - from: "swift/Ruler/Sources/Rendering/CrosshairView.swift"
      to: "swift/Ruler/Sources/Rendering/PillRenderer.swift"
      via: "Uses makeDimensionPill factory, sectionPath, labelText, valueText"
      pattern: "PillRenderer\\."
    - from: "swift/Ruler/Sources/AlignmentGuides/GuideLine.swift"
      to: "swift/Ruler/Sources/Rendering/PillRenderer.swift"
      via: "Uses makePositionPill factory, squirclePath, labelText, valueText"
      pattern: "PillRenderer\\."
    - from: "swift/Ruler/Sources/Rendering/SelectionOverlay.swift"
      to: "swift/Ruler/Sources/Rendering/PillRenderer.swift"
      via: "Uses makeSelectionPill factory, squirclePath, makeDesignFont"
      pattern: "PillRenderer\\."
    - from: "swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift"
      to: "swift/Ruler/Sources/Rendering/PillRenderer.swift"
      via: "Uses applyCircleShadow for shadow preset"
      pattern: "PillRenderer\\.applyCircleShadow"
---

<objective>
Refactor CrosshairView, GuideLine, SelectionOverlay, and ColorCircleIndicator to use PillRenderer's pill factories for layer creation and shared helpers for paths/text, eliminating all duplicated rendering code.

Purpose: Complete the rendering unification. Per user decision, consumers call the factory to get complete pill hierarchies and only set position and text content on updates.
Output: Four files refactored with zero local duplication of pill rendering logic.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-rendering-unification/13-CONTEXT.md
@.planning/phases/13-rendering-unification/13-01-SUMMARY.md
@swift/Ruler/Sources/Rendering/PillRenderer.swift
@swift/Ruler/Sources/Rendering/CrosshairView.swift
@swift/Ruler/Sources/AlignmentGuides/GuideLine.swift
@swift/Ruler/Sources/Rendering/SelectionOverlay.swift
@swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor CrosshairView and GuideLine to use pill factories</name>
  <files>
    swift/Ruler/Sources/Rendering/CrosshairView.swift
    swift/Ruler/Sources/AlignmentGuides/GuideLine.swift
  </files>
  <action>
**CrosshairView.swift — use DimensionPill factory:**

1. **Replace stored pill layer properties** with a single `PillRenderer.DimensionPill` struct:
   - Remove the 6 individual `let` declarations for wBgLayer, hBgLayer, wLabelLayer, hLabelLayer, wValueLayer, hValueLayer (lines 19-28)
   - Add a single stored property: `private var pill: PillRenderer.DimensionPill!`
   - The `!` is needed because the factory requires a parent layer, so initialization happens in `setupLayers()` not at declaration

2. **Replace setupLayers() pill setup** with factory call:
   - Remove the pill bg setup loop (lines 162-170): the for-loop configuring wBgLayer/hBgLayer with fillColor, shadowColor/offset/radius/opacity
   - Remove the text layer setup loop (lines 173-180): the for-loop configuring wLabelLayer/hLabelLayer/wValueLayer/hValueLayer
   - Replace with: `pill = PillRenderer.makeDimensionPill(parentLayer: root, scale: scale)`
   - Keep the crosshair line and foot layer setup unchanged (lines 143-159) — those are not pills

3. **Update all references to pill layers** throughout the file to use `pill.wBgLayer`, `pill.hBgLayer`, `pill.wLabelLayer`, etc:
   - `pillLayers` computed property (line 262-264): return `pill.allLayers`
   - `layoutPill` method: replace `self.wBgLayer` with `pill.wBgLayer`, `self.hBgLayer` with `pill.hBgLayer`, etc. (about 12 references in lines 296-326)
   - `viewDidMoveToWindow` method: update the contentsScale loop for text layers (lines 134-136) to use `pill.wLabelLayer` etc., or better: iterate `pill.allLayers`

4. **Remove the font static let** (lines 56-67). Replace with: `private static let font = PillRenderer.makeDesignFont(size: 12)`

5. **Remove the sectionPath method** (lines 385-428). Replace the 2 call sites in layoutPill with `PillRenderer.sectionPath(rect:leftRadius:rightRadius:)`.

6. **Remove labelText and valueText methods** (lines 337-363). Replace the 4 call sites in layoutPill with `PillRenderer.labelText("W")`, `PillRenderer.labelText("H")`, `PillRenderer.valueText(w)`, `PillRenderer.valueText(h)`.

7. **Remove `import CoreText`** — no longer needed directly.

**GuideLine.swift — use PositionPill factory:**

1. **Replace stored pill layer properties** with a `PillRenderer.PositionPill` struct:
   - Remove the 3 individual `let` declarations for pillBgLayer, pillLabelLayer, pillValueLayer (lines 25-27)
   - Add: `private var pill: PillRenderer.PositionPill!`

2. **Replace setupLayers() pill setup** with factory call:
   - Remove pill bg setup (lines 81-88): fillColor, shadow config, contentsScale, addSublayer
   - Remove text layer setup loop (lines 91-98): contentsScale, truncation, wrap, alignment, subpixel, addSublayer
   - Replace with: `pill = PillRenderer.makePositionPill(parentLayer: parent, scale: scale)`
   - Keep the line layer setup unchanged (lines 71-78) — that's not a pill
   - Keep the initial opacity setup (lines 100-111) but update to use `pill.bgLayer`, `pill.labelLayer`, `pill.valueLayer`

3. **Update all references to pill layers** to use `pill.bgLayer`, `pill.labelLayer`, `pill.valueLayer`:
   - `layoutPill` method: ~15 references (pillBgLayer → pill.bgLayer, pillLabelLayer → pill.labelLayer, pillValueLayer → pill.valueLayer)
   - `setOpacity` method: pill layer references
   - `hidePill` method: pill layer references
   - `removeLayers` method: pill layer references
   - `setHovered` method: no pill references (only lineLayer)

4. **Remove the font static let** (lines 43-54). Replace with: `private static let font = PillRenderer.makeDesignFont(size: 12)`

5. **Remove the squirclePath method** (lines 357-397). Replace the 1 call site in layoutPill (line 208) with `PillRenderer.squirclePath(rect:radius:)`.

6. **Remove labelText and valueText methods** (lines 326-353). Replace call sites in layoutPill with `PillRenderer.labelText(label)` and `PillRenderer.valueText(value)`.

7. **Remove `import CoreText`** — no longer needed directly.

8. **Keep "Remove" state as position pill content swap**: In `layoutPill`, when `isInRemoveMode` is true, the pill currently creates a "Remove" attributed string inline (lines 156-160) and swaps the position pill's background color to red. Keep this inline — GuideLine reuses the position pill layers for remove mode with content/color swap. There is no separate RemovePill factory because restructuring the layer lifecycle would be a behavioral change, not a refactoring. The key duplication (font, shadow, text layers, paths) is still eliminated.
  </action>
  <verify>
Run `cd /Users/haythem/Developer/design-ruler/swift/Ruler && swift build 2>&1 | tail -5` — zero errors.
Grep for deleted patterns: `grep -n "kCTFont\|CTFontDescriptor\|CTFontCreate" swift/Ruler/Sources/Rendering/CrosshairView.swift swift/Ruler/Sources/AlignmentGuides/GuideLine.swift` — must return nothing.
Grep for remaining local path methods: `grep -n "private func squirclePath\|private func sectionPath" swift/Ruler/Sources/Rendering/CrosshairView.swift swift/Ruler/Sources/AlignmentGuides/GuideLine.swift` — must return nothing.
Grep for remaining local text formatters: `grep -n "private func labelText\|private func valueText" swift/Ruler/Sources/Rendering/CrosshairView.swift swift/Ruler/Sources/AlignmentGuides/GuideLine.swift` — must return nothing.
Confirm factory usage: `grep -c "PillRenderer\\.make" swift/Ruler/Sources/Rendering/CrosshairView.swift swift/Ruler/Sources/AlignmentGuides/GuideLine.swift` — both must return >= 1.
  </verify>
  <done>
CrosshairView uses PillRenderer.makeDimensionPill() for pill creation and PillRenderer for paths/text. GuideLine uses PillRenderer.makePositionPill() for pill creation and PillRenderer for paths/text. No local font factories, path generators, text formatters, shadow setup, or text layer boilerplate remain. Both files compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor SelectionOverlay and ColorCircleIndicator to use pill factory and shadow preset</name>
  <files>
    swift/Ruler/Sources/Rendering/SelectionOverlay.swift
    swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift
  </files>
  <action>
**SelectionOverlay.swift — use SelectionPill factory:**

1. **Replace stored pill layer properties** with a `PillRenderer.SelectionPill` struct:
   - Remove the 2 individual `let` declarations for pillBgLayer and pillTextLayer (lines 19-20)
   - Add: `private var pill: PillRenderer.SelectionPill!`

2. **Replace setupLayers() pill setup** with factory call:
   - Remove pill bg setup (lines 77-83): fillColor, shadow config, addSublayer
   - Remove pill text setup (lines 86-92): font, fontSize, foregroundColor, alignment, truncation, contentsScale, addSublayer
   - Remove initial opacity setup (lines 95-96): factory handles this (layers start at opacity 0)
   - Replace with: `pill = PillRenderer.makeSelectionPill(parentLayer: parentLayer, scale: scale)`
   - Keep rectLayer and fillLayer setup unchanged (lines 64-74) — those are not pills

3. **Update all references to pill layers** to use `pill.bgLayer` and `pill.textLayer`:
   - `animateSnap` method: pillBgLayer → pill.bgLayer, pillTextLayer → pill.textLayer
   - `setHovered` method: pillBgLayer → pill.bgLayer
   - `shakeAndRemove` method: pillBgLayer → pill.bgLayer, pillTextLayer → pill.textLayer
   - `remove` method: pillBgLayer → pill.bgLayer, pillTextLayer → pill.textLayer
   - `layoutPill` method: pillBgLayer → pill.bgLayer, pillTextLayer → pill.textLayer
   - `setDimensionsText` method: pillTextLayer → pill.textLayer
   - `setClearText` method: pillTextLayer → pill.textLayer

4. **Replace font static let** (lines 42-53) with: `private static let font = PillRenderer.makeDesignFont(size: 11)`

5. **Remove squirclePath method** (lines 303-342) and the stored `k` constant (line 39). Replace the 1 call site in layoutPill (line 293) with `PillRenderer.squirclePath(rect:radius:)`.

6. **Remove `import CoreText`** — no longer needed.

7. **Keep SelectionOverlay's text formatting as-is**: `setDimensionsText` and `setClearText` are SelectionOverlay-specific (different format: "W x H" composite, no zero padding, "Clear" text for hover). They stay local. Only the font they use changes to the PillRenderer-provided one.

**ColorCircleIndicator.swift — use shadow preset:**

1. **Replace shadow setup** in `createCircleLayers()`:
   - Remove lines 226-229 (the 4 shadow property assignments on `wrapper`):
     ```
     wrapper.shadowColor = CGColor(gray: 0, alpha: 1.0)
     wrapper.shadowOffset = CGSize(width: 0, height: -1)
     wrapper.shadowRadius = 3
     wrapper.shadowOpacity = 0.25
     ```
   - Replace with: `PillRenderer.applyCircleShadow(to: wrapper)`
   - Keep line 230 (`wrapper.shadowPath = ...`) — that's instance-specific

That's the only change for ColorCircleIndicator — it shares only the shadow preset.
  </action>
  <verify>
Run `cd /Users/haythem/Developer/design-ruler/swift/Ruler && swift build 2>&1 | tail -5` — zero errors.
Grep for deleted patterns: `grep -n "kCTFont\|CTFontDescriptor\|CTFontCreate" swift/Ruler/Sources/Rendering/SelectionOverlay.swift` — must return nothing.
Grep for remaining local paths: `grep -n "private func squirclePath\|private let k: CGFloat = 0.72" swift/Ruler/Sources/Rendering/SelectionOverlay.swift` — must return nothing.
Grep for remaining shadow literals in ColorCircleIndicator: `grep -n "shadowColor = CGColor(gray: 0\|shadowOffset = CGSize\|shadowRadius = 3\|shadowOpacity = 0.25" swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift` — must return nothing.
Confirm factory usage: `grep -c "PillRenderer\\.make\|PillRenderer\\.apply\|PillRenderer\\.squircle" swift/Ruler/Sources/Rendering/SelectionOverlay.swift swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift` — both must return >= 1.
  </verify>
  <done>
SelectionOverlay uses PillRenderer.makeSelectionPill() for pill creation, PillRenderer.squirclePath for paths, and PillRenderer.makeDesignFont for its font. ColorCircleIndicator uses PillRenderer.applyCircleShadow for shadow. No local duplicated font, path, or shadow setup remains. All files compile.
  </done>
</task>

</tasks>

<verification>
1. `swift build` succeeds in `swift/Ruler/`
2. No OpenType feature array code remains in CrosshairView, GuideLine, or SelectionOverlay — only in PillRenderer
3. No `squirclePath` or `sectionPath` private methods remain in consumer files
4. No `labelText` or `valueText` private methods remain in CrosshairView or GuideLine
5. No repeated shadow configuration (4 lines each) remains — all use PillRenderer factories or applyCircleShadow
6. `import CoreText` removed from CrosshairView, GuideLine, and SelectionOverlay (only in PillRenderer)
7. All 4 consumers reference PillRenderer via factory methods or shared helpers
8. `ray build` may optionally be tested for final Raycast build validation
</verification>

<success_criteria>
All four consumer files use PillRenderer factories for pill layer creation. CrosshairView uses makeDimensionPill, GuideLine uses makePositionPill, SelectionOverlay uses makeSelectionPill. Shadow, background, and text layers are created by factories. Consumers only set position and content. Zero duplicated font factories, path generators, text formatters, or shadow configurations remain outside PillRenderer.swift. Both commands build and render identically to before.
</success_criteria>

<output>
After completion, create `.planning/phases/13-rendering-unification/13-02-SUMMARY.md`
</output>
