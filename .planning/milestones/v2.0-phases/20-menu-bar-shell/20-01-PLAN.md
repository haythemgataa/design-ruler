---
phase: 20-menu-bar-shell
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - swift/DesignRuler/Sources/DesignRulerCore/Utilities/OverlayCoordinator.swift
  - App/Sources/AppDelegate.swift
  - App/Sources/main.swift
  - App/Sources/MenuBarController.swift
  - App/Design Ruler.xcodeproj/project.pbxproj
autonomous: true

must_haves:
  truths:
    - "App shows an NSStatusItem icon in the menu bar immediately on launch"
    - "Clicking the menu bar icon reveals a dropdown with Measure, Alignment Guides, Settings (disabled), and Quit items"
    - "Clicking Measure launches the Measure overlay session"
    - "Clicking Alignment Guides launches the Alignment Guides overlay session"
    - "Menu bar icon changes to filled variant when overlay is active and reverts on ESC"
    - "Quit Design Ruler menu item terminates the app immediately"
    - "No debug logging (drLog, logToFile) remains in production code"
    - "No Phase 19 test scaffolding remains (asyncAfter, applicationDidBecomeActive re-invoke, terminateCancel)"
  artifacts:
    - path: "App/Sources/MenuBarController.swift"
      provides: "NSStatusItem + NSMenu lifecycle, icon state management"
    - path: "App/Sources/AppDelegate.swift"
      provides: "MenuBarController creation, coordinator callback wiring"
    - path: "swift/DesignRuler/Sources/DesignRulerCore/Utilities/OverlayCoordinator.swift"
      provides: "onSessionEnd callback property, drLog removed"
    - path: "App/Sources/main.swift"
      provides: "Clean app entry point with no debug logging"
    - path: "App/Design Ruler.xcodeproj/project.pbxproj"
      provides: "MenuBarController.swift added to Xcode project"
  key_links:
    - from: "App/Sources/MenuBarController.swift"
      to: "OverlayCoordinator.anySessionActive"
      via: "guard check before setActive(true) and run()"
      pattern: "OverlayCoordinator\\.anySessionActive"
    - from: "App/Sources/AppDelegate.swift"
      to: "App/Sources/MenuBarController.swift"
      via: "strong property + callback wiring"
      pattern: "menuBarController"
    - from: "App/Sources/AppDelegate.swift"
      to: "OverlayCoordinator.onSessionEnd"
      via: "closure setting setActive(false)"
      pattern: "onSessionEnd"
    - from: "OverlayCoordinator.run() permission-abort"
      to: "onSessionEnd"
      via: "fires callback on early return so menu bar icon reverts"
      pattern: "onSessionEnd\\?\\(\\)"
---

<objective>
Add NSStatusItem menu bar icon with dropdown menu launching both overlay commands, clean up Phase 19 test scaffolding and debug logging, and wire onSessionEnd callback for icon state management.

Purpose: Users can launch Measure and Alignment Guides from the menu bar. The app survives ESC (overlay ends, process stays alive). This is the primary interaction surface for the standalone app.

Output: Working menu bar app with icon, dropdown menu, overlay command launching, and active-state icon feedback.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-menu-bar-shell/20-RESEARCH.md
@swift/DesignRuler/Sources/DesignRulerCore/Utilities/OverlayCoordinator.swift
@App/Sources/AppDelegate.swift
@App/Design Ruler.xcodeproj/project.pbxproj
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add onSessionEnd hook to OverlayCoordinator and remove debug logging</name>
  <files>swift/DesignRuler/Sources/DesignRulerCore/Utilities/OverlayCoordinator.swift</files>
  <action>
Two changes to OverlayCoordinator.swift:

**1. Remove drLog entirely:**
- Delete the `private func drLog(_ msg: String)` function (lines 30-35, the block starting with `// TEMP: Phase 19 debug logging`)
- Remove ALL call sites of `drLog(...)` throughout the file. These appear in:
  - `run()` method: `drLog("run() rejected: isSessionActive")`, `drLog("run() rejected: anySessionActive")`, `drLog("hasScreenRecordingPermission: ...")`, `drLog("run() aborted: no screen recording permission")`, `drLog("showing \(windows.count) windows")`, `drLog("window frame=...")`, `drLog("makeKey done, calling showInitialState")`, `drLog("showInitialState done")`, `drLog("activate done, isActive=...")`
- Keep the guard logic intact — only remove the drLog calls, not the guard statements themselves. For example:
  ```swift
  // BEFORE:
  guard !isSessionActive else { drLog("run() rejected: isSessionActive"); return }
  // AFTER:
  guard !isSessionActive else { return }
  ```

**2. Add onSessionEnd callback:**
- Add `public var onSessionEnd: (() -> Void)?` as a stored property on OverlayCoordinator, near the other public properties (after `cursorWindow` or similar)
- Add `onSessionEnd?()` as the LAST line of `handleExit()`, after the standalone comment. This fires for ALL exit paths: ESC, inactivity timer, SIGTERM. It must be the absolute last thing before the method returns.
- **CRITICAL:** Also add `onSessionEnd?()` in the standalone permission-denied early-abort path in `run()`. Currently (lines 79-83) the block resets `isSessionActive` and `anySessionActive` but never fires `onSessionEnd`. Since `MenuBarController.launchMeasure/launchAlignmentGuides` calls `setActive(true)` BEFORE `run()`, the icon will be stuck filled if `run()` aborts early without notifying. The fix:
  ```swift
  // In standalone mode, don't proceed — fullscreen windows would block the permission dialog
  if runMode == .standalone {
      isSessionActive = false
      OverlayCoordinator.anySessionActive = false
      onSessionEnd?()   // <-- ADD THIS LINE: reverts menu bar icon
      return
  }
  ```

Do NOT change any other logic in the file. The `run()` guards, window lifecycle, standalone mode behavior, etc. must remain exactly as they are.
  </action>
  <verify>
Build the Swift package to confirm no compilation errors:
```bash
cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/swift/DesignRuler && swift build 2>&1 | tail -5
```
Verify no drLog references remain:
```bash
grep -n "drLog" swift/DesignRuler/Sources/DesignRulerCore/Utilities/OverlayCoordinator.swift
```
Verify onSessionEnd is present:
```bash
grep -n "onSessionEnd" swift/DesignRuler/Sources/DesignRulerCore/Utilities/OverlayCoordinator.swift
```
  </verify>
  <done>OverlayCoordinator has zero drLog calls, zero debug logging functions, and a public onSessionEnd callback that fires at the end of handleExit()</done>
</task>

<task type="auto">
  <name>Task 2: Create MenuBarController, rewrite AppDelegate, and update Xcode project</name>
  <files>
    App/Sources/MenuBarController.swift
    App/Sources/AppDelegate.swift
    App/Sources/main.swift
    App/Design Ruler.xcodeproj/project.pbxproj
  </files>
  <action>
**0. Strip debug logging from `App/Sources/main.swift`:**
- Remove lines 6-7 (the `logPath` declaration and `.write(toFile:)` call) — these are Phase 19 debug logging that write to `~/Desktop/design-ruler-launch.log`
- Keep the rest of main.swift intact: the `import AppKit`, creation of `NSApplication.shared`, `AppDelegate()`, and `app.run()`
- The resulting file should be:
  ```swift
  import AppKit

  let app = NSApplication.shared
  let delegate = AppDelegate()
  app.delegate = delegate
  app.run()
  ```

**1. Create `App/Sources/MenuBarController.swift`** (new file):

```swift
import AppKit
import DesignRulerCore

final class MenuBarController {
    // CRITICAL: must be stored property — ARC releases local NSStatusItem immediately
    private let statusItem: NSStatusItem

    // Callbacks wired by AppDelegate (keeps this class decoupled from coordinators)
    var onMeasure: (() -> Void)?
    var onAlignmentGuides: (() -> Void)?

    init() {
        statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.squareLength)
        setupButton()
        setupMenu()
    }

    private func setupButton() {
        guard let button = statusItem.button else { return }
        let image = NSImage(systemSymbolName: "ruler", accessibilityDescription: "Design Ruler")
        image?.isTemplate = true
        button.image = image
        button.toolTip = "Design Ruler"
    }

    /// Update the menu bar icon to reflect active/idle session state.
    /// Safe to call from any thread — dispatches to main.
    func setActive(_ active: Bool) {
        DispatchQueue.main.async { [weak self] in
            guard let button = self?.statusItem.button else { return }
            let symbolName = active ? "ruler.fill" : "ruler"
            let image = NSImage(systemSymbolName: symbolName, accessibilityDescription: "Design Ruler")
            image?.isTemplate = true
            button.image = image
        }
    }

    private func setupMenu() {
        let menu = NSMenu()

        let measureItem = menu.addItem(
            withTitle: "Measure",
            action: #selector(launchMeasure),
            keyEquivalent: ""
        )
        measureItem.target = self

        let guidesItem = menu.addItem(
            withTitle: "Alignment Guides",
            action: #selector(launchAlignmentGuides),
            keyEquivalent: ""
        )
        guidesItem.target = self

        menu.addItem(NSMenuItem.separator())

        let settingsItem = menu.addItem(
            withTitle: "Settings\u{2026}",
            action: nil,
            keyEquivalent: ""
        )
        settingsItem.isEnabled = false

        menu.addItem(NSMenuItem.separator())

        let quitItem = menu.addItem(
            withTitle: "Quit Design Ruler",
            action: #selector(quitApp),
            keyEquivalent: ""
        )
        quitItem.target = self

        statusItem.menu = menu
    }

    @objc private func launchMeasure() {
        guard !OverlayCoordinator.anySessionActive else { return }
        setActive(true)
        onMeasure?()
    }

    @objc private func launchAlignmentGuides() {
        guard !OverlayCoordinator.anySessionActive else { return }
        setActive(true)
        onAlignmentGuides?()
    }

    @objc private func quitApp() {
        NSApp.terminate(nil)
    }
}
```

Key details:
- `statusItem` is a `let` stored property (ARC pitfall from research)
- `setActive(_:)` dispatches to main thread (coordinator callbacks may fire from non-main)
- `launchMeasure`/`launchAlignmentGuides` guard on `!OverlayCoordinator.anySessionActive` BEFORE `setActive(true)` — prevents stuck active icon on rejected sessions (Pitfall 6 from research)
- Callbacks (`onMeasure`, `onAlignmentGuides`) wired by AppDelegate — keeps MenuBarController decoupled
- Settings item: `action: nil` + `isEnabled = false` (grayed out, wired in Phase 21)
- "Settings..." uses Unicode ellipsis character `\u{2026}` for the proper macOS convention
- No keyboard shortcut hints (`keyEquivalent: ""`) — added in Phase 22

**2. Rewrite `App/Sources/AppDelegate.swift`** — replace entire contents:

```swift
import AppKit
import DesignRulerCore

class AppDelegate: NSObject, NSApplicationDelegate {
    private var menuBarController: MenuBarController!

    func applicationDidFinishLaunching(_ notification: Notification) {
        NSApp.setActivationPolicy(.accessory)

        // Prevent macOS from auto-terminating agent app when no windows are open
        ProcessInfo.processInfo.disableAutomaticTermination("standalone menu bar app")

        // Configure coordinators for standalone mode (event loop already running)
        MeasureCoordinator.shared.runMode = .standalone
        AlignmentGuidesCoordinator.shared.runMode = .standalone

        // Create menu bar and wire overlay launch callbacks
        menuBarController = MenuBarController()
        menuBarController.onMeasure = {
            MeasureCoordinator.shared.run(hideHintBar: false, corrections: "smart")
        }
        menuBarController.onAlignmentGuides = {
            AlignmentGuidesCoordinator.shared.run(hideHintBar: false)
        }

        // Wire session-end callbacks to revert menu bar icon to idle state
        MeasureCoordinator.shared.onSessionEnd = { [weak self] in
            self?.menuBarController.setActive(false)
        }
        AlignmentGuidesCoordinator.shared.onSessionEnd = { [weak self] in
            self?.menuBarController.setActive(false)
        }
    }

    func applicationShouldTerminateAfterLastWindowClosed(_ sender: NSApplication) -> Bool {
        return false
    }
}
```

Removed from Phase 19:
- `logToFile` function and ALL calls
- `DispatchQueue.main.asyncAfter` test invocation (TEMP: Phase 19 test)
- `applicationDidBecomeActive` re-invocation (TEMP: Phase 19 test)
- `applicationShouldTerminate → .terminateCancel` (blocked Quit menu item)
- `applicationWillTerminate` log stub

Kept:
- `NSApp.setActivationPolicy(.accessory)` — required for no Dock icon
- `ProcessInfo.processInfo.disableAutomaticTermination` — prevents macOS agent termination
- RunMode `.standalone` configuration for both coordinators
- `applicationShouldTerminateAfterLastWindowClosed → false` — menu bar app must survive window closure

**3. Update `App/Design Ruler.xcodeproj/project.pbxproj`** — add MenuBarController.swift in 3 places:

Use 24-character hex UUIDs that don't conflict with existing IDs. Use these specific IDs:
- PBXFileReference: `D4A7B2C1E8F30659A2B41E73` for `MenuBarController.swift`
- PBXBuildFile: `F1E289D3C7A64B180E953FA6` for `MenuBarController.swift in Sources`

Add to **PBXBuildFile section** (after the existing entries, before the End comment):
```
		F1E289D3C7A64B180E953FA6 /* MenuBarController.swift in Sources */ = {isa = PBXBuildFile; fileRef = D4A7B2C1E8F30659A2B41E73 /* MenuBarController.swift */; };
```

Add to **PBXFileReference section** (after existing entries, before the End comment):
```
		D4A7B2C1E8F30659A2B41E73 /* MenuBarController.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = MenuBarController.swift; sourceTree = "<group>"; };
```

Add to **PBXGroup Sources** (`A91DD6835439210DEA39A9ED`) — add `D4A7B2C1E8F30659A2B41E73` to children list (after AppDelegate.swift, before Info.plist for alphabetical order):
```
				D4A7B2C1E8F30659A2B41E73 /* MenuBarController.swift */,
```

Add to **PBXSourcesBuildPhase** (`A682E2A40E8DB529D122EB58`) — add to files list:
```
				F1E289D3C7A64B180E953FA6 /* MenuBarController.swift in Sources */,
```
  </action>
  <verify>
Build the Xcode project:
```bash
cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build 2>&1 | tail -10
```
Verify no debug logging remains anywhere in App/Sources:
```bash
grep -rn "logToFile\|drLog\|fputs\|logPath\|write(toFile:" App/Sources/
```
Verify no Phase 19 test stubs remain:
```bash
grep -rn "TEMP.*Phase 19\|asyncAfter\|terminateCancel\|applicationDidBecomeActive" App/Sources/AppDelegate.swift
```
Verify MenuBarController.swift exists and contains required menu items:
```bash
grep -c "Measure\|Alignment Guides\|Settings\|Quit Design Ruler" App/Sources/MenuBarController.swift
```
  </verify>
  <done>MenuBarController.swift creates NSStatusItem with dropdown menu (Measure, Alignment Guides, Settings disabled, Quit), AppDelegate wires callbacks for overlay launching and icon state management, Xcode project builds successfully with the new file</done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full success criteria:

1. **Build succeeds:**
   ```bash
   cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build 2>&1 | grep -E "BUILD|error"
   ```

2. **No debug logging in production code:**
   ```bash
   grep -rn "drLog\|logToFile\|fputs\|logPath\|write(toFile:" swift/DesignRuler/Sources/ App/Sources/
   ```

3. **No Phase 19 test scaffolding:**
   ```bash
   grep -rn "TEMP.*Phase 19\|asyncAfter\|terminateCancel" App/Sources/
   ```

4. **onSessionEnd wired in both coordinators:**
   ```bash
   grep -n "onSessionEnd" App/Sources/AppDelegate.swift
   ```

5. **Raycast build unaffected** (swift build should still pass since OverlayCoordinator changes are additive):
   ```bash
   cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/swift/DesignRuler && swift build 2>&1 | tail -3
   ```
</verification>

<success_criteria>
- `xcodebuild` passes with zero errors
- `swift build` (SPM) passes with zero errors (Raycast path unaffected)
- Menu bar icon appears on launch (ruler SF Symbol, template mode)
- Dropdown has exactly: Measure, Alignment Guides, separator, Settings... (disabled), separator, Quit Design Ruler
- Clicking Measure/Alignment Guides launches overlay; ESC ends overlay but app survives
- Icon swaps to ruler.fill during session, reverts to ruler on ESC
- No drLog, logToFile, or fputs in any source file
- No Phase 19 test stubs (asyncAfter, applicationDidBecomeActive, terminateCancel) in AppDelegate
</success_criteria>

<output>
After completion, create `.planning/phases/20-menu-bar-shell/20-01-SUMMARY.md`
</output>
