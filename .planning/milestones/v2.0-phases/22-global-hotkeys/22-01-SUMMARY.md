---
phase: 22-global-hotkeys
plan: 01
subsystem: hotkeys
tags: [KeyboardShortcuts, Carbon, global-hotkeys, macOS, SPM]

# Dependency graph
requires:
  - phase: 20-menu-bar-shell
    provides: "MenuBarController with callback-based command launch and setActive icon state"
  - phase: 19-app-lifecycle-refactor
    provides: "OverlayCoordinator.handleExit(), anySessionActive guard, onSessionEnd callback"
provides:
  - "KeyboardShortcuts 2.4.0 SPM dependency in project.yml"
  - "HotkeyNames.swift defining .measure and .alignmentGuides shortcut identifiers"
  - "HotkeyController.swift with session-aware hotkey dispatch (toggle-off, cross-switch, normal launch)"
  - "AppDelegate wiring for hotkey registration and session tracking"
  - "Menu bar dropdown shortcut symbol display via NSMenuItem.setShortcut(for:)"
affects: [22-global-hotkeys plan 02 (Settings recorder UI), 23-raycast-detection]

# Tech tracking
tech-stack:
  added: [KeyboardShortcuts 2.4.0]
  patterns: [session-aware hotkey dispatch, MainActor.assumeIsolated for cross-isolation calls]

key-files:
  created:
    - App/Sources/HotkeyNames.swift
    - App/Sources/HotkeyController.swift
  modified:
    - App/project.yml
    - App/Sources/AppDelegate.swift
    - App/Sources/MenuBarController.swift
    - App/Design Ruler.xcodeproj/project.pbxproj

key-decisions:
  - "onKeyUp (not onKeyDown) for hotkey handlers to prevent key-repeat re-triggering"
  - "DispatchQueue.main.async between cross-command exit and relaunch for autorelease pool drainage"
  - "MainActor.assumeIsolated for setShortcut(for:) calls in MenuBarController (Swift 6 toolchain with 5.9 language mode)"
  - "No default shortcuts assigned -- both start unassigned per HOTK-03"

patterns-established:
  - "HotkeyController.sessionStarted/sessionEnded: AppDelegate notifies on every overlay launch/end regardless of trigger source"
  - "MainActor.assumeIsolated pattern for calling @MainActor library APIs from synchronous non-isolated contexts known to be on main thread"

# Metrics
duration: 4min 15s
completed: 2026-02-19
---

# Phase 22 Plan 01: Global Hotkey Infrastructure Summary

**KeyboardShortcuts 2.4.0 Carbon-based hotkey registration with session-aware toggle-off, cross-command switching, and menu bar shortcut display**

## Performance

- **Duration:** 4min 15s
- **Started:** 2026-02-19T10:00:41Z
- **Completed:** 2026-02-19T10:04:56Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- Added KeyboardShortcuts 2.4.0 as SPM dependency (project.yml only, not Package.swift)
- Created HotkeyController with three dispatch paths: toggle-off (same command), cross-switch (different command), normal launch (no active overlay)
- Wired hotkey handlers into AppDelegate with full session state tracking
- Added NSMenuItem.setShortcut(for:) for automatic shortcut display in menu bar dropdown

## Task Commits

Each task was committed atomically:

1. **Task 1: Add KeyboardShortcuts dependency, create HotkeyNames and HotkeyController** - `01f13b4` (feat)
2. **Task 2: Wire HotkeyController into AppDelegate and add menu item shortcut display** - `f704d6d` (feat)

## Files Created/Modified
- `App/Sources/HotkeyNames.swift` - KeyboardShortcuts.Name extensions for .measure and .alignmentGuides (no defaults)
- `App/Sources/HotkeyController.swift` - Session-aware hotkey dispatch with toggle-off, cross-switch, and normal launch
- `App/project.yml` - KeyboardShortcuts 2.4.0 SPM dependency added to packages and target dependencies
- `App/Sources/AppDelegate.swift` - HotkeyController creation, handler registration, session tracking wiring
- `App/Sources/MenuBarController.swift` - KeyboardShortcuts import, setShortcut(for:) on measure and guides menu items
- `App/Design Ruler.xcodeproj/project.pbxproj` - Regenerated by xcodegen with new dependency and source files

## Decisions Made
- Used `onKeyUp` instead of `onKeyDown` for hotkey handlers to prevent key-repeat re-triggering (per research recommendation)
- Used `DispatchQueue.main.async` between cross-command exit and relaunch to allow autorelease pool drainage (per research pitfall #3)
- Used `MainActor.assumeIsolated` for `setShortcut(for:)` calls because the library marks them `@MainActor` but MenuBarController.setupMenu() is synchronous non-isolated (known to be on main thread from applicationDidFinishLaunching)
- No default shortcuts -- both start unassigned per user constraint HOTK-03

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] MainActor isolation for setShortcut(for:) calls**
- **Found during:** Task 2 (MenuBarController shortcut display)
- **Issue:** KeyboardShortcuts library marks `NSMenuItem.setShortcut(for:)` as `@MainActor`. Swift 6 toolchain (even with 5.9 language mode) rejects calls from non-isolated synchronous context.
- **Fix:** Wrapped calls in `MainActor.assumeIsolated { }` block with comment explaining safety guarantee
- **Files modified:** App/Sources/MenuBarController.swift
- **Verification:** xcodebuild BUILD SUCCEEDED
- **Committed in:** f704d6d (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Minor Swift concurrency adaptation. No scope creep.

## Issues Encountered
None beyond the MainActor deviation documented above.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- HotkeyNames.swift provides shortcut name identifiers for Plan 02's Settings recorder UI
- HotkeyController is fully functional -- once Plan 02 adds recorder controls to SettingsView, users can assign shortcuts
- Menu bar dropdown will automatically show shortcut symbols once assigned
- Both xcodebuild and swift build pass

---
*Phase: 22-global-hotkeys*
*Completed: 2026-02-19*
