---
phase: 22-global-hotkeys
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - App/Sources/SettingsView.swift
  - App/Design Ruler.xcodeproj/project.pbxproj
autonomous: true

must_haves:
  truths:
    - "User can record a custom keyboard shortcut for Measure in the Settings Measure section"
    - "User can record a custom keyboard shortcut for Alignment Guides in the Settings Alignment Guides section"
    - "Recording the same shortcut for both commands shows 'Already assigned to [other]' and rejects"
    - "Shortcuts tab placeholder is removed from Settings"
    - "Recorder shows 'Record Shortcut' placeholder when unassigned"
    - "Clearing a shortcut via X button or Delete key removes the assignment"
  artifacts:
    - path: "App/Sources/SettingsView.swift"
      provides: "KeyboardShortcuts.Recorder controls in Measure and Alignment Guides sections with internal conflict detection"
  key_links:
    - from: "App/Sources/SettingsView.swift"
      to: "App/Sources/HotkeyNames.swift"
      via: "Recorder name: .measure and name: .alignmentGuides"
      pattern: "\\.measure|\\.alignmentGuides"
    - from: "App/Sources/SettingsView.swift"
      to: "KeyboardShortcuts library"
      via: "Recorder control and getShortcut/setShortcut API"
      pattern: "KeyboardShortcuts\\.Recorder"
---

<objective>
Replace the Shortcuts placeholder in SettingsView with inline KeyboardShortcuts.Recorder controls in each command's section, with internal conflict detection between the two commands.

Purpose: Users can record and manage keyboard shortcuts for both commands directly in their respective settings sections.
Output: Fully functional shortcut recording UI with conflict detection.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-global-hotkeys/22-RESEARCH.md
@.planning/phases/22-global-hotkeys/22-CONTEXT.md
@.planning/phases/22-global-hotkeys/22-01-PLAN.md

Key source files:
@App/Sources/SettingsView.swift
@App/Sources/HotkeyNames.swift (created in 22-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add recorder controls to SettingsView with internal conflict detection</name>
  <files>
    App/Sources/SettingsView.swift
  </files>
  <action>
**1. Add `import KeyboardShortcuts` at top of SettingsView.swift.**

**2. Add @State properties for conflict detection:**

```swift
@State private var measureConflict: String?
@State private var guidesConflict: String?
```

**3. Remove the Shortcuts placeholder section entirely:**

Delete the entire block:
```swift
// --- Shortcuts (placeholder for Phase 22) ---
Section("Shortcuts") {
    Text("Shortcuts will be available in a future update.")
        .foregroundStyle(.secondary)
        .font(.callout)
}
```

**4. Add KeyboardShortcuts.Recorder to the Measure section:**

After the corrections Picker in the Measure section, add:

```swift
KeyboardShortcuts.Recorder("Shortcut:", name: .measure) { newShortcut in
    if let newShortcut, newShortcut == KeyboardShortcuts.getShortcut(for: .alignmentGuides) {
        KeyboardShortcuts.setShortcut(nil, for: .measure)
        measureConflict = "Already assigned to Alignment Guides"
    } else {
        measureConflict = nil
    }
}

if let measureConflict {
    Text(measureConflict)
        .foregroundStyle(.orange)
        .font(.caption)
}
```

**5. Rename Alignment Guides to its own section and add recorder:**

Currently there is no "Alignment Guides" section in SettingsView. Create one after the Measure section:

```swift
// --- Alignment Guides ---
Section("Alignment Guides") {
    KeyboardShortcuts.Recorder("Shortcut:", name: .alignmentGuides) { newShortcut in
        if let newShortcut, newShortcut == KeyboardShortcuts.getShortcut(for: .measure) {
            KeyboardShortcuts.setShortcut(nil, for: .alignmentGuides)
            guidesConflict = "Already assigned to Measure"
        } else {
            guidesConflict = nil
        }
    }

    if let guidesConflict {
        Text(guidesConflict)
            .foregroundStyle(.orange)
            .font(.caption)
    }
}
```

**6. Final section order in the Form:**
1. General (launch at login, hide hint bar, auto-check updates)
2. Measure (border corrections picker, shortcut recorder)
3. Alignment Guides (shortcut recorder)
4. About (app info, version, links, check for updates)

The Recorder handles all the following automatically (no custom code needed):
- "Record Shortcut" placeholder when unassigned
- Modifier key requirement (at least one of Cmd, Ctrl, Option, Shift)
- X button to clear when assigned
- Delete/Backspace to clear while focused
- System shortcut conflict warnings (Cmd+Space, Cmd+Tab, etc.)
- Pausing hotkey monitoring while recording
- UserDefaults persistence

The ONLY custom validation we add is the internal conflict check via the `onChange` closure, which prevents the same shortcut from being assigned to both commands.

Per Claude's discretion: plain text rendering for shortcuts (no keycap styling — deferred idea). Recorder placed as last item in its section. Conflict notice uses inline `.foregroundStyle(.orange)` with `.font(.caption)`.
  </action>
  <verify>
Run `cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build 2>&1 | tail -5` to verify build succeeds.
Grep SettingsView.swift for `KeyboardShortcuts.Recorder` — should find exactly 2 instances.
Grep SettingsView.swift for `"Already assigned to"` — should find exactly 2 instances (one per command).
Grep SettingsView.swift for `"Shortcuts will be available"` — should find 0 instances (placeholder removed).
Verify `swift build` from SPM root still passes (Raycast unaffected).
  </verify>
  <done>
SettingsView has KeyboardShortcuts.Recorder in Measure section and Alignment Guides section. Internal conflict detection blocks duplicate assignments with inline orange warning. Shortcuts placeholder section removed. The Recorder handles system conflict warnings, modifier validation, clear button, and persistence automatically. Both xcodebuild and swift build pass.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild` Debug build succeeds
2. `swift build` (Raycast SPM path) still succeeds
3. SettingsView has exactly 2 KeyboardShortcuts.Recorder instances (one per command)
4. No "Shortcuts" placeholder section remains
5. Internal conflict detection present for both directions (Measure -> Guides, Guides -> Measure)
6. Recorders placed in their respective command sections (not a separate Shortcuts tab)
7. No keycap-style rendering (deferred per user decisions)
</verification>

<success_criteria>
- Measure section contains a shortcut recorder
- Alignment Guides section contains a shortcut recorder
- Assigning the same shortcut to both shows inline conflict warning and rejects
- Shortcuts placeholder section is gone
- Both xcodebuild and swift build pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-global-hotkeys/22-02-SUMMARY.md`
</output>
