---
phase: 22-global-hotkeys
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - App/Sources/SettingsView.swift
  - App/Sources/MenuBarController.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Orange warning message remains visible when assigning a duplicate shortcut to both commands"
    - "Menu bar dropdown displays assigned shortcut key combinations next to Measure and Alignment Guides items"
  artifacts:
    - path: "App/Sources/SettingsView.swift"
      provides: "Conflict detection that survives the double-fire onChange cycle"
      contains: "newShortcut != nil"
    - path: "App/Sources/MenuBarController.swift"
      provides: "Menu item shortcut display that refreshes when shortcuts change"
      contains: "menuNeedsUpdate"
  key_links:
    - from: "App/Sources/MenuBarController.swift"
      to: "KeyboardShortcuts library"
      via: "NSMenuItem.setShortcut(for:) with NSMenuDelegate refresh"
      pattern: "setShortcut.*for:.*measure"
---

<objective>
Fix two UAT-reported bugs in Phase 22 Global Hotkeys.

Purpose: Close the 2 gaps from 22-UAT.md so conflict detection shows its warning and menu bar items display shortcut symbols.
Output: Patched SettingsView.swift and MenuBarController.swift
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-global-hotkeys/22-UAT.md
@.planning/phases/22-global-hotkeys/22-01-SUMMARY.md
@.planning/phases/22-global-hotkeys/22-02-SUMMARY.md
@App/Sources/SettingsView.swift
@App/Sources/MenuBarController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix conflict detection warning disappearing immediately</name>
  <files>App/Sources/SettingsView.swift</files>
  <action>
The bug: When a user assigns a duplicate shortcut, the onChange callback fires twice in rapid succession:
1. First call: `newShortcut` = the conflicting shortcut. The `if let` branch matches, sets `measureConflict` (or `guidesConflict`) to the warning string, and calls `KeyboardShortcuts.setShortcut(nil, for: ...)` to reject.
2. Second call: `newShortcut` = nil. This is triggered by the `setShortcut(nil)` call above, which flows through the library's RecorderCocoa: notification -> controlTextDidChange -> saveShortcut(nil) -> onChange(nil). The `else` branch unconditionally sets `measureConflict = nil`, wiping the warning.

Fix: In SettingsView.swift, change the Measure recorder's else branch from:
```swift
} else {
    measureConflict = nil
}
```
to:
```swift
} else if newShortcut != nil {
    measureConflict = nil
}
```

And change the Alignment Guides recorder's else branch from:
```swift
} else {
    guidesConflict = nil
}
```
to:
```swift
} else if newShortcut != nil {
    guidesConflict = nil
}
```

This way, the warning is only cleared when the user actively records a new (non-conflicting) shortcut, not when the nil callback fires from the rejection chain. The warning persists until the user records a valid non-conflicting shortcut.
  </action>
  <verify>Build with `cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build 2>&1 | tail -5` — must show BUILD SUCCEEDED.</verify>
  <done>Both conflict warning else-branches guard on `newShortcut != nil`. The orange warning text persists after assigning a duplicate shortcut.</done>
</task>

<task type="auto">
  <name>Task 2: Fix menu bar dropdown not showing shortcut symbols</name>
  <files>App/Sources/MenuBarController.swift</files>
  <action>
The bug: `NSMenuItem.setShortcut(for:)` is called once during `setupMenu()` in `init()`. The library attaches a NotificationCenter observer on each NSMenuItem via `objc_setAssociatedObject` to auto-update when shortcuts change. UAT reports shortcuts are not showing — the observer chain may have a subtle timing or lifecycle issue.

The defensive fix: Make MenuBarController conform to NSMenuDelegate and implement `menuNeedsUpdate(_:)` to re-apply shortcuts every time the menu is about to open. This guarantees the menu items always reflect the current shortcut state regardless of whether the observer chain works.

Implementation steps:

1. Store `measureItem` and `guidesItem` as private properties (currently they are local variables in `setupMenu()`). This is needed so `menuNeedsUpdate` can reference them.

2. Make the class conform to `NSMenuDelegate`:
```swift
final class MenuBarController: NSObject, NSMenuDelegate {
```
Note: NSMenuDelegate requires NSObjectProtocol, so MenuBarController must inherit from NSObject.

3. In `setupMenu()`, after creating the menu and before setting `statusItem.menu = menu`, set `menu.delegate = self`.

4. Implement `menuNeedsUpdate(_:)`:
```swift
func menuNeedsUpdate(_ menu: NSMenu) {
    MainActor.assumeIsolated {
        measureItem.setShortcut(for: .measure)
        guidesItem.setShortcut(for: .alignmentGuides)
    }
}
```

5. Keep the existing `setShortcut(for:)` calls in `setupMenu()` as-is (they handle the initial state and set up the library's observer). The `menuNeedsUpdate` is a defensive refresh that fires every time the user opens the dropdown.

IMPORTANT: The library's documentation for `setShortcut(for:)` notes you should disable global keyboard shortcuts while the menu is open (because NSMenu puts the thread in tracking-mode). Implement `menuWillOpen(_:)` and `menuDidClose(_:)` to disable/enable shortcuts:
```swift
func menuWillOpen(_ menu: NSMenu) {
    KeyboardShortcuts.disable(.measure)
    KeyboardShortcuts.disable(.alignmentGuides)
}

func menuDidClose(_ menu: NSMenu) {
    KeyboardShortcuts.enable(.measure)
    KeyboardShortcuts.enable(.alignmentGuides)
}
```
This also fixes a potential issue where pressing a hotkey while the menu is open would buffer the event and trigger when the menu closes.
  </action>
  <verify>Build with `cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build 2>&1 | tail -5` — must show BUILD SUCCEEDED. Also grep MenuBarController.swift for `menuNeedsUpdate`, `NSMenuDelegate`, `measureItem`, and `menuWillOpen` to confirm all pieces are present.</verify>
  <done>MenuBarController conforms to NSMenuDelegate, stores menu item references, re-applies shortcuts in menuNeedsUpdate, and disables/enables hotkeys during menu open/close. Menu bar dropdown shows assigned shortcut key combinations.</done>
</task>

</tasks>

<verification>
1. `xcodebuild` BUILD SUCCEEDED for the Design Ruler scheme
2. `swift build` from swift/DesignRuler/ still passes (these files are App-only, not in DesignRulerCore)
3. SettingsView.swift conflict else-branches contain `newShortcut != nil` guard
4. MenuBarController.swift conforms to NSMenuDelegate with menuNeedsUpdate, menuWillOpen, menuDidClose
5. MenuBarController stores measureItem and guidesItem as properties
</verification>

<success_criteria>
1. Conflict detection: assigning a duplicate shortcut shows the orange warning message (it no longer disappears immediately)
2. Menu bar: opening the dropdown after assigning shortcuts shows the shortcut key combinations next to Measure and Alignment Guides
3. Both builds pass (xcodebuild and swift build)
</success_criteria>

<output>
After completion, create `.planning/phases/22-global-hotkeys/22-03-SUMMARY.md`
</output>
