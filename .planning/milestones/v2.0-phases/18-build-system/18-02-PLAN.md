---
phase: 18-build-system
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - App/project.yml
  - App/Sources/AppDelegate.swift
  - App/Sources/Info.plist
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Xcode project builds and produces a runnable .app binary"
    - "The app links against DesignRulerCore from the local SPM package"
    - "The app is an LSUIElement agent (no Dock icon, no Cmd+Tab entry)"
    - "The app targets macOS 14 Sonoma minimum with universal architecture"
  artifacts:
    - path: "App/project.yml"
      provides: "xcodegen spec defining the standalone macOS app target"
      contains: "DesignRulerCore"
    - path: "App/Sources/AppDelegate.swift"
      provides: "Minimal @main app delegate stub"
      contains: "@main"
    - path: "App/Sources/Info.plist"
      provides: "App metadata with LSUIElement=true"
      contains: "LSUIElement"
    - path: "App/Design Ruler.xcodeproj"
      provides: "Generated Xcode project (committed for convenience)"
  key_links:
    - from: "App/project.yml"
      to: "swift/DesignRuler/Package.swift"
      via: "local package reference"
      pattern: "path: ../swift/DesignRuler"
    - from: "App/project.yml"
      to: "DesignRulerCore library product"
      via: "package product dependency"
      pattern: "product: DesignRulerCore"
---

<objective>
Create a minimal Xcode project for the standalone macOS app that references DesignRulerCore as a local package dependency, and verify it builds.

Purpose: Establishes the build infrastructure for the standalone app. Phase 18 produces only a stub app that launches and exits cleanly — features are added in Phase 19+.

Output: `App/` directory with xcodegen spec, minimal AppDelegate, Info.plist, and a generated `.xcodeproj` that builds a runnable `.app` binary.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-build-system/18-RESEARCH.md
@.planning/phases/18-build-system/18-01-SUMMARY.md
@swift/DesignRuler/Package.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Xcode app project with xcodegen</name>
  <files>
    App/project.yml
    App/Sources/AppDelegate.swift
    App/Sources/Info.plist
    App/Design Ruler.xcodeproj/ (generated)
    .gitignore
  </files>
  <action>
**Step 1: Install xcodegen if not present.**

```bash
brew install xcodegen
```

Verify installation: `xcodegen --version` should show 2.44.x or later.

**Step 2: Create directory structure.**

```bash
mkdir -p App/Sources
```

**Step 3: Create `App/Sources/Info.plist`.**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleName</key>
    <string>Design Ruler</string>
    <key>CFBundleDisplayName</key>
    <string>Design Ruler</string>
    <key>CFBundleIdentifier</key>
    <string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
    <key>CFBundleVersion</key>
    <string>$(CURRENT_PROJECT_VERSION)</string>
    <key>CFBundleShortVersionString</key>
    <string>$(MARKETING_VERSION)</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleExecutable</key>
    <string>$(EXECUTABLE_NAME)</string>
    <key>LSUIElement</key>
    <true/>
    <key>NSHighResolutionCapable</key>
    <true/>
    <key>NSPrincipalClass</key>
    <string>NSApplication</string>
    <key>NSApplicationSupportsSecureRestorableState</key>
    <true/>
</dict>
</plist>
```

Key entries:
- `LSUIElement = true` — no Dock icon, no Cmd+Tab entry (locked decision)
- `NSHighResolutionCapable = true` — Retina support
- Bundle identifier uses build setting variable `$(PRODUCT_BUNDLE_IDENTIFIER)` which is set in project.yml

**Step 4: Create `App/Sources/AppDelegate.swift`.**

```swift
import AppKit

@main
class AppDelegate: NSObject, NSApplicationDelegate {
    func applicationDidFinishLaunching(_ notification: Notification) {
        // Phase 18: Build system stub — features come in Phase 19+
    }

    func applicationShouldTerminateAfterLastWindowClosed(_ sender: NSApplication) -> Bool {
        return false
    }
}
```

This is a minimal stub. The `@main` attribute designates the entry point. `applicationShouldTerminateAfterLastWindowClosed` returns false because a menu bar agent app has no windows by default and should not terminate on window close.

**Step 5: Create `App/project.yml`.**

```yaml
name: "Design Ruler"
options:
  deploymentTarget:
    macOS: "14.0"
  createIntermediateGroups: true

packages:
  DesignRuler:
    path: ../swift/DesignRuler

targets:
  "Design Ruler":
    type: application
    platform: macOS
    deploymentTarget: "14.0"
    sources:
      - Sources
    dependencies:
      - package: DesignRuler
        product: DesignRulerCore
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: cv.haythem.designruler
        PRODUCT_NAME: "Design Ruler"
        SWIFT_VERSION: "5.9"
        MACOSX_DEPLOYMENT_TARGET: "14.0"
        ARCHS: "$(ARCHS_STANDARD)"
        CODE_SIGN_STYLE: Automatic
        CURRENT_PROJECT_VERSION: "1"
        MARKETING_VERSION: "1.0.0"
      configs:
        Debug:
          CODE_SIGN_IDENTITY: "-"
    info:
      path: Sources/Info.plist
```

Key settings:
- `PRODUCT_BUNDLE_IDENTIFIER: cv.haythem.designruler` (locked decision)
- `PRODUCT_NAME: "Design Ruler"` (locked decision: app name with space)
- `ARCHS: "$(ARCHS_STANDARD)"` — builds Universal binary (Apple Silicon + Intel) (locked decision)
- `MACOSX_DEPLOYMENT_TARGET: "14.0"` — macOS 14 Sonoma minimum (locked decision)
- `CODE_SIGN_IDENTITY: "-"` for Debug — ad-hoc signing for local development
- No entitlements file — App Sandbox is disabled (required for CGEventTap + CGWindowListCreateImage)
- Package reference `path: ../swift/DesignRuler` — relative from App/ to the SPM package

**Step 6: Generate the Xcode project.**

```bash
cd App && xcodegen generate
```

Must output "Generated project" or similar success message. The generated `Design Ruler.xcodeproj` is committed for convenience (engineers can open it without installing xcodegen).

**Step 7: Verify the relative package path resolves.**

```bash
ls App/../swift/DesignRuler/Package.swift
```

Must exist — xcodegen uses this path to find the local package.

**Step 8: Update .gitignore.**

Add these entries to the project root `.gitignore` if not already present:

```
# Xcode
App/Design Ruler.xcodeproj/xcuserdata/
App/Design Ruler.xcodeproj/project.xcworkspace/xcuserdata/
DerivedData/
```

Do NOT ignore the `.xcodeproj` directory itself — it's committed for convenience.

**Step 9: Build the Xcode project from CLI.**

```bash
xcodebuild build \
  -project "App/Design Ruler.xcodeproj" \
  -scheme "Design Ruler" \
  -configuration Debug \
  -destination "generic/platform=macOS,name=Any Mac" \
  -derivedDataPath App/DerivedData \
  2>&1 | tail -20
```

Must show "BUILD SUCCEEDED". If it fails:
- "no such module 'DesignRulerCore'" → the local package reference path is wrong in project.yml; fix and regenerate
- "inaccessible due to 'internal' protection level" → a DesignRulerCore type needs `public` (not expected for Phase 18 since the stub doesn't call DesignRulerCore APIs, but just in case)

**Step 10: Clean up DerivedData.**

```bash
rm -rf App/DerivedData
```

DerivedData is a build artifact, not committed.
  </action>
  <verify>
1. `xcodegen --version` shows installed version
2. `ls App/project.yml App/Sources/AppDelegate.swift App/Sources/Info.plist` — all exist
3. `ls "App/Design Ruler.xcodeproj/project.pbxproj"` — generated project exists
4. `xcodebuild build -project "App/Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug -destination "generic/platform=macOS,name=Any Mac"` exits with BUILD SUCCEEDED
5. `grep "LSUIElement" App/Sources/Info.plist` — confirms LSUIElement is present
6. `grep "cv.haythem.designruler" App/project.yml` — confirms bundle identifier
7. `grep "DesignRulerCore" App/project.yml` — confirms library dependency
  </verify>
  <done>
App/ directory exists with project.yml, AppDelegate.swift stub, Info.plist (LSUIElement=true), and generated Design Ruler.xcodeproj. xcodebuild produces a runnable .app binary that links against DesignRulerCore. Bundle identifier is cv.haythem.designruler, deployment target is macOS 14, architecture is universal.
  </done>
</task>

</tasks>

<verification>
1. Xcode project exists at `App/Design Ruler.xcodeproj`
2. `xcodebuild build` exits with BUILD SUCCEEDED
3. The app links against DesignRulerCore (visible in project.yml dependencies)
4. Info.plist has LSUIElement=true (no Dock icon)
5. Bundle identifier is cv.haythem.designruler
6. Deployment target is macOS 14.0
7. .gitignore updated for Xcode user data
</verification>

<success_criteria>
- `App/Design Ruler.xcodeproj` exists and was generated from `App/project.yml`
- `xcodebuild build` succeeds for the "Design Ruler" scheme
- Info.plist contains LSUIElement=true
- project.yml references DesignRulerCore as a local package dependency
- No DerivedData committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/18-build-system/18-02-SUMMARY.md`
</output>
