---
phase: 18-build-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - swift/DesignRuler/Package.swift
  - swift/DesignRuler/Sources/DesignRulerCore/AlignmentGuides/AlignmentGuidesWindow.swift
  - swift/DesignRuler/Sources/DesignRulerCore/AlignmentGuides/ColorCircleIndicator.swift
  - swift/DesignRuler/Sources/DesignRulerCore/AlignmentGuides/GuideLine.swift
  - swift/DesignRuler/Sources/DesignRulerCore/AlignmentGuides/GuideLineManager.swift
  - swift/DesignRuler/Sources/DesignRulerCore/AlignmentGuides/GuideLineStyle.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Cursor/CursorManager.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Measure/ColorMap.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Measure/CrosshairView.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Measure/DirectionalEdges.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Measure/EdgeDetector.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Measure/MeasureWindow.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Measure/SelectionManager.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Measure/SelectionOverlay.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Permissions/PermissionChecker.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Rendering/HintBarContent.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Rendering/HintBarView.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Rendering/PillRenderer.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Utilities/CoordinateConverter.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Utilities/DesignTokens.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Utilities/OverlayCoordinator.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Utilities/OverlayWindow.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Utilities/ScreenCapture.swift
  - swift/DesignRuler/Sources/DesignRulerCore/Utilities/TransactionHelpers.swift
  - swift/DesignRuler/Sources/RaycastBridge/Measure.swift
  - swift/DesignRuler/Sources/RaycastBridge/AlignmentGuides.swift
autonomous: true

must_haves:
  truths:
    - "DesignRulerCore library target exists in Package.swift containing all 23 shared overlay/detection/rendering Swift files"
    - "RaycastBridge executable target exists in Package.swift containing the 2 @raycast entry point files"
    - "ray build completes without errors after the SPM source restructure"
    - "swift package dump-package shows exactly 1 executable target (DesignRuler) and 1 library target (DesignRulerCore)"
  artifacts:
    - path: "swift/DesignRuler/Package.swift"
      provides: "Two-target SPM package (library + executable)"
      contains: "DesignRulerCore"
    - path: "swift/DesignRuler/Sources/DesignRulerCore/"
      provides: "23 shared Swift source files with package access modifiers"
    - path: "swift/DesignRuler/Sources/RaycastBridge/"
      provides: "2 Raycast bridge files with import DesignRulerCore"
  key_links:
    - from: "swift/DesignRuler/Sources/RaycastBridge/Measure.swift"
      to: "DesignRulerCore module"
      via: "import DesignRulerCore"
      pattern: "import DesignRulerCore"
    - from: "swift/DesignRuler/Sources/RaycastBridge/AlignmentGuides.swift"
      to: "DesignRulerCore module"
      via: "import DesignRulerCore"
      pattern: "import DesignRulerCore"
    - from: "Package.swift executableTarget"
      to: "DesignRulerCore"
      via: "target dependency"
      pattern: '"DesignRulerCore"'
---

<objective>
Restructure the Swift package into a shared library target (DesignRulerCore) and a Raycast bridge executable target (DesignRuler), then verify the Raycast build still passes.

Purpose: Enables the standalone macOS app (Phase 18 Plan 02) to reference DesignRulerCore as a local package dependency, while keeping the Raycast extension build path unchanged.

Output: Two SPM targets in one Package.swift — `DesignRulerCore` (library, 23 files) and `DesignRuler` (executable, 2 files). `ray build` passes.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-build-system/18-RESEARCH.md
@CLAUDE.md
@swift/DesignRuler/Package.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure SPM sources into DesignRulerCore library and RaycastBridge executable</name>
  <files>
    swift/DesignRuler/Package.swift
    swift/DesignRuler/Sources/DesignRulerCore/ (23 files, 6 subdirectories)
    swift/DesignRuler/Sources/RaycastBridge/ (2 files)
  </files>
  <action>
**Step 1: Create target directories.**

```bash
mkdir -p swift/DesignRuler/Sources/DesignRulerCore/{AlignmentGuides,Cursor,Measure,Permissions,Rendering,Utilities}
mkdir -p swift/DesignRuler/Sources/RaycastBridge
```

**Step 2: Move 23 shared files to DesignRulerCore (preserving subdirectory structure).**

Move these files from `Sources/` subdirectories to the corresponding `Sources/DesignRulerCore/` subdirectory:

- `AlignmentGuides/AlignmentGuidesWindow.swift` → `DesignRulerCore/AlignmentGuides/`
- `AlignmentGuides/ColorCircleIndicator.swift` → `DesignRulerCore/AlignmentGuides/`
- `AlignmentGuides/GuideLine.swift` → `DesignRulerCore/AlignmentGuides/`
- `AlignmentGuides/GuideLineManager.swift` → `DesignRulerCore/AlignmentGuides/`
- `AlignmentGuides/GuideLineStyle.swift` → `DesignRulerCore/AlignmentGuides/`
- `Cursor/CursorManager.swift` → `DesignRulerCore/Cursor/`
- `Measure/ColorMap.swift` → `DesignRulerCore/Measure/`
- `Measure/CrosshairView.swift` → `DesignRulerCore/Measure/`
- `Measure/DirectionalEdges.swift` → `DesignRulerCore/Measure/`
- `Measure/EdgeDetector.swift` → `DesignRulerCore/Measure/`
- `Measure/MeasureWindow.swift` → `DesignRulerCore/Measure/`
- `Measure/SelectionManager.swift` → `DesignRulerCore/Measure/`
- `Measure/SelectionOverlay.swift` → `DesignRulerCore/Measure/`
- `Permissions/PermissionChecker.swift` → `DesignRulerCore/Permissions/`
- `Rendering/HintBarContent.swift` → `DesignRulerCore/Rendering/`
- `Rendering/HintBarView.swift` → `DesignRulerCore/Rendering/`
- `Rendering/PillRenderer.swift` → `DesignRulerCore/Rendering/`
- `Utilities/CoordinateConverter.swift` → `DesignRulerCore/Utilities/`
- `Utilities/DesignTokens.swift` → `DesignRulerCore/Utilities/`
- `Utilities/OverlayCoordinator.swift` → `DesignRulerCore/Utilities/`
- `Utilities/OverlayWindow.swift` → `DesignRulerCore/Utilities/`
- `Utilities/ScreenCapture.swift` → `DesignRulerCore/Utilities/`
- `Utilities/TransactionHelpers.swift` → `DesignRulerCore/Utilities/`

Use `git mv` for all moves to preserve history.

**Step 3: Move 2 bridge files to RaycastBridge.**

- `AlignmentGuides/AlignmentGuides.swift` → `RaycastBridge/AlignmentGuides.swift`
- `Measure/Measure.swift` → `RaycastBridge/Measure.swift`

Use `git mv` for both.

**Step 4: Clean up empty old directories.**

After moving, the old `Sources/AlignmentGuides/`, `Sources/Cursor/`, `Sources/Measure/`, `Sources/Permissions/`, `Sources/Rendering/`, `Sources/Utilities/` directories should be empty. Remove them with `rmdir`.

**Step 5: Update Package.swift.**

Replace the entire Package.swift content with:

```swift
// swift-tools-version: 5.9

import PackageDescription

let package = Package(
    name: "DesignRuler",
    platforms: [.macOS(.v14)],
    products: [
        .library(name: "DesignRulerCore", targets: ["DesignRulerCore"]),
    ],
    dependencies: [
        .package(url: "https://github.com/raycast/extensions-swift-tools", from: "1.0.4"),
    ],
    targets: [
        .target(
            name: "DesignRulerCore",
            path: "Sources/DesignRulerCore"
        ),
        .executableTarget(
            name: "DesignRuler",
            dependencies: [
                "DesignRulerCore",
                .product(name: "RaycastSwiftMacros", package: "extensions-swift-tools"),
                .product(name: "RaycastSwiftPlugin", package: "extensions-swift-tools"),
                .product(name: "RaycastTypeScriptPlugin", package: "extensions-swift-tools"),
            ],
            path: "Sources/RaycastBridge"
        ),
    ]
)
```

Key changes from current Package.swift:
- `platforms` updated from `.macOS(.v13)` to `.macOS(.v14)` (locked decision: macOS 14 Sonoma minimum)
- Added `products` array with `DesignRulerCore` library
- Added `DesignRulerCore` library target (`path: "Sources/DesignRulerCore"`)
- Updated executable target to depend on `DesignRulerCore` and use `path: "Sources/RaycastBridge"`

**Step 6: Add `import DesignRulerCore` to both bridge files.**

In `Sources/RaycastBridge/Measure.swift`: add `import DesignRulerCore` after the existing `import AppKit` (or wherever imports are).

In `Sources/RaycastBridge/AlignmentGuides.swift`: add `import DesignRulerCore` after the existing imports.

**Step 7: Add `package` access modifiers to all 23 DesignRulerCore files.**

For every file in `Sources/DesignRulerCore/`, add `package` to ALL top-level declarations and their members that are referenced from the bridge files. The safest approach: add `package` to EVERY top-level type declaration (class, struct, enum, protocol) and EVERY member that isn't already `private` or `fileprivate`. This includes:

- `package class` / `package struct` / `package enum` / `package protocol`
- `package func` on all methods
- `package var` / `package let` on all properties
- `package init` on all initializers
- `package static func` / `package static var` on all static members
- `package typealias` on any type aliases

Do NOT change:
- `private` or `fileprivate` members (keep as-is)
- Members that are already `public` (none expected, but keep if found)
- Computed property bodies, closures, local variables inside functions

The `package` modifier makes types/members visible across targets within the same SPM package (DesignRulerCore and DesignRuler are both in the "DesignRuler" package), but NOT visible to external consumers (like the Xcode app in Plan 02 — that's handled in Phase 19).

**Important:** Also add `package` to `OverlayWindowProtocol` and all its required methods/properties. The bridge files' coordinator subclasses conform to patterns defined through this protocol.

**Step 8: Verify the SPM package resolves.**

```bash
cd swift/DesignRuler && swift package dump-package | python3 -c "
import json, sys
d = json.load(sys.stdin)
exes = [t for t in d.get('targets', []) if t.get('type') == 'executable']
libs = [t for t in d.get('targets', []) if t.get('type') == 'regular']
print(f'Executable targets: {len(exes)} -> {[t[\"name\"] for t in exes]}')
print(f'Library targets: {len(libs)} -> {[t[\"name\"] for t in libs]}')
print('Raycast compatible: ' + ('YES' if len(exes) == 1 else 'NO'))
"
```

Must show: 1 executable (DesignRuler), 1 library (DesignRulerCore), Raycast compatible: YES.
  </action>
  <verify>
1. `find swift/DesignRuler/Sources/DesignRulerCore -name "*.swift" | wc -l` returns 23
2. `find swift/DesignRuler/Sources/RaycastBridge -name "*.swift" | wc -l` returns 2
3. `ls swift/DesignRuler/Sources/AlignmentGuides swift/DesignRuler/Sources/Measure swift/DesignRuler/Sources/Cursor swift/DesignRuler/Sources/Permissions swift/DesignRuler/Sources/Rendering swift/DesignRuler/Sources/Utilities 2>&1` shows "No such file or directory" for all (old dirs removed)
4. `grep "import DesignRulerCore" swift/DesignRuler/Sources/RaycastBridge/*.swift | wc -l` returns 2
5. `swift package dump-package` in `swift/DesignRuler/` shows 1 executable + 1 library target
  </verify>
  <done>
23 shared Swift files live in Sources/DesignRulerCore/ with `package` access modifiers. 2 bridge files live in Sources/RaycastBridge/ with `import DesignRulerCore`. Package.swift has 2 targets (library + executable) with macOS 14 minimum. SPM resolves cleanly with exactly 1 executable target.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Raycast build passes after restructure</name>
  <files>
    (no files modified — verification only)
  </files>
  <action>
**Step 1: Delete stale Raycast build cache.**

```bash
rm -rf swift/DesignRuler/.raycast-swift-build
```

The `.raycast-swift-build/` directory caches xcodebuild derived data. After moving source files, stale path references in the cache cause confusing build errors. Delete it before the first post-restructure build.

Also delete SPM's `.build` cache in the package directory:

```bash
rm -rf swift/DesignRuler/.build
```

**Step 2: Run `ray build`.**

```bash
cd porto && ray build
```

This must complete without errors. It exercises the full Raycast build path: `swift package dump-package` → target discovery → `xcodebuild build`.

If `ray build` fails with access modifier errors, go back to Task 1 and add missing `package` modifiers. Common failures:
- "'SomeType' is inaccessible due to 'internal' protection level" → add `package` to that type/member in DesignRulerCore
- "cannot find type 'X' in scope" in RaycastBridge files → add `import DesignRulerCore` or add `package` to X in DesignRulerCore

**Step 3: Verify the built binary exists.**

After `ray build` succeeds, confirm the Raycast extension binary was produced. The binary should be at a path like `.raycast-swift-build/` or similar derived data path.

**Step 4: Verify TypeScript still compiles.**

The TypeScript files (`src/measure.ts`, `src/alignment-guides.ts`) import from `swift:../swift/DesignRuler` — this path has NOT changed (Package.swift is still at the same location). Just confirm `ray build` handled them too (it builds both TS and Swift).
  </action>
  <verify>
1. `ray build` exits with code 0 (no errors)
2. No "inaccessible due to 'internal' protection level" errors in output
3. No "expected one executable target but found more than one" errors
  </verify>
  <done>
`ray build` passes cleanly after the SPM restructure, confirming the Raycast extension build path is unchanged. The library target is invisible to Raycast's target counting logic.
  </done>
</task>

</tasks>

<verification>
1. Source structure: 23 files in DesignRulerCore, 2 files in RaycastBridge, 0 files in old locations
2. Package.swift: 2 targets (1 library, 1 executable), macOS 14 platform, library product declared
3. Access modifiers: all shared types/members have `package` access
4. Bridge imports: both RaycastBridge files have `import DesignRulerCore`
5. Raycast build: `ray build` passes without errors
</verification>

<success_criteria>
- `swift package dump-package` shows exactly 1 executable target and 1 library target
- `ray build` completes with exit code 0
- All 23 shared files are in Sources/DesignRulerCore/ with `package` access modifiers
- Both bridge files are in Sources/RaycastBridge/ with `import DesignRulerCore`
- No old source directories remain (Sources/AlignmentGuides/, Sources/Measure/, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/18-build-system/18-01-SUMMARY.md`
</output>
