---
phase: 23-distribution
plan: 03
type: execute
wave: 2
depends_on: ["23-01", "23-02"]
files_modified:
  - App/project.yml
autonomous: false

user_setup:
  - service: "Apple Developer Program"
    why: "Developer ID code signing certificate and notarization credentials"
    env_vars:
      - name: DEVELOPER_ID_CERT_BASE64
        source: "Export Developer ID Application certificate from Keychain Access as .p12, then base64 encode: base64 -i cert.p12 | pbcopy"
      - name: DEVELOPER_ID_CERT_PASSWORD
        source: "Password you set when exporting the .p12 file"
      - name: APPLE_ID
        source: "Your Apple Developer account email"
      - name: NOTARY_PASSWORD
        source: "App-specific password from https://appleid.apple.com > Sign-In and Security > App-Specific Passwords"
      - name: TEAM_ID
        source: "Apple Developer Team ID from https://developer.apple.com/account > Membership Details"
    dashboard_config:
      - task: "Enroll in Apple Developer Program ($99/yr)"
        location: "https://developer.apple.com/programs/enroll/"
      - task: "Create Developer ID Application certificate"
        location: "https://developer.apple.com/account/resources/certificates/add — select 'Developer ID Application'"
      - task: "Generate app-specific password for notarytool"
        location: "https://appleid.apple.com > Sign-In and Security > App-Specific Passwords"
  - service: "Sparkle EdDSA Keys"
    why: "EdDSA signing key pair for Sparkle update verification"
    env_vars:
      - name: SPARKLE_PRIVATE_KEY
        source: "Generated locally with Sparkle's generate_keys -x tool (see instructions below)"
    dashboard_config:
      - task: "Generate EdDSA key pair and store private key as GitHub Secret"
        location: "Local terminal — download Sparkle tools, run generate_keys"
  - service: "GitHub Repository Secrets"
    why: "All signing credentials must be stored as GitHub Secrets for CI"
    env_vars:
      - name: KEYCHAIN_PASSWORD
        source: "Generate any random password: openssl rand -base64 32 | pbcopy"
    dashboard_config:
      - task: "Add all 7 secrets to GitHub repository"
        location: "GitHub repo > Settings > Secrets and variables > Actions > New repository secret"

must_haves:
  truths:
    - "Real SUPublicEDKey is set in project.yml Info.plist properties (replacing placeholder)"
    - "All 7 GitHub Secrets are configured in the repository"
    - "User has a Developer ID Application certificate in Keychain Access"
    - "Sparkle EdDSA key pair has been generated (public key in app, private key in GitHub Secret)"
  artifacts:
    - path: "App/project.yml"
      provides: "Real SUPublicEDKey replacing PLACEHOLDER_EDDSA_PUBLIC_KEY"
      contains: "SUPublicEDKey"
  key_links:
    - from: "App/project.yml (SUPublicEDKey)"
      to: "GitHub Secret (SPARKLE_PRIVATE_KEY)"
      via: "Matching EdDSA key pair — public key verifies signatures made by private key"
      pattern: "SUPublicEDKey"
---

<objective>
Guide the user through Apple Developer setup, EdDSA key generation, GitHub Secrets configuration, and set the real Sparkle public key in the app.

Purpose: The CI pipeline requires signing credentials, notarization credentials, and a Sparkle EdDSA key pair. These involve the user's personal Apple Developer account and cannot be automated by Claude. After the user completes setup, Claude updates project.yml with the real SUPublicEDKey.

Output: Fully configured GitHub Secrets, real SUPublicEDKey in project.yml.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-distribution/23-RESEARCH.md
@.planning/phases/23-distribution/23-01-SUMMARY.md
@.planning/phases/23-distribution/23-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Apple Developer setup, EdDSA key generation, and GitHub Secrets configuration</name>
  <action>
The user must complete the following steps. These require personal credentials and account access that Claude cannot perform.

**Part A: Apple Developer Program** (skip if already enrolled)

1. Enroll at https://developer.apple.com/programs/enroll/ ($99/yr)
2. Once enrolled, create a **Developer ID Application** certificate:
   - Go to https://developer.apple.com/account/resources/certificates/add
   - Select "Developer ID Application"
   - Follow the CSR (Certificate Signing Request) flow using Keychain Access
   - Download and install the certificate
3. Export the certificate as .p12:
   - Open Keychain Access > My Certificates
   - Right-click "Developer ID Application: [Your Name]" > Export
   - Save as .p12, set a password (this becomes `DEVELOPER_ID_CERT_PASSWORD`)
   - Base64 encode: `base64 -i certificate.p12 | pbcopy` (this becomes `DEVELOPER_ID_CERT_BASE64`)
4. Get your Team ID:
   - Go to https://developer.apple.com/account > Membership Details
   - Copy the Team ID (this becomes `TEAM_ID`)
5. Create an app-specific password for notarytool:
   - Go to https://appleid.apple.com > Sign-In and Security > App-Specific Passwords
   - Generate a new password labeled "notarytool" (this becomes `NOTARY_PASSWORD`)

**Part B: Sparkle EdDSA Key Pair**

1. Download Sparkle tools:
```bash
curl -sL "https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz" -o /tmp/Sparkle.tar.xz
mkdir -p /tmp/sparkle-tools && tar xf /tmp/Sparkle.tar.xz -C /tmp/sparkle-tools
```

2. Generate key pair:
```bash
/tmp/sparkle-tools/bin/generate_keys
```
This prints the public key (e.g., `pfIShU4dEXqPd5ObYNfDBiQWcXozk7estwzTnF9BamQ=`).
**Save this public key** — it goes into project.yml.

3. Export private key:
```bash
/tmp/sparkle-tools/bin/generate_keys -x /tmp/sparkle-private-key
cat /tmp/sparkle-private-key | pbcopy
rm /tmp/sparkle-private-key
```
The clipboard now contains the private key (this becomes `SPARKLE_PRIVATE_KEY`).

**Part C: GitHub Repository Secrets**

Go to the GitHub repository > Settings > Secrets and variables > Actions > New repository secret.

Add these 7 secrets:
1. `DEVELOPER_ID_CERT_BASE64` — Base64-encoded .p12 (from Part A step 3)
2. `DEVELOPER_ID_CERT_PASSWORD` — .p12 export password (from Part A step 3)
3. `KEYCHAIN_PASSWORD` — Random password: `openssl rand -base64 32 | pbcopy`
4. `APPLE_ID` — Apple Developer account email
5. `NOTARY_PASSWORD` — App-specific password (from Part A step 5)
6. `TEAM_ID` — Apple Developer Team ID (from Part A step 4)
7. `SPARKLE_PRIVATE_KEY` — EdDSA private key (from Part B step 3)
  </action>
  <resume-signal>Provide the Sparkle EdDSA public key string (e.g., "pfIShU4dEXqPd5ObYNfDBiQWcXozk7estwzTnF9BamQ=") and confirm all 7 GitHub Secrets are configured. Also confirm the exact GitHub repository URL (owner/repo) for SUFeedURL.</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Set real SUPublicEDKey and SUFeedURL in project.yml</name>
  <files>App/project.yml</files>
  <action>
After the user provides the real EdDSA public key and repository URL:

1. **Update `App/project.yml`** — Replace the placeholder `SUPublicEDKey` value with the real public key provided by the user:

Find:
```yaml
SUPublicEDKey: "PLACEHOLDER_EDDSA_PUBLIC_KEY"
```
Replace with:
```yaml
SUPublicEDKey: "[REAL_PUBLIC_KEY_FROM_USER]"
```

2. **Verify/Update SUFeedURL** — If the user provides a different repository URL than the current placeholder, update it:

Current:
```yaml
SUFeedURL: "https://github.com/haythem/design-ruler/releases/latest/download/appcast.xml"
```

Update the owner/repo portion if the user specifies a different repository URL.

3. **Regenerate .xcodeproj** — Run `cd App && xcodegen generate` to regenerate the Xcode project with the updated Info.plist properties.

4. **Verify the key is in the generated plist** — After xcodegen, check:
```bash
grep SUPublicEDKey App/Sources/Info.plist
```
This confirms xcodegen wrote the real key into the Info.plist.

5. **Build and verify** — `cd App && xcodebuild build -scheme "Design Ruler" -configuration Debug` to confirm the app still builds with the real key.
  </action>
  <verify>
```bash
# Verify real key is set (not placeholder)
grep -v "PLACEHOLDER" App/project.yml | grep "SUPublicEDKey"
# Verify xcodegen picked it up
cd App && xcodegen generate && grep "SUPublicEDKey" Sources/Info.plist
# Verify build
cd App && xcodebuild build -scheme "Design Ruler" -configuration Debug 2>&1 | tail -3
```
  </verify>
  <done>project.yml has real SUPublicEDKey and correct SUFeedURL. Generated Info.plist contains the real EdDSA public key. Debug build succeeds.</done>
</task>

</tasks>

<verification>
1. `App/project.yml` contains a real SUPublicEDKey value (not "PLACEHOLDER_EDDSA_PUBLIC_KEY")
2. `App/Sources/Info.plist` (after xcodegen) contains the same real SUPublicEDKey
3. SUFeedURL points to the correct GitHub repository
4. All 7 GitHub Secrets are configured (user confirmation)
5. Debug build succeeds with real keys
</verification>

<success_criteria>
The app is configured with a real Sparkle EdDSA public key and correct feed URL. All GitHub Secrets required by the CI pipeline are configured. The distribution pipeline is ready for its first tag-push test.
</success_criteria>

<output>
After completion, create `.planning/phases/23-distribution/23-03-SUMMARY.md`
</output>
