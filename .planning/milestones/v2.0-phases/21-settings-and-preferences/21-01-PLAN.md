---
phase: 21-settings-and-preferences
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - App/Sources/AppPreferences.swift
  - App/Sources/SettingsView.swift
  - App/Sources/SettingsWindowController.swift
  - App/Sources/MenuBarController.swift
  - App/Sources/AppDelegate.swift
  - App/Sources/Info.plist
  - App/project.yml
autonomous: true

must_haves:
  truths:
    - "User can open a Settings window from the menu bar dropdown"
    - "Settings window persists across multiple open/close cycles (not recreated each time)"
    - "Changing hideHintBar toggle in Settings takes effect on the next overlay session"
    - "Changing corrections mode in Settings takes effect on the next overlay session"
    - "Preferences survive app restart (stored in UserDefaults)"
    - "Enabling Launch at Login registers the app in System Settings Login Items"
    - "Launch at Login is enabled by default on first launch"
    - "Settings window always appears centered on screen"
  artifacts:
    - path: "App/Sources/AppPreferences.swift"
      provides: "UserDefaults-backed preferences singleton"
      contains: "hideHintBar"
    - path: "App/Sources/SettingsView.swift"
      provides: "SwiftUI Form with General, Measure, Shortcuts, About sections"
      contains: "formStyle(.grouped)"
    - path: "App/Sources/SettingsWindowController.swift"
      provides: "NSWindow lifecycle for settings (create, show, center, reuse)"
      contains: "isReleasedWhenClosed"
  key_links:
    - from: "App/Sources/AppDelegate.swift"
      to: "App/Sources/AppPreferences.swift"
      via: "reads preferences at coordinator invocation time"
      pattern: "AppPreferences\\.shared\\.(hideHintBar|corrections)"
    - from: "App/Sources/MenuBarController.swift"
      to: "App/Sources/SettingsWindowController.swift"
      via: "onOpenSettings callback"
      pattern: "onOpenSettings"
    - from: "App/Sources/SettingsView.swift"
      to: "UserDefaults"
      via: "onChange handlers persist preference changes"
      pattern: "UserDefaults\\.standard\\.set"
---

<objective>
Create the Settings window with all preferences (hideHintBar, corrections, launch at login), wire it into the menu bar and AppDelegate, and ensure preferences are read at overlay invocation time.

Purpose: Users can customize overlay behavior and system integration through a persistent settings window accessible from the menu bar.
Output: AppPreferences.swift, SettingsView.swift, SettingsWindowController.swift, plus updated AppDelegate and MenuBarController.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-settings-and-preferences/21-RESEARCH.md
@.planning/phases/21-settings-and-preferences/21-CONTEXT.md
@.planning/phases/20-menu-bar-shell/20-01-SUMMARY.md

Key existing files to read before modifying:
@App/Sources/AppDelegate.swift
@App/Sources/MenuBarController.swift
@App/Sources/Info.plist
@App/project.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppPreferences, SettingsView, and SettingsWindowController</name>
  <files>
    App/Sources/AppPreferences.swift
    App/Sources/SettingsView.swift
    App/Sources/SettingsWindowController.swift
  </files>
  <action>
Create three new files in App/Sources/:

**AppPreferences.swift:**
- `@Observable final class AppPreferences` with `static let shared` singleton
- Properties backed by UserDefaults:
  - `hideHintBar: Bool` (key: "hideHintBar", default: false)
  - `corrections: String` (key: "corrections", default: "smart")
- Each property has a computed getter reading from `UserDefaults.standard` and a setter writing to it
- Import Foundation only

**SettingsView.swift:**
- Import SwiftUI and ServiceManagement
- `struct SettingsView: View` with `@State` properties for `hideHintBar` (Bool) and `corrections` (String), initialized from UserDefaults in `init()`
- Body: `Form { ... }.formStyle(.grouped).frame(width: 480).fixedSize(horizontal: false, vertical: true)`
- 4 sections per locked user decisions:

  **Section("General"):**
  - `Toggle("Launch at Login", isOn:)` — binding reads from `SMAppService.mainApp.status == .enabled`, sets via `try? SMAppService.mainApp.register()` / `.unregister()`
  - `Toggle("Hide Hint Bar", isOn: $hideHintBar)` with `.onChange` writing to `UserDefaults.standard.set(newValue, forKey: "hideHintBar")`
  - Leave space for "Automatically Check for Updates" toggle — add a comment `// Auto-check for Updates toggle added in Plan 02 (Sparkle integration)`

  **Section("Measure"):**
  - `Picker("Border Corrections", selection: $corrections)` with `.pickerStyle(.radioGroup)`
  - Three options: `Text("Smart").tag("smart")`, `Text("Include").tag("include")`, `Text("None").tag("none")`
  - `.onChange` writing to `UserDefaults.standard.set(newValue, forKey: "corrections")`

  **Section("Shortcuts"):**
  - `Text("Shortcuts will be available in a future update.").foregroundStyle(.secondary).font(.callout)`

  **Section("About"):**
  - HStack with app icon (`Image(nsImage: NSApp.applicationIconImage).resizable().frame(width: 64, height: 64)`) and VStack with:
    - App name "Design Ruler" (.title2, .semibold)
    - Version from `Bundle.main.infoDictionary?["CFBundleShortVersionString"]` (.secondary)
    - Copyright "© 2025 Haythem Elachi. All rights reserved." (.caption, .tertiary)
  - `Link("GitHub", destination: URL(string: "https://github.com/haythem/design-ruler")!)`
  - Leave space for "Check for Updates" button — add a comment `// Check for Updates button added in Plan 02 (Sparkle integration)`

**SettingsWindowController.swift:**
- `final class SettingsWindowController`
- `private var window: NSWindow?`
- `func showSettings()`:
  - If `window` exists and `isVisible`, call `makeKeyAndOrderFront(nil)` + `NSApp.activate(ignoringOtherApps: true)` and return early
  - If `window` exists but not visible (was closed), call `updateConstraintsIfNeeded()` then `center()` then `makeKeyAndOrderFront(nil)` + `NSApp.activate(ignoringOtherApps: true)` and return
  - Otherwise create new NSWindow:
    - `contentRect: NSRect(x: 0, y: 0, width: 480, height: 600)`
    - `styleMask: [.titled, .closable]` (no resize, no miniaturize)
    - `backing: .buffered, defer: false`
    - `window.title = "Design Ruler Settings"`
    - `window.contentView = NSHostingView(rootView: SettingsView())`
    - `window.isReleasedWhenClosed = false` (CRITICAL — prevents dealloc on close)
    - `window.updateConstraintsIfNeeded()` then `window.center()` (Sequoia centering fix)
    - `window.makeKeyAndOrderFront(nil)` + `NSApp.activate(ignoringOtherApps: true)`
    - Store as `self.window`
  </action>
  <verify>
All three files exist and compile: `cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build 2>&1 | tail -5` shows BUILD SUCCEEDED.
  </verify>
  <done>
Three new files created: AppPreferences with UserDefaults-backed hideHintBar + corrections, SettingsView with 4 grouped sections (General with Login + HintBar toggles, Measure with radio buttons, Shortcuts placeholder, About with app info), SettingsWindowController with persistent NSWindow that centers on open and survives close.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire settings into MenuBarController and AppDelegate, add first-launch login</name>
  <files>
    App/Sources/MenuBarController.swift
    App/Sources/AppDelegate.swift
    App/project.yml
    App/Sources/Info.plist
  </files>
  <action>
**MenuBarController.swift — enable Settings item and add callback:**
- Add `var onOpenSettings: (() -> Void)?` callback property (same pattern as onMeasure/onAlignmentGuides)
- In `setupMenu()`, change the Settings item from disabled placeholder to active:
  - Set `action: #selector(openSettings)` (not nil)
  - Set `target = self` (remove `settingsItem.isEnabled = false`)
  - Set `keyEquivalent: ","` for Cmd+, shortcut (standard macOS Settings shortcut)
- Add `@objc private func openSettings() { onOpenSettings?() }`

**AppDelegate.swift — wire settings + read preferences:**
- Add `import ServiceManagement` at the top
- Add `private var settingsWindowController: SettingsWindowController!` property
- In `applicationDidFinishLaunching`:
  - After coordinator runMode setup, add first-launch login item registration:
    ```swift
    if !UserDefaults.standard.bool(forKey: "hasLaunchedBefore") {
        UserDefaults.standard.set(true, forKey: "hasLaunchedBefore")
        try? SMAppService.mainApp.register()
    }
    ```
  - Create `settingsWindowController = SettingsWindowController()`
  - Change `onMeasure` closure to read from AppPreferences at invocation time:
    ```swift
    menuBarController.onMeasure = {
        let prefs = AppPreferences.shared
        MeasureCoordinator.shared.run(hideHintBar: prefs.hideHintBar, corrections: prefs.corrections)
    }
    ```
  - Change `onAlignmentGuides` closure to read from AppPreferences:
    ```swift
    menuBarController.onAlignmentGuides = {
        AlignmentGuidesCoordinator.shared.run(hideHintBar: AppPreferences.shared.hideHintBar)
    }
    ```
  - Wire settings callback:
    ```swift
    menuBarController.onOpenSettings = { [weak self] in
        self?.settingsWindowController.showSettings()
    }
    ```

**project.yml — add Sparkle package reference (prepare for Plan 02):**
No changes needed in this task — Sparkle is added in Plan 02.

**Xcode project — regenerate:**
Run `cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodegen generate` to pick up the 3 new source files. xcodegen auto-discovers files under `Sources/`.

**Verify the full build:**
Run `xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build` and confirm BUILD SUCCEEDED.
  </action>
  <verify>
1. `xcodebuild` build succeeds with all new and modified files.
2. Grep confirms preferences are read at invocation time: `grep -n "AppPreferences" App/Sources/AppDelegate.swift` shows reads in onMeasure/onAlignmentGuides closures.
3. Grep confirms Settings menu item is active: `grep -n "openSettings" App/Sources/MenuBarController.swift` shows @objc method and callback.
4. Grep confirms first-launch logic: `grep -n "hasLaunchedBefore" App/Sources/AppDelegate.swift` shows UserDefaults check.
5. SPM build still passes: `cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto && swift build 2>&1 | tail -3` shows Build complete (Raycast path unaffected).
  </verify>
  <done>
Settings menu item is enabled with Cmd+, shortcut. AppDelegate reads hideHintBar and corrections from AppPreferences at each overlay invocation (not hardcoded). First-launch auto-enables launch at login via SMAppService. SettingsWindowController wired via onOpenSettings callback. Both xcodebuild and swift build pass.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild` Debug build succeeds with all 3 new files + 2 modified files
2. `swift build` (Raycast SPM path) still passes — no changes to Package.swift
3. Settings menu item has action and Cmd+, keyEquivalent (not disabled)
4. AppDelegate reads AppPreferences.shared at invocation time (not hardcoded values)
5. hasLaunchedBefore + SMAppService.mainApp.register() present in AppDelegate
6. SettingsView has 4 sections: General, Measure, Shortcuts, About
7. SettingsView uses .formStyle(.grouped) for macOS System Settings appearance
8. SettingsWindowController sets isReleasedWhenClosed = false
9. SettingsWindowController calls updateConstraintsIfNeeded() before center()
</verification>

<success_criteria>
- Settings window opens from menu bar, displays 4 grouped sections, persists across close/reopen
- hideHintBar and corrections preferences saved to UserDefaults and read by coordinators at launch time
- Launch at Login toggle reads SMAppService.mainApp.status directly (not UserDefaults)
- First launch auto-registers login item
- Both xcodebuild and swift build pass
</success_criteria>

<output>
After completion, create `.planning/phases/21-settings-and-preferences/21-01-SUMMARY.md`
</output>
