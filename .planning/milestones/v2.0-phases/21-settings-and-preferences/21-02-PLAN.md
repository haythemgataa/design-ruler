---
phase: 21-settings-and-preferences
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - App/project.yml
  - App/Sources/Info.plist
  - App/Sources/AppDelegate.swift
  - App/Sources/MenuBarController.swift
  - App/Sources/SettingsView.swift
  - App/Design Ruler.xcodeproj/project.pbxproj
autonomous: true

must_haves:
  truths:
    - "User can trigger an update check via Check for Updates in the menu bar dropdown"
    - "User can trigger an update check via Check for Updates button in the About section of Settings"
    - "User can toggle automatic update checks via a toggle in the General section of Settings"
    - "Sparkle's SPUStandardUpdaterController is initialized at app launch"
  artifacts:
    - path: "App/Sources/AppDelegate.swift"
      provides: "SPUStandardUpdaterController initialization and wiring"
      contains: "SPUStandardUpdaterController"
    - path: "App/project.yml"
      provides: "Sparkle SPM package dependency declaration"
      contains: "Sparkle"
    - path: "App/Sources/Info.plist"
      provides: "SUFeedURL and SUPublicEDKey placeholder keys"
      contains: "SUFeedURL"
  key_links:
    - from: "App/Sources/AppDelegate.swift"
      to: "Sparkle framework"
      via: "SPUStandardUpdaterController init and checkForUpdates"
      pattern: "updaterController\\.checkForUpdates"
    - from: "App/Sources/MenuBarController.swift"
      to: "App/Sources/AppDelegate.swift"
      via: "onCheckForUpdates callback"
      pattern: "onCheckForUpdates"
    - from: "App/Sources/SettingsView.swift"
      to: "SPUUpdater"
      via: "updater.checkForUpdates() and automaticallyChecksForUpdates binding"
      pattern: "updater\\.(checkForUpdates|automaticallyChecksForUpdates)"
---

<objective>
Integrate Sparkle 2 for update checking: add the SPM dependency, configure Info.plist keys, wire SPUStandardUpdaterController into AppDelegate, add "Check for Updates" to the menu bar dropdown and the About section in Settings, and add the auto-check toggle to the General section.

Purpose: Users can check for updates from both the menu bar and settings, and control whether the app checks automatically.
Output: Sparkle fully integrated with placeholder feed URL (actual appcast configured in Phase 24).
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-settings-and-preferences/21-RESEARCH.md
@.planning/phases/21-settings-and-preferences/21-CONTEXT.md
@.planning/phases/21-settings-and-preferences/21-01-SUMMARY.md

Key existing files to read before modifying:
@App/Sources/AppDelegate.swift
@App/Sources/MenuBarController.swift
@App/Sources/SettingsView.swift
@App/project.yml
@App/Sources/Info.plist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Sparkle SPM dependency and Info.plist keys</name>
  <files>
    App/project.yml
    App/Sources/Info.plist
  </files>
  <action>
**project.yml — add Sparkle package:**
Read the current project.yml. In the `packages:` section, add Sparkle as a remote SPM package:
```yaml
packages:
  DesignRuler:
    path: ../swift/DesignRuler
  Sparkle:
    url: https://github.com/sparkle-project/Sparkle
    from: "2.6.0"
```

In the target's `dependencies:` array, add Sparkle:
```yaml
dependencies:
  - package: DesignRuler
    product: DesignRulerCore
  - package: Sparkle
```

In the target's `info.properties:` section, add the Sparkle placeholder keys:
```yaml
info:
  properties:
    # ... existing properties ...
    SUFeedURL: "https://github.com/haythem/design-ruler/releases/latest/download/appcast.xml"
    SUPublicEDKey: "PLACEHOLDER_EDDSA_PUBLIC_KEY"
    SUEnableAutomaticChecks: true
```

**Info.plist — add Sparkle keys:**
Read current Info.plist. Add these keys inside the `<dict>` before the closing `</dict>`:
```xml
<key>SUFeedURL</key>
<string>https://github.com/haythem/design-ruler/releases/latest/download/appcast.xml</string>
<key>SUPublicEDKey</key>
<string>PLACEHOLDER_EDDSA_PUBLIC_KEY</string>
<key>SUEnableAutomaticChecks</key>
<true/>
```

**Regenerate Xcode project:**
Run `cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodegen generate` to pick up the new Sparkle package dependency.

**Verify the build resolves Sparkle:**
Run `xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug -resolvePackageDependencies` to fetch Sparkle. Then run `xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build 2>&1 | tail -5` to confirm BUILD SUCCEEDED.
  </action>
  <verify>
1. `grep -n "Sparkle" App/project.yml` shows package URL and dependency entry.
2. `grep -n "SUFeedURL" App/Sources/Info.plist` shows the feed URL key.
3. `xcodebuild` build succeeds with Sparkle resolved and linked.
4. `swift build` (Raycast SPM path) still passes — Sparkle is only in project.yml, not Package.swift.
  </verify>
  <done>
Sparkle 2 added as SPM dependency in project.yml. Info.plist has SUFeedURL, SUPublicEDKey (placeholder), and SUEnableAutomaticChecks. Xcode project regenerated and builds successfully with Sparkle linked. Raycast SPM build unaffected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Sparkle into AppDelegate, MenuBarController, and SettingsView</name>
  <files>
    App/Sources/AppDelegate.swift
    App/Sources/MenuBarController.swift
    App/Sources/SettingsView.swift
  </files>
  <action>
**AppDelegate.swift — add Sparkle controller:**
- Add `import Sparkle` at the top
- Add property: `private let updaterController = SPUStandardUpdaterController(startingUpdater: true, updaterDelegate: nil, userDriverDelegate: nil)`
  - NOTE: This must be a `let` property initialized inline (not in applicationDidFinishLaunching) because SPUStandardUpdaterController should start the updater early. Use `override init()` pattern if needed — research shows inline `let` works when class inherits from NSObject.
  - If the inline let doesn't compile because AppDelegate is not marked `@objc` or has init issues, use this pattern instead:
    ```swift
    private var updaterController: SPUStandardUpdaterController!

    override init() {
        updaterController = SPUStandardUpdaterController(
            startingUpdater: true,
            updaterDelegate: nil,
            userDriverDelegate: nil
        )
        super.init()
    }
    ```
- Wire the new onCheckForUpdates callback on menuBarController:
  ```swift
  menuBarController.onCheckForUpdates = { [weak self] in
      self?.updaterController.checkForUpdates(nil)
  }
  ```
- Update the onOpenSettings callback to pass the updater:
  ```swift
  menuBarController.onOpenSettings = { [weak self] in
      guard let self else { return }
      self.settingsWindowController.showSettings(updater: self.updaterController.updater)
  }
  ```

**SettingsWindowController.swift — accept SPUUpdater parameter:**
- Read the current file. Update `showSettings()` to accept `updater: SPUUpdater` parameter.
- `import Sparkle` at the top
- Pass `updater` to `SettingsView(updater: updater)` when creating the NSHostingView
- When the window already exists and is being re-shown, no need to recreate — the updater reference in the SwiftUI view is stable

**MenuBarController.swift — add Check for Updates menu item:**
- Add `var onCheckForUpdates: (() -> Void)?` callback property
- In `setupMenu()`, add a "Check for Updates\u{2026}" menu item BEFORE the Quit item (after the Settings separator):
  ```swift
  let updateItem = menu.addItem(
      withTitle: "Check for Updates\u{2026}",
      action: #selector(checkForUpdates),
      keyEquivalent: ""
  )
  updateItem.target = self
  ```
- Add `@objc private func checkForUpdates() { onCheckForUpdates?() }`

**SettingsView.swift — add Sparkle integration:**
- Add `import Sparkle` at the top
- Add `let updater: SPUUpdater` property
- Add `@State private var automaticallyChecksForUpdates: Bool` initialized from `updater.automaticallyChecksForUpdates` in init
- Update `init` to accept `updater: SPUUpdater` and initialize the new state
- In the General section, REPLACE the Plan 02 comment with the actual toggle:
  ```swift
  Toggle("Automatically Check for Updates", isOn: $automaticallyChecksForUpdates)
      .onChange(of: automaticallyChecksForUpdates) { _, newValue in
          updater.automaticallyChecksForUpdates = newValue
      }
  ```
- In the About section, REPLACE the Plan 02 comment with the actual button:
  ```swift
  Button("Check for Updates\u{2026}") {
      updater.checkForUpdates()
  }
  ```

**Verify the full build after all changes.**
  </action>
  <verify>
1. `xcodebuild` Debug build succeeds with all Sparkle-wired files.
2. `grep -n "import Sparkle" App/Sources/AppDelegate.swift App/Sources/SettingsView.swift App/Sources/SettingsWindowController.swift` confirms Sparkle is imported in all three.
3. `grep -n "SPUStandardUpdaterController" App/Sources/AppDelegate.swift` confirms updater controller created.
4. `grep -n "onCheckForUpdates" App/Sources/MenuBarController.swift` confirms callback and menu item.
5. `grep -n "checkForUpdates\|automaticallyChecksForUpdates" App/Sources/SettingsView.swift` confirms both the button and toggle.
6. `swift build` (Raycast SPM path) still passes.
7. No Plan 02 placeholder comments remain in SettingsView.swift: `grep -c "Plan 02" App/Sources/SettingsView.swift` returns 0.
  </verify>
  <done>
Sparkle fully wired: SPUStandardUpdaterController in AppDelegate, Check for Updates menu item in dropdown, Check for Updates button in About section, auto-check toggle in General section. Both xcodebuild and swift build pass. No placeholder comments remain.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild` Debug build succeeds with Sparkle linked
2. `swift build` (Raycast SPM path) still passes — Sparkle only in project.yml, not Package.swift
3. Menu bar dropdown has: Measure, Alignment Guides, separator, Settings..., Check for Updates..., separator, Quit
4. Settings window has "Automatically Check for Updates" toggle in General section
5. Settings window has "Check for Updates" button in About section
6. Info.plist contains SUFeedURL, SUPublicEDKey, SUEnableAutomaticChecks
7. SPUStandardUpdaterController initialized in AppDelegate with startingUpdater: true
8. No placeholder comments from Plan 01 remain in SettingsView.swift
</verification>

<success_criteria>
- Sparkle 2 SPM dependency resolves and links in xcodebuild
- Check for Updates available from both menu bar dropdown and About section in Settings
- Auto-check toggle controls updater.automaticallyChecksForUpdates
- Info.plist has placeholder SUFeedURL and SUPublicEDKey (real values in Phase 24)
- Raycast SPM build unaffected (Sparkle not in Package.swift)
</success_criteria>

<output>
After completion, create `.planning/phases/21-settings-and-preferences/21-02-SUMMARY.md`
</output>
