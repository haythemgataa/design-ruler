---
phase: 21-settings-and-preferences
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - App/Sources/SettingsView.swift
  - App/Sources/AppDelegate.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Launch at Login toggle reflects actual SMAppService registration status every time Settings window is reopened"
    - "Sparkle updater does not show an error dialog on app launch with placeholder keys"
  artifacts:
    - path: "App/Sources/SettingsView.swift"
      provides: "@State-backed Launch at Login toggle with .onAppear refresh"
      contains: "@State private var launchAtLogin"
    - path: "App/Sources/AppDelegate.swift"
      provides: "Deferred Sparkle updater startup"
      contains: "startingUpdater: false"
  key_links:
    - from: "App/Sources/SettingsView.swift"
      to: "SMAppService.mainApp.status"
      via: ".onAppear refreshing @State"
      pattern: "\\.onAppear.*launchAtLogin.*SMAppService"
    - from: "App/Sources/AppDelegate.swift"
      to: "SPUStandardUpdaterController"
      via: "startingUpdater: false defers key validation"
      pattern: "startingUpdater:\\s*false"
---

<objective>
Fix two UAT gaps from Phase 21: (1) Launch at Login toggle desync when Settings window is reopened, (2) Sparkle updater error dialog on launch caused by placeholder EdDSA key.

Purpose: Close both major UAT issues so Phase 21 can pass user acceptance testing.
Output: Two bug fixes in SettingsView.swift and AppDelegate.swift.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-settings-and-preferences/21-UAT.md
@.planning/debug/launch-at-login-toggle-desync.md
@.planning/debug/sparkle-updater-fails-to-start.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Launch at Login toggle desync with @State + .onAppear</name>
  <files>App/Sources/SettingsView.swift</files>
  <action>
The root cause: the "Launch at Login" Toggle uses a custom Binding whose get closure reads SMAppService.mainApp.status, but SMAppService.status is not observable by SwiftUI. When the Settings window is reused (not recreated), SwiftUI never re-evaluates the binding, so the toggle displays stale state.

Fix in SettingsView.swift:

1. Add a new @State property alongside the existing ones (line 8-10 area):
   ```swift
   @State private var launchAtLogin: Bool
   ```

2. In the init, initialize it from SMAppService status (add after line 16):
   ```swift
   _launchAtLogin = State(initialValue: SMAppService.mainApp.status == .enabled)
   ```

3. Replace the entire Toggle binding (lines 23-32) with a @State-backed version:
   ```swift
   Toggle("Launch at Login", isOn: $launchAtLogin)
       .onChange(of: launchAtLogin) { _, newValue in
           if newValue {
               try? SMAppService.mainApp.register()
           } else {
               try? SMAppService.mainApp.unregister()
           }
       }
   ```

4. Add .onAppear to the Form (after .formStyle(.grouped) on line 93) to refresh the state every time the Settings window becomes visible:
   ```swift
   .onAppear {
       launchAtLogin = SMAppService.mainApp.status == .enabled
   }
   ```

This ensures the toggle reads from @State (which SwiftUI can track), and .onAppear re-syncs from SMAppService every time the window appears.
  </action>
  <verify>
Build the app with `cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build 2>&1 | tail -5` — must succeed with "BUILD SUCCEEDED".

Verify the fix structure: SettingsView.swift contains `@State private var launchAtLogin`, `.onAppear`, and `$launchAtLogin` binding on the Toggle (no more inline `Binding(get:set:)`).
  </verify>
  <done>
SettingsView.swift uses @State-backed launchAtLogin with .onAppear refresh. The custom Binding(get:set:) for SMAppService is replaced. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Sparkle updater startup failure with deferred initialization</name>
  <files>App/Sources/AppDelegate.swift</files>
  <action>
The root cause: SPUStandardUpdaterController is initialized with `startingUpdater: true`, which triggers immediate EdDSA key validation. The placeholder string "PLACEHOLDER_EDDSA_PUBLIC_KEY" fails base64 decode, causing Sparkle to show an error dialog.

Fix in AppDelegate.swift:

1. Change `startingUpdater: true` to `startingUpdater: false` on line 9-13:
   ```swift
   private let updaterController = SPUStandardUpdaterController(
       startingUpdater: false,
       updaterDelegate: nil,
       userDriverDelegate: nil
   )
   ```

That is the ONLY change needed. With `startingUpdater: false`:
- Sparkle does NOT validate the EdDSA key at init time
- No error dialog appears on launch
- "Check for Updates..." menu item and button still work (they call checkForUpdates which will fail gracefully only when actually invoked, which is acceptable until Phase 24 configures real keys)
- "Automatically Check for Updates" toggle still reads/writes the preference
- Phase 24 will set real keys and can switch back to `startingUpdater: true`

Do NOT remove SUPublicEDKey from Info.plist or project.yml — Phase 24 needs the key present and will replace the placeholder value. Do NOT remove SUFeedURL either.
  </action>
  <verify>
Build the app with `cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build 2>&1 | tail -5` — must succeed with "BUILD SUCCEEDED".

Verify: AppDelegate.swift contains `startingUpdater: false`. Info.plist and project.yml still contain SUPublicEDKey and SUFeedURL (unchanged).
  </verify>
  <done>
AppDelegate.swift uses startingUpdater: false. Sparkle does not validate placeholder keys at launch. Info.plist and project.yml placeholders preserved for Phase 24. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild` build succeeds with both changes applied
2. SettingsView.swift: @State launchAtLogin + .onAppear pattern (no Binding(get:set:))
3. AppDelegate.swift: startingUpdater: false
4. Info.plist: SUPublicEDKey still present (placeholder preserved for Phase 24)
5. project.yml: SUPublicEDKey still present (placeholder preserved for Phase 24)
</verification>

<success_criteria>
- Launch at Login toggle in SettingsView is backed by @State with .onAppear refresh from SMAppService.mainApp.status
- Sparkle updater initialized with startingUpdater: false (no key validation at launch)
- Both changes compile successfully
- No other files modified (Info.plist, project.yml placeholders untouched)
</success_criteria>

<output>
After completion, create `.planning/phases/21-settings-and-preferences/21-03-SUMMARY.md`
</output>
