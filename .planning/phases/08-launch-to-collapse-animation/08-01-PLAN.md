---
phase: 08-launch-to-collapse-animation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - swift/Ruler/Sources/Rendering/HintBarView.swift
  - swift/Ruler/Sources/RulerWindow.swift
  - swift/Ruler/Sources/Ruler.swift
autonomous: false

must_haves:
  truths:
    - "On launch, the expanded hint bar (full text + keycaps) is visible"
    - "On first mouse move, the expanded bar crossfades into two collapsed bars (0.35s easeOut)"
    - "During the collapse animation, the slide animation is blocked (no overlap)"
    - "Once collapsed, the bar stays collapsed for the entire session"
    - "If Reduce Motion is enabled, the collapse is instant (no animation)"
    - "Collapsed panels do not flash at their final position before the animation starts"
  artifacts:
    - path: "swift/Ruler/Sources/Rendering/HintBarView.swift"
      provides: "animateToCollapsed() method with crossfade, isAnimatingCollapse guard"
      contains: "animateToCollapsed"
    - path: "swift/Ruler/Sources/RulerWindow.swift"
      provides: "collapseHintBar() public method forwarding to hintBarView"
      contains: "collapseHintBar"
    - path: "swift/Ruler/Sources/Ruler.swift"
      provides: "Collapse trigger in handleFirstMove()"
      contains: "collapseHintBar"
  key_links:
    - from: "swift/Ruler/Sources/Ruler.swift handleFirstMove()"
      to: "RulerWindow.collapseHintBar()"
      via: "activeWindow?.collapseHintBar() call on first mouse move"
      pattern: "collapseHintBar"
    - from: "swift/Ruler/Sources/RulerWindow.swift collapseHintBar()"
      to: "HintBarView.animateToCollapsed()"
      via: "forwards to hintBarView.animateToCollapsed()"
      pattern: "animateToCollapsed"
    - from: "HintBarView.animateToCollapsed()"
      to: "HintBarView.updatePosition()"
      via: "isAnimatingCollapse guard blocks slide during collapse"
      pattern: "isAnimatingCollapse"
---

<objective>
Add the animated crossfade from the expanded hint bar to the collapsed two-section layout, triggered on first mouse move.

Purpose: The expanded bar shows instructional text useful on launch. Once the user moves the mouse (begins inspection), the bar collapses into two compact keycap-only panels via a 0.35s opacity crossfade. This is the final phase of the v1.1 hint bar redesign.

Output: animateToCollapsed() in HintBarView with NSAnimationContext crossfade, collapseHintBar() in RulerWindow, trigger in Ruler.handleFirstMove(). Accessibility-aware (instant toggle when Reduce Motion enabled).
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-launch-to-collapse-animation/08-RESEARCH.md
@.planning/phases/07-hint-bar-visual-redesign/07-02-SUMMARY.md
@swift/Ruler/Sources/Rendering/HintBarView.swift
@swift/Ruler/Sources/RulerWindow.swift
@swift/Ruler/Sources/Ruler.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add animateToCollapsed() and wire trigger through RulerWindow and Ruler</name>
  <files>
    swift/Ruler/Sources/Rendering/HintBarView.swift
    swift/Ruler/Sources/RulerWindow.swift
    swift/Ruler/Sources/Ruler.swift
  </files>
  <action>
**HintBarView.swift -- Add collapse animation:**

1. Add property alongside existing animation state:
```swift
private var isAnimatingCollapse = false
```

2. Add `animateToCollapsed()` public method. This crossfades: expanded panel fades out, collapsed panels fade in. All synchronized via NSAnimationContext.runAnimationGroup:

```swift
func animateToCollapsed(duration: TimeInterval = 0.35) {
    guard currentBarState == .expanded else { return }
    guard !isAnimatingCollapse else { return }
    isAnimatingCollapse = true

    // Accessibility: instant toggle if reduce motion is enabled
    if NSWorkspace.shared.accessibilityDisplayShouldReduceMotion {
        setBarState(.collapsed)
        isAnimatingCollapse = false
        return
    }

    // Set collapsed panels visible but fully transparent BEFORE unhiding
    // (prevents single-frame flash at final position -- Pitfall 3 from research)
    leftCollapsedPanel?.alphaValue = 0
    rightCollapsedPanel?.alphaValue = 0
    leftCollapsedPanel?.isHidden = false
    rightCollapsedPanel?.isHidden = false

    NSAnimationContext.runAnimationGroup({ context in
        context.duration = duration
        context.timingFunction = CAMediaTimingFunction(name: .easeOut)
        context.allowsImplicitAnimation = true

        // Fade out expanded bar
        self.glassPanel?.animator().alphaValue = 0

        // Fade in collapsed bars
        self.leftCollapsedPanel?.animator().alphaValue = 1
        self.rightCollapsedPanel?.animator().alphaValue = 1
    }, completionHandler: { [weak self] in
        guard let self else { return }
        self.glassPanel?.isHidden = true
        self.glassPanel?.alphaValue = 1  // reset for potential reuse
        self.currentBarState = .collapsed
        self.isAnimatingCollapse = false
    })
}
```

3. Guard `updatePosition()` against collapse animation overlap. Add at the top of `updatePosition(cursorY:screenHeight:)`, before any existing logic:
```swift
guard !isAnimatingCollapse else { return }
```
This prevents the slide animation from fighting the collapse crossfade (Pitfall 2 from research). The collapse is 0.35s, so missing one position update is acceptable.

**RulerWindow.swift -- Add collapseHintBar() method:**

Add a public method that forwards to the hint bar. Place it near the existing `showInitialState()` method:
```swift
func collapseHintBar() {
    guard hintBarView.superview != nil else { return }
    hintBarView.animateToCollapsed()
}
```

**Ruler.swift -- Wire collapse trigger in handleFirstMove():**

Update `handleFirstMove()` to trigger the collapse on first mouse move. The expanded bar has served its purpose (user has read the instructions). Add the collapse call after `firstMoveReceived = true`:

```swift
private func handleFirstMove() {
    firstMoveReceived = true
    // Collapse hint bar from expanded (instructional text) to compact keycap-only bars
    activeWindow?.collapseHintBar()
}
```

Note: `activeWindow` is already set before `handleFirstMove()` fires (set during window creation in `run()`). The `collapseHintBar()` call is safe because it guards `hintBarView.superview != nil` (handles `hideHintBar = true` case where hint bar was never added).

**Multi-monitor consideration:** Only the cursor screen's window has a hint bar (other windows pass `hideHintBar: true`). So `activeWindow?.collapseHintBar()` only affects the correct window. If the user moves to another screen and back, `activate(firstMoveAlreadyReceived:)` does NOT re-expand the bar -- once collapsed, it stays collapsed.
  </action>
  <verify>
```bash
cd /Users/haythem/Developer/design-ruler/swift/Ruler && swift build 2>&1 | tail -20
```
Verify animation method exists:
```bash
grep -n "animateToCollapsed\|isAnimatingCollapse\|collapseHintBar" /Users/haythem/Developer/design-ruler/swift/Ruler/Sources/Rendering/HintBarView.swift /Users/haythem/Developer/design-ruler/swift/Ruler/Sources/RulerWindow.swift /Users/haythem/Developer/design-ruler/swift/Ruler/Sources/Ruler.swift
```
Verify reduce motion check:
```bash
grep -n "accessibilityDisplayShouldReduceMotion" /Users/haythem/Developer/design-ruler/swift/Ruler/Sources/Rendering/HintBarView.swift
```
  </verify>
  <done>
animateToCollapsed() exists in HintBarView with NSAnimationContext crossfade (expanded fades out, collapsed fades in, 0.35s easeOut). isAnimatingCollapse guards updatePosition() against overlap. collapseHintBar() exists in RulerWindow. handleFirstMove() in Ruler.swift triggers collapse on first mouse move. Reduce Motion check falls back to instant setBarState(.collapsed). Swift builds clean.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify collapse animation visually</name>
  <files>
    swift/Ruler/Sources/Rendering/HintBarView.swift
    swift/Ruler/Sources/RulerWindow.swift
    swift/Ruler/Sources/Ruler.swift
  </files>
  <action>
Human verification of the collapse animation. Build with `ray build -e .` and test in Raycast.

**What was built:** Animated crossfade from expanded hint bar to two collapsed keycap-only bars, triggered on first mouse move after launch.

**How to verify:**
1. Build the extension: `ray build -e .` in the project root
2. Open Raycast, invoke the Ruler extension
3. **On launch:** The expanded hint bar (full text + keycaps) should be visible at the bottom with glass background
4. **Move the mouse:** The expanded bar should fade out while the two collapsed bars (left: arrows+shift, right: ESC) fade in simultaneously. Duration ~0.35s, smooth easeOut.
5. **After collapse:** Only the two compact keycap-only bars remain. They should not re-expand.
6. **Slide animation:** Move cursor to the bottom of the screen -- the collapsed bars should slide to the top. Move away -- they slide back to the bottom.
7. **Key presses:** Arrow keys and shift should still animate keycap presses in the collapsed bars.
8. **No flash:** When the collapsed bars appear, there should be NO single-frame flash of them at full opacity before the animation starts.
9. **Multi-monitor (if available):** Move cursor to another screen and back -- the hint bar should stay collapsed on the original screen.
10. **hideHintBar preference:** If set to true in Raycast preferences, no hint bar should appear at all (no crash).

**Resume signal:** Type "approved" if the collapse animation looks smooth and correct, or describe issues.
  </action>
  <verify>User confirms collapse animation is smooth, no flash, slide still works after collapse.</verify>
  <done>Collapse animation visually verified: expanded bar fades out, collapsed bars fade in on first mouse move. No flash, no overlap with slide animation. Keycap press animations work in collapsed state.</done>
</task>

</tasks>

<verification>
- `swift build` passes with no errors
- animateToCollapsed() in HintBarView uses NSAnimationContext.runAnimationGroup
- Expanded panel fades to alphaValue 0, collapsed panels fade from 0 to 1
- isAnimatingCollapse guards both animateToCollapsed() re-entry and updatePosition()
- collapseHintBar() in RulerWindow checks hintBarView.superview != nil
- handleFirstMove() in Ruler.swift calls activeWindow?.collapseHintBar()
- Reduce Motion accessibility check performs instant setBarState(.collapsed)
- Collapsed panels have alphaValue set to 0 before isHidden = false (no flash)
- Completion handler resets glassPanel alphaValue to 1 and sets currentBarState
</verification>

<success_criteria>
On launch, the expanded hint bar is visible. On first mouse move, it crossfades smoothly (0.35s) into two collapsed keycap-only bars. No flash, no overlap with slide animation. Once collapsed, stays collapsed. Reduce Motion users get instant transition. v1.1 Hint Bar Redesign milestone is complete.
</success_criteria>

<output>
After completion, create `.planning/phases/08-launch-to-collapse-animation/08-01-SUMMARY.md`
</output>
