---
phase: 07-hint-bar-visual-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - swift/Ruler/Sources/Rendering/HintBarView.swift
  - swift/Ruler/Sources/Rendering/HintBarContent.swift
autonomous: false

must_haves:
  truths:
    - "Hint bar expanded panel has frosted glass background (NSVisualEffectView blur visible over frozen screenshot)"
    - "No solid opaque SwiftUI backgrounds remain on MainHintCard or ExtraHintCard"
    - "Arrow keycaps are 26x11, shift keycap is 40x25, ESC keycap is 32x25"
    - "Hint bar slide animation still works (bottom to top and back)"
    - "Key press animations still work on all keycaps"
  artifacts:
    - path: "swift/Ruler/Sources/Rendering/HintBarView.swift"
      provides: "NSVisualEffectView glass panel wrapping SwiftUI content"
      contains: "NSVisualEffectView"
    - path: "swift/Ruler/Sources/Rendering/HintBarContent.swift"
      provides: "Updated keycap dimensions, removed solid backgrounds"
  key_links:
    - from: "HintBarView.swift"
      to: "HintBarContent.swift"
      via: "NSHostingView<HintBarContent> hosted inside NSVisualEffectView"
      pattern: "NSHostingView.*HintBarContent"
---

<objective>
Add NSVisualEffectView glass background to the expanded hint bar and update keycap dimensions to new sizes.

Purpose: The hint bar currently has solid opaque SwiftUI backgrounds. This plan replaces them with a frosted glass panel using NSVisualEffectView (.withinWindow, .hudWindow), which blurs the frozen screenshot visible through the bar. It also updates all keycap sizes to the new design spec (arrows 26x11, shift 40x25, ESC 32x25). This is the foundation for the collapsed layout work in Plan 02.

Output: HintBarView wraps its SwiftUI content inside an NSVisualEffectView glass panel. HintBarContent has no solid backgrounds. Keycaps use new dimensions with adjusted font sizes and spacing.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-hint-bar-visual-redesign/07-RESEARCH.md
@swift/Ruler/Sources/Rendering/HintBarView.swift
@swift/Ruler/Sources/Rendering/HintBarContent.swift
@swift/Ruler/Sources/RulerWindow.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NSVisualEffectView glass panel and update keycap dimensions</name>
  <files>
    swift/Ruler/Sources/Rendering/HintBarView.swift
    swift/Ruler/Sources/Rendering/HintBarContent.swift
  </files>
  <action>
**HintBarView.swift — Glass panel infrastructure:**

Replace the current `setupHostingView()` method. Instead of adding `NSHostingView` directly as a subview, create a glass panel hierarchy:

1. Create a `makeGlassPanel()` private method that returns an `NSVisualEffectView`:
   ```swift
   private func makeGlassPanel() -> NSVisualEffectView {
       let vev = NSVisualEffectView()
       vev.blendingMode = .withinWindow   // blur window content (the frozen screenshot)
       vev.material = .hudWindow           // dark translucent HUD material
       vev.state = .active                 // always active, ignore window focus changes
       vev.wantsLayer = true
       vev.layer?.cornerRadius = 18
       vev.layer?.cornerCurve = .continuous // squircle corners matching existing SwiftUI style
       vev.layer?.masksToBounds = true
       return vev
   }
   ```

2. Rework `setupHostingView()` to create the glass panel, put the `NSHostingView<HintBarContent>` inside it, and add the glass panel as the subview:
   ```swift
   private func setupHostingView() {
       let glass = makeGlassPanel()
       self.glassPanel = glass
       addSubview(glass)

       let content = HintBarContent(state: state)
       let hosting = NSHostingView(rootView: content)
       hosting.autoresizingMask = [.width, .height]
       glass.addSubview(hosting)
       self.hostingView = hosting
   }
   ```

3. Add `private var glassPanel: NSVisualEffectView?` property alongside the existing `hostingView` property.

4. In `configure(screenWidth:screenHeight:)`, after computing fittingSize from the hosting view, set the glass panel frame to match bounds (same as hosting view currently does):
   ```swift
   func configure(screenWidth: CGFloat, screenHeight: CGFloat) {
       guard let hosting = hostingView, let glass = glassPanel else { return }
       let size = hosting.fittingSize
       let viewX = floor((screenWidth - size.width) / 2)
       frame = NSRect(x: viewX, y: barMargin, width: size.width, height: size.height)
       glass.frame = bounds
       hosting.frame = glass.bounds
       isAtBottom = true
   }
   ```

**IMPORTANT — Fallback handling:** If `.withinWindow` blending does NOT correctly blur the screenshot (shows black/gray instead of blurred screenshot content), the screenshot background in RulerWindow is set via `bgView.layer?.contents = cgImage`. The `CABackdropLayer` inside NSVisualEffectView may not sample `layer.contents` CGImage. If this happens during testing:
- **Fallback A:** Change `setBackground()` in RulerWindow.swift to use `NSImageView` instead of `layer.contents`. This forces AppKit's rendering pipeline which `CABackdropLayer` can sample. However, DO NOT implement this fallback preemptively — only if glass appears black/gray.

**HintBarContent.swift — Remove solid backgrounds and update keycap sizes:**

1. **Remove MainHintCard `.background()` and `.overlay()`:** Delete the entire `.background(RoundedRectangle(...).fill(...).shadow(...))` and the `.overlay(RoundedRectangle(...).strokeBorder(...))` modifiers from MainHintCard's body. The glass panel now provides the background. Keep the `.padding(.horizontal, 16)` and `.padding(.vertical, 14)` — these control inner spacing.

2. **Remove ExtraHintCard `.background()` and `.overlay()`:** Same treatment. Delete both `.background(UnevenRoundedRectangle(...).fill(...).shadow(...))` and `.overlay(UnevenRoundedRectangle(...).strokeBorder(...))`. Keep `.padding(8)`.

3. **Update ArrowCluster keycap dimensions:**
   - Change `capW` from `20` to `26`
   - Change `capH` from `16` to `11`
   - Adjust `vGap` from `3` to `2` (tighter vertical gap for shorter keycaps)
   - Adjust arrow symbol font from `size: 9` to `size: 7` (proportionally scaled for 11pt height)
   - Remove the `.offset(y: 2)` on the up arrow keycap (or adjust to `1`) — with 11pt height, the 2pt offset may be too much

4. **Update shift keycap:** Change `width: 32, height: 20` to `width: 40, height: 25` in MainHintCard. Increase symbolFont size from `14` to `16` (larger keycap can accommodate larger symbol).

5. **Update ESC keycap:** Change `height: 20` to `height: 25` in ExtraHintCard. Keep width at 32. Increase symbolFont from `12` to `13`.

6. **Verify the KeyCap view itself needs no changes** — it uses the width/height parameters passed in, so the dimensional changes flow through automatically. The `shadowOffset` of 2 should still work at the new sizes.
  </action>
  <verify>
Build the Swift package to confirm no compilation errors:
```bash
cd swift/Ruler && swift build 2>&1 | tail -20
```
Verify NSVisualEffectView is used in HintBarView:
```bash
grep -n "NSVisualEffectView" swift/Ruler/Sources/Rendering/HintBarView.swift
```
Verify no solid backgrounds remain in content views:
```bash
grep -n "\.background(" swift/Ruler/Sources/Rendering/HintBarContent.swift
```
The last grep should return zero matches (no `.background()` modifiers in HintBarContent.swift).
  </verify>
  <done>
HintBarView wraps SwiftUI content in NSVisualEffectView glass panel with .withinWindow/.hudWindow. HintBarContent has zero .background() modifiers on MainHintCard or ExtraHintCard. Arrow keycaps are 26x11, shift is 40x25, ESC is 32x25. Swift builds clean.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify glass background and keycap sizing</name>
  <files>swift/Ruler/Sources/Rendering/HintBarView.swift, swift/Ruler/Sources/Rendering/HintBarContent.swift</files>
  <action>
Human verification of visual output. Build the extension with `ray build -e .` and test in Raycast.

**What was built:** Glass background on expanded hint bar using NSVisualEffectView, new keycap dimensions (arrows 26x11, shift 40x25, ESC 32x25), removed solid SwiftUI backgrounds.

**How to verify:**
1. Open Raycast, invoke the Ruler extension
2. Look at the hint bar at the bottom of the screen:
   - **Glass effect:** The bar should have a frosted/blurred glass appearance showing the screenshot content behind it (not a solid opaque background). If it appears solid gray/black, the `.withinWindow` blending is not sampling the screenshot — report this for fallback implementation.
   - **Keycap sizes:** Arrow keys should be wider and shorter than before. Shift key should be noticeably wider (40pt). ESC key should be taller (25pt). Symbols should be readable within the keycaps.
   - **Layout:** The text + keycaps should be properly spaced without overflow or clipping.
3. Move cursor near the bottom to trigger slide animation — bar should slide to top and back smoothly.
4. Press arrow keys — keycap press animations should still work.
5. Test in both dark and light mode (System Preferences > Appearance) — glass material should adapt.

**Resume signal:** Type "approved" if glass and keycaps look good, or describe issues (e.g., "glass shows black", "arrow symbols too small", "layout clipped").
  </action>
  <verify>User confirms visual output matches expectations.</verify>
  <done>Glass background visible over frozen screenshot. Keycaps at new sizes. Layout not clipped. Slide and keypress animations functional.</done>
</task>

</tasks>

<verification>
- `swift build` passes with no errors
- NSVisualEffectView with `.withinWindow` and `.hudWindow` is present in HintBarView.swift
- No `.background()` modifiers remain on MainHintCard or ExtraHintCard in HintBarContent.swift
- ArrowCluster uses capW=26, capH=11
- Shift keycap uses width=40, height=25
- ESC keycap uses width=32, height=25
- Hint bar still positions correctly at bottom center and slides to top
</verification>

<success_criteria>
Hint bar displays with frosted glass background over the frozen screenshot. All keycaps render at their new sizes with readable symbols. Slide animation and key press animations still function. No solid opaque backgrounds visible on the hint bar cards.
</success_criteria>

<output>
After completion, create `.planning/phases/07-hint-bar-visual-redesign/07-01-SUMMARY.md`
</output>
