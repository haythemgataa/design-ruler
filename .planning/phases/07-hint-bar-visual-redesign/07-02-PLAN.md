---
phase: 07-hint-bar-visual-redesign
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - swift/Ruler/Sources/Rendering/HintBarView.swift
  - swift/Ruler/Sources/Rendering/HintBarContent.swift
autonomous: false

must_haves:
  truths:
    - "Collapsed left bar shows arrow cluster + shift keycap in a glass panel"
    - "Collapsed right bar shows ESC keycap in a glass panel with reddish tint overlay"
    - "BarState enum exists with .expanded and .collapsed cases"
    - "setBarState(.collapsed) hides expanded bar and shows collapsed bars (no animation)"
    - "setBarState(.expanded) shows expanded bar and hides collapsed bars (no animation)"
    - "ESC tint adapts to dark/light mode"
  artifacts:
    - path: "swift/Ruler/Sources/Rendering/HintBarView.swift"
      provides: "BarState enum, collapsed glass panels, ESC tint layer, setBarState() method"
      contains: "BarState"
    - path: "swift/Ruler/Sources/Rendering/HintBarContent.swift"
      provides: "CollapsedLeftContent and CollapsedRightContent SwiftUI views"
      contains: "CollapsedLeftContent"
  key_links:
    - from: "HintBarView.swift setBarState()"
      to: "collapsed left/right glass panels"
      via: "isHidden toggle on panel views"
      pattern: "isHidden"
    - from: "HintBarView.swift escTintLayer"
      to: "viewDidChangeEffectiveAppearance"
      via: "appearance callback updates tint color"
      pattern: "viewDidChangeEffectiveAppearance"
---

<objective>
Add collapsed two-section layout (arrows+shift left, ESC right) with glass panels, ESC reddish tint, and BarState enum for non-animated state switching.

Purpose: This plan builds the collapsed hint bar visual state: two independent glass panels (left with arrows+shift keycaps, right with ESC keycap and reddish tint). It adds a BarState enum (.expanded, .collapsed) with a `setBarState()` method that toggles visibility without animation. Phase 8 will replace the visibility toggle with animated transitions.

Output: Two collapsed glass panels positioned correctly, ESC tint overlay adapting to dark/light mode, BarState enum with non-animated toggle. The expanded bar from Plan 01 remains the default visible state.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-hint-bar-visual-redesign/07-RESEARCH.md
@.planning/phases/07-hint-bar-visual-redesign/07-01-SUMMARY.md
@swift/Ruler/Sources/Rendering/HintBarView.swift
@swift/Ruler/Sources/Rendering/HintBarContent.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add collapsed SwiftUI content views</name>
  <files>swift/Ruler/Sources/Rendering/HintBarContent.swift</files>
  <action>
Add two new SwiftUI views at the bottom of HintBarContent.swift (after ExtraHintCard, before ArrowCluster):

**CollapsedLeftContent** — keycaps only, no text:
```swift
struct CollapsedLeftContent: View {
    @ObservedObject var state: HintBarState

    var body: some View {
        HStack(spacing: 6) {
            ArrowCluster(state: state)
            KeyCap(.shift, symbol: "\u{21E7}", width: 40, height: 25,
                   symbolFont: .system(size: 16, weight: .bold, design: .rounded),
                   symbolTracking: -0.2, align: .bottomLeading, state: state)
        }
        .padding(.horizontal, 10)
        .padding(.vertical, 8)
        // NO .background() — glass panel provides this
    }
}
```

**CollapsedRightContent** — ESC keycap only, no text:
```swift
struct CollapsedRightContent: View {
    @ObservedObject var state: HintBarState

    var body: some View {
        KeyCap(.esc, symbol: "esc", width: 32, height: 25,
               symbolFont: .system(size: 13, weight: .bold, design: .rounded),
               symbolTracking: -0.2, align: .center, state: state)
            .padding(.horizontal, 10)
            .padding(.vertical, 8)
        // NO .background() — glass panel provides this
        // Reddish tint applied at the AppKit layer (escTintLayer on NSVisualEffectView)
    }
}
```

**IMPORTANT:** Both views must be `internal` (not `private`) so HintBarView.swift can reference them via NSHostingView. Remove the `private` access modifier from ArrowCluster and KeyCap if they are currently private (they need to be accessible from both content views — check if they are already internal or if CollapsedLeftContent can access them since they're in the same file). Since all these structs are in the same file, `private` (file-private) is fine — they can all see each other. So ArrowCluster and KeyCap can stay `private` to the file. But CollapsedLeftContent and CollapsedRightContent must NOT be `private` — make them `internal` (no access modifier keyword) so HintBarView.swift can use them.

Wait — ArrowCluster and KeyCap are `private struct` in HintBarContent.swift. CollapsedLeftContent and CollapsedRightContent are in the same file, so they can access them. But CollapsedLeftContent itself needs to be visible from HintBarView.swift. So:
- `CollapsedLeftContent`: internal (no keyword)
- `CollapsedRightContent`: internal (no keyword)
- `ArrowCluster`: keep `private` (file scope, both HintBarContent and Collapsed views can access it)
- `KeyCap`: keep `private` (same reason)

The keycap dimensions and font sizes should match Plan 01's updated values (arrows 26x11, shift 40x25 with font 16, ESC 32x25 with font 13).
  </action>
  <verify>
```bash
cd swift/Ruler && swift build 2>&1 | tail -20
```
Verify the new views exist:
```bash
grep -n "CollapsedLeftContent\|CollapsedRightContent" swift/Ruler/Sources/Rendering/HintBarContent.swift
```
  </verify>
  <done>
CollapsedLeftContent shows ArrowCluster + shift keycap in an HStack. CollapsedRightContent shows ESC keycap. Both have padding but no solid backgrounds. Both are internal access for cross-file use.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add collapsed glass panels, ESC tint, and BarState enum to HintBarView</name>
  <files>swift/Ruler/Sources/Rendering/HintBarView.swift</files>
  <action>
**Add BarState enum** at the top of HintBarView (inside the class, alongside KeyID):

```swift
enum BarState {
    case expanded   // full text + keycaps (default, shown on launch)
    case collapsed  // keycaps only, two separate bars
}
```

**Add collapsed panel properties** alongside the existing `glassPanel` and `hostingView`:

```swift
private var leftCollapsedPanel: NSVisualEffectView?
private var leftHostingView: NSHostingView<CollapsedLeftContent>?
private var rightCollapsedPanel: NSVisualEffectView?
private var rightHostingView: NSHostingView<CollapsedRightContent>?
private var escTintLayer = CALayer()
private var currentBarState: BarState = .expanded
```

**Create collapsed panels in `setupHostingView()`** — after creating the expanded glass panel, create the two collapsed panels:

```swift
// Left collapsed panel (arrows + shift)
let leftGlass = makeGlassPanel()
leftGlass.layer?.cornerRadius = 14  // smaller radius for compact bars
self.leftCollapsedPanel = leftGlass
addSubview(leftGlass)

let leftContent = NSHostingView(rootView: CollapsedLeftContent(state: state))
leftContent.autoresizingMask = [.width, .height]
leftGlass.addSubview(leftContent)
self.leftHostingView = leftContent

// Right collapsed panel (ESC)
let rightGlass = makeGlassPanel()
rightGlass.layer?.cornerRadius = 14
self.rightCollapsedPanel = rightGlass
addSubview(rightGlass)

let rightContent = NSHostingView(rootView: CollapsedRightContent(state: state))
rightContent.autoresizingMask = [.width, .height]
rightGlass.addSubview(rightContent)
self.rightHostingView = rightContent

// ESC tint overlay on right panel
setupEscTint()

// Start with collapsed panels hidden
leftGlass.isHidden = true
rightGlass.isHidden = true
```

**ESC tint layer setup:**

```swift
private func setupEscTint() {
    escTintLayer.cornerRadius = 14  // match collapsed bar radius
    escTintLayer.cornerCurve = .continuous
    rightCollapsedPanel?.layer?.addSublayer(escTintLayer)
    updateEscTint()
}

private func updateEscTint() {
    let isDark = effectiveAppearance.bestMatch(from: [.darkAqua, .aqua]) == .darkAqua
    escTintLayer.backgroundColor = isDark
        ? CGColor(srgbRed: 1.0, green: 0.3, blue: 0.3, alpha: 0.08)
        : CGColor(srgbRed: 0.9, green: 0.2, blue: 0.2, alpha: 0.06)
}

override func viewDidChangeEffectiveAppearance() {
    super.viewDidChangeEffectiveAppearance()
    updateEscTint()
}
```

**Layout collapsed panels in `configure()`** — after setting the expanded frame, compute collapsed positions:

```swift
// Layout collapsed panels
let gap: CGFloat = 24
if let leftHosting = leftHostingView, let leftGlass = leftCollapsedPanel,
   let rightHosting = rightHostingView, let rightGlass = rightCollapsedPanel {
    let leftSize = leftHosting.fittingSize
    let rightSize = rightHosting.fittingSize
    let totalWidth = leftSize.width + gap + rightSize.width
    let startX = floor((screenWidth - totalWidth) / 2)

    leftGlass.frame = NSRect(x: startX, y: barMargin, width: leftSize.width, height: leftSize.height)
    leftHosting.frame = leftGlass.bounds

    rightGlass.frame = NSRect(x: startX + leftSize.width + gap, y: barMargin, width: rightSize.width, height: rightSize.height)
    rightHosting.frame = rightGlass.bounds
    escTintLayer.frame = rightGlass.bounds
}
```

**IMPORTANT:** The collapsed panels need their own Y position tracking for the slide animation. For now, store the Y offset with the expanded bar. The `updatePosition()` method should move ALL visible panels (expanded or collapsed) together. Update `animateSlide()` to animate whichever panels are currently visible.

**Add `setBarState()` public method** — non-animated visibility toggle:

```swift
func setBarState(_ newState: BarState) {
    guard newState != currentBarState else { return }
    currentBarState = newState
    switch newState {
    case .expanded:
        glassPanel?.isHidden = false
        leftCollapsedPanel?.isHidden = true
        rightCollapsedPanel?.isHidden = true
    case .collapsed:
        glassPanel?.isHidden = true
        leftCollapsedPanel?.isHidden = false
        rightCollapsedPanel?.isHidden = false
    }
}
```

**Update `updatePosition()` and `animateSlide()`** — The slide animation currently moves the entire HintBarView frame. Since all panels (expanded + collapsed) are subviews of HintBarView, moving the HintBarView frame moves everything. This means the existing animation code works as-is for the collapsed state too — the HintBarView is the container that slides, and whichever panels are visible inside it will slide with it.

However, the HintBarView's frame must be large enough to contain BOTH the expanded and collapsed panels. Update `configure()` to compute the frame as the union of expanded and collapsed bounds:
- The frame width should be `max(expandedWidth, collapsedTotalWidth + gap)`
- Actually simpler: set HintBarView frame to the full screen width, and position panels within it. This avoids recalculating the container on state change.

**Revised approach for the container frame:** Set HintBarView's frame to span the full screen width (x=0, width=screenWidth) and the height of the tallest panel. Position all glass panels (expanded centered, collapsed centered) within this full-width container. The x-centering logic moves into the panel frames, not the HintBarView frame.

```swift
func configure(screenWidth: CGFloat, screenHeight: CGFloat) {
    guard let hosting = hostingView, let glass = glassPanel else { return }
    let expandedSize = hosting.fittingSize

    // Container spans full screen width, height is tallest panel
    var maxHeight = expandedSize.height

    // Compute collapsed layout
    if let leftHosting = leftHostingView, let rightHosting = rightHostingView {
        let leftSize = leftHosting.fittingSize
        let rightSize = rightHosting.fittingSize
        maxHeight = max(maxHeight, max(leftSize.height, rightSize.height))
    }

    frame = NSRect(x: 0, y: barMargin, width: screenWidth, height: maxHeight)

    // Center expanded panel within container
    let expandedX = floor((screenWidth - expandedSize.width) / 2)
    glass.frame = NSRect(x: expandedX, y: 0, width: expandedSize.width, height: expandedSize.height)
    hosting.frame = glass.bounds

    // Center collapsed panels within container
    let gap: CGFloat = 24
    if let leftHosting = leftHostingView, let leftGlass = leftCollapsedPanel,
       let rightHosting = rightHostingView, let rightGlass = rightCollapsedPanel {
        let leftSize = leftHosting.fittingSize
        let rightSize = rightHosting.fittingSize
        let totalWidth = leftSize.width + gap + rightSize.width
        let startX = floor((screenWidth - totalWidth) / 2)

        leftGlass.frame = NSRect(x: startX, y: 0, width: leftSize.width, height: leftSize.height)
        leftHosting.frame = leftGlass.bounds

        rightGlass.frame = NSRect(x: startX + leftSize.width + gap, y: 0, width: rightSize.width, height: rightSize.height)
        rightHosting.frame = rightGlass.bounds
        escTintLayer.frame = rightGlass.bounds
    }

    isAtBottom = true
}
```

The slide animation operates on HintBarView's frame/layer position, so it moves the entire container including all panels. No changes needed to `animateSlide()`.

**hitTest must remain nil** — already returns nil, preventing mouse event interception. No change needed.
  </action>
  <verify>
```bash
cd swift/Ruler && swift build 2>&1 | tail -20
```
Verify BarState enum and setBarState method exist:
```bash
grep -n "BarState\|setBarState\|escTintLayer\|CollapsedLeft\|CollapsedRight" swift/Ruler/Sources/Rendering/HintBarView.swift
```
Verify ESC tint updates on appearance change:
```bash
grep -n "viewDidChangeEffectiveAppearance\|updateEscTint" swift/Ruler/Sources/Rendering/HintBarView.swift
```
  </verify>
  <done>
BarState enum with .expanded/.collapsed cases exists. setBarState() toggles visibility of expanded vs collapsed panels. Two collapsed glass panels (left: arrows+shift, right: ESC) positioned with 24px gap. ESC tint layer adapts to dark/light mode via viewDidChangeEffectiveAppearance. Collapsed panels start hidden (expanded is default). Swift builds clean.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify collapsed layout and ESC tint</name>
  <files>swift/Ruler/Sources/Rendering/HintBarView.swift, swift/Ruler/Sources/Rendering/HintBarContent.swift</files>
  <action>
Human verification of collapsed layout visual output. Build with `ray build -e .` and test in Raycast.

**What was built:** Two-section collapsed hint bar (left: arrows+shift, right: ESC with reddish tint), BarState enum with non-animated toggle. Both expanded and collapsed states have glass backgrounds.

**How to verify:**
1. Open Raycast, invoke the Ruler extension — expanded hint bar should appear as in Plan 01 (glass background).
2. To test collapsed state: temporarily add `hintBarView.setBarState(.collapsed)` after `hv.configure(...)` in RulerWindow.swift `setupViews()`. Rebuild and relaunch.
   - **Left bar:** Should show arrow cluster + shift keycap in a small glass panel.
   - **Right bar:** Should show ESC keycap in a small glass panel with a subtle reddish tint overlay.
   - **Gap:** ~24px gap between left and right bars.
   - **Position:** Both bars centered horizontally at the bottom.
3. Test cursor near bottom — bars should slide to top position together.
4. Test in dark and light mode — glass material and ESC tint should adapt.
5. Press arrow keys and shift — keycap press animations should work in collapsed bars.
6. **Remove the temporary `.collapsed` line** after testing (default should be `.expanded`).

**Resume signal:** Type "approved" if both states look correct, or describe issues (e.g., "ESC tint too strong", "left bar clipped", "slide animation broken for collapsed bars").
  </action>
  <verify>User confirms both expanded and collapsed states render correctly.</verify>
  <done>Both bar states display correctly with glass backgrounds. Collapsed bars show keycaps only with correct sizing. ESC tint visible in collapsed right bar. Slide animation and keypress animations work in both states.</done>
</task>

</tasks>

<verification>
- `swift build` passes with no errors
- BarState enum has .expanded and .collapsed cases
- setBarState() toggles isHidden on expanded vs collapsed panels
- CollapsedLeftContent has ArrowCluster + shift keycap
- CollapsedRightContent has ESC keycap
- escTintLayer has reddish background color
- viewDidChangeEffectiveAppearance updates ESC tint
- Collapsed panels start hidden (expanded is default)
- All panels positioned within full-width HintBarView container
</verification>

<success_criteria>
Expanded and collapsed hint bar states both render correctly with glass backgrounds. Collapsed state shows two separate glass panels (arrows+shift left, ESC+tint right) with 24px gap. ESC tint adapts to appearance. BarState toggle switches visibility without animation. Slide animation works for both states.
</success_criteria>

<output>
After completion, create `.planning/phases/07-hint-bar-visual-redesign/07-02-SUMMARY.md`
</output>
