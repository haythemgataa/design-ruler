---
phase: 11-hint-bar-multi-monitor-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - swift/Ruler/Sources/AlignmentGuides/GuideLine.swift
  - swift/Ruler/Sources/AlignmentGuides/GuideLineManager.swift
  - swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift
  - swift/Ruler/Sources/Rendering/HintBarContent.swift
  - swift/Ruler/Sources/Rendering/HintBarView.swift
autonomous: true

must_haves:
  truths:
    - "Remove state resets properly after click-to-remove (preview line reappears)"
    - "Alignment guide pill opacity matches inspect command pill opacity (1.0)"
    - "Color circle borders are 2px inactive, 3px active"
    - "Dynamic color circle uses #292929 left half and #E2E2E2 right half"
    - "Hint bar shows alignment guides content when mode is set to alignmentGuides"
    - "Hint bar collapses to [tab][space] [esc] keycaps only"
    - "Cursor types already correct: NSCursor.resizeLeftRight for vertical preview, NSCursor.resizeUpDown for horizontal preview (verified in AlignmentGuidesWindow.swift line 112 — no change needed)"
  artifacts:
    - path: "swift/Ruler/Sources/AlignmentGuides/GuideLineManager.swift"
      provides: "resetRemoveMode() method"
      contains: "resetRemoveMode"
    - path: "swift/Ruler/Sources/AlignmentGuides/GuideLine.swift"
      provides: "Pill opacity fix"
      contains: "opacity: Float = 1.0"
    - path: "swift/Ruler/Sources/Rendering/HintBarContent.swift"
      provides: "Alignment guides hint bar content views"
      contains: "HintBarMode"
    - path: "swift/Ruler/Sources/Rendering/HintBarView.swift"
      provides: "KeyID.tab, KeyID.space, mode property"
      contains: "case tab, space"
  key_links:
    - from: "swift/Ruler/Sources/AlignmentGuides/GuideLineManager.swift"
      to: "swift/Ruler/Sources/AlignmentGuides/GuideLine.swift"
      via: "resetRemoveMode sets isInRemoveMode=false and setLineVisible(true)"
      pattern: "previewLine\\.isInRemoveMode = false"
    - from: "swift/Ruler/Sources/Rendering/HintBarContent.swift"
      to: "swift/Ruler/Sources/Rendering/HintBarView.swift"
      via: "HintBarState.mode drives content variant selection"
      pattern: "state\\.mode"
---

<objective>
Polish fixes for Phases 9-10 bugs + hint bar content infrastructure for alignment guides.

Purpose: Fix critical remove-state-stuck bug that breaks core interaction, bring visual polish to parity (pill opacity, circle borders, dynamic circle colors), and prepare hint bar content views that Plan 02 will wire into windows.

Output: Fixed GuideLineManager/GuideLine, updated ColorCircleIndicator, alignment guides hint bar content in HintBarContent.swift, KeyID extensions in HintBarView.swift.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

@swift/Ruler/Sources/AlignmentGuides/GuideLine.swift
@swift/Ruler/Sources/AlignmentGuides/GuideLineManager.swift
@swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift
@swift/Ruler/Sources/Rendering/HintBarContent.swift
@swift/Ruler/Sources/Rendering/HintBarView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix remove-state-stuck bug + pill opacity + color circle polish</name>
  <files>
    swift/Ruler/Sources/AlignmentGuides/GuideLineManager.swift
    swift/Ruler/Sources/AlignmentGuides/GuideLine.swift
    swift/Ruler/Sources/AlignmentGuides/ColorCircleIndicator.swift
  </files>
  <action>
**GuideLineManager.swift — add resetRemoveMode() method:**
Add a new public method `resetRemoveMode()` that resets preview line state after a removal:
```swift
func resetRemoveMode() {
    previewLine.isInRemoveMode = false
    previewLine.setLineVisible(true)
}
```

This method must be called from AlignmentGuidesWindow.mouseDown() after `removeLine()` completes — Plan 02 will wire that call. For now, just add the method to GuideLineManager.

**GuideLine.swift — fix pill opacity:**
In `setupLayers()`, change the preview pill opacity from 0.7 to 1.0:
- Line 103: change `let opacity: Float = 0.7` to `let opacity: Float = 1.0`

Also in `layoutPill()`, change the non-remove-mode pill opacity from 0.7 to 1.0:
- Line 173: change `pillOpacity = 0.7` to `pillOpacity = 1.0`

**ColorCircleIndicator.swift — update borders:**
1. In `createCircleLayers()` (around line 213): change `layer.borderWidth = 1` to `layer.borderWidth = 2`
2. In `updateCircleSizes()` (around line 305): change `layer.borderWidth = isActive ? 2 : 1` to `layer.borderWidth = isActive ? 3 : 2`
3. In the `show()` method where shrink/grow transitions happen:
   - Line 137 (shrink old active): change `oldLayer.borderWidth = 1` to `oldLayer.borderWidth = 2`
   - Line 149 (grow new active): change `newLayer.borderWidth = 2` to `newLayer.borderWidth = 3`

**ColorCircleIndicator.swift — update dynamic circle colors:**
4. In `createDynamicPresetLayer()`:
   - Line 245: change `leftHalf.fillColor = CGColor(gray: 0, alpha: 1.0)` to `leftHalf.fillColor = CGColor(srgbRed: 0x29/255.0, green: 0x29/255.0, blue: 0x29/255.0, alpha: 1.0)`
   - Line 255: change `rightHalf.fillColor = CGColor(gray: 1.0, alpha: 1.0)` to `rightHalf.fillColor = CGColor(srgbRed: 0xE2/255.0, green: 0xE2/255.0, blue: 0xE2/255.0, alpha: 1.0)`

Note: `updateDynamicPresetSize()` only updates frame/path geometry, NOT colors. The fillColor persists on the existing sublayer objects, so no color change needed there.
  </action>
  <verify>Build: `cd /Users/haythem/conductor/workspaces/design-ruler-v1/rabat/swift/Ruler && swift build 2>&1 | tail -5` compiles without errors. Grep for `resetRemoveMode` in GuideLineManager.swift, verify `opacity: Float = 1.0` in GuideLine.swift, verify `borderWidth = 2` and `borderWidth = 3` in ColorCircleIndicator.swift, verify `0x29/255.0` and `0xE2/255.0` colors.</verify>
  <done>GuideLineManager has resetRemoveMode() method. GuideLine preview pill uses opacity 1.0. Color circles use 2px/3px borders. Dynamic circle uses #292929/#E2E2E2 colors.</done>
</task>

<task type="auto">
  <name>Task 2: Add alignment guides hint bar content + mode enum</name>
  <files>
    swift/Ruler/Sources/Rendering/HintBarContent.swift
    swift/Ruler/Sources/Rendering/HintBarView.swift
  </files>
  <action>
**HintBarView.swift — add KeyID cases and mode property:**
1. In `enum KeyID` (line 11), add `tab` and `space` cases:
   ```swift
   enum KeyID: Hashable, CaseIterable {
       case up, down, left, right, shift, esc, tab, space
   }
   ```

2. Add a public `state` accessor so AlignmentGuidesWindow can set mode:
   The `state` property on line 22 is already private. Add a public method to set mode:
   ```swift
   func setMode(_ mode: HintBarMode) {
       state.mode = mode
   }
   ```

**HintBarContent.swift — add HintBarMode enum + alignment guides content:**

1. Add `HintBarMode` enum at the top of the file (above HintBarState):
   ```swift
   enum HintBarMode {
       case inspect
       case alignmentGuides
   }
   ```

2. Add `mode` property to `HintBarState`:
   ```swift
   @Published var mode: HintBarMode = .inspect
   ```

3. Update `HintBarContent` body to branch on mode. Wrap existing content in `if state.mode == .inspect { ... }` and add `else { ... }` for alignment guides:
   - Alignment guides expanded text: `"Press"` [tab keycap with symbol "⇥", width 32, height 25, .system(size: 13, weight: .bold, design: .rounded), tracking -0.2, align: .center] `"to switch direction,"` [space keycap with symbol "space", width 48, height 25, .system(size: 11, weight: .bold, design: .rounded), tracking -0.2, align: .center] `"to change color."` [esc keycap — same as inspect] `"to exit"`
   - Use the same `text()`, `exitText()`, `escTint`, KeyCap helpers already in scope

4. Add `CollapsedAlignmentGuidesLeftContent` view (replaces CollapsedLeftContent for alignment guides):
   ```swift
   struct CollapsedAlignmentGuidesLeftContent: View {
       @ObservedObject var state: HintBarState
       var body: some View {
           HStack(spacing: 6) {
               KeyCap(.tab, symbol: "⇥", width: 32, height: 25,
                      symbolFont: .system(size: 13, weight: .bold, design: .rounded),
                      symbolTracking: -0.2, align: .center, state: state)
               KeyCap(.space, symbol: "space", width: 48, height: 25,
                      symbolFont: .system(size: 11, weight: .bold, design: .rounded),
                      symbolTracking: -0.2, align: .center, state: state)
           }
           .padding(.horizontal, 10)
           .frame(height: 48)
       }
   }
   ```
   CollapsedRightContent (ESC keycap) is reused as-is for both modes.

5. Update `HintBarGlassRoot` (macOS 26+ morph path) to support alignment guides mode:
   - In the `glassLayer` computed property: add conditional branching on `state.mode`
   - For `.alignmentGuides` expanded: show "Press" text + invisible tab/space keycaps + "to switch direction," + "to change color." + invisible esc + exit text
   - For `.alignmentGuides` collapsed: left group with invisible tab + space keycaps, right group with invisible esc keycap
   - In the `keycapLayer` computed property: add conditional branching on `state.mode`
   - For `.alignmentGuides`: show tab keycap + space keycap (left group), esc keycap (right group)
   - Create `private var tabCap` and `private var spaceCap` computed properties for reuse

6. Update `HintBarView.setupFallbackPath()` to conditionally use alignment guides collapsed content:
   The fallback path creates panels at init time. Since mode is set before `configure()` is called, read `state.mode` to decide which collapsed left content to use:
   ```swift
   // In setupFallbackPath(), replace the leftCollapsedPanel setup:
   if state.mode == .alignmentGuides {
       let leftContent = NSHostingView(rootView: CollapsedAlignmentGuidesLeftContent(state: state))
       // ... same wiring
   } else {
       let leftContent = NSHostingView(rootView: CollapsedLeftContent(state: state))
       // ... same wiring (existing code)
   }
   ```
   BUT: `setupHostingView()` is called from `init()` before mode can be set. Solution: make `setupFallbackPath()` lazy — defer it until `configure()` is called. OR: simpler — since `setMode()` must be called before `configure()`, restructure so `setupHostingView()` is called from `configure()` instead of `init()`. The morph path can also be deferred.

   Actually, the cleanest approach: keep `init()` as-is but add a `reconfigureForMode()` method that rebuilds the fallback panels when mode changes. Call it from `setMode()`.

   Simplest correct approach: In `HintBarView.init()`, only set `wantsLayer = true`. Move `setupHostingView()` call into `configure()` (called once after mode is set). This ensures mode is known before SwiftUI views are created.
  </action>
  <verify>Build: `cd /Users/haythem/conductor/workspaces/design-ruler-v1/rabat/swift/Ruler && swift build 2>&1 | tail -5` compiles without errors. Grep for `HintBarMode` in HintBarContent.swift, verify `case tab, space` in HintBarView.swift, verify `CollapsedAlignmentGuidesLeftContent` exists, verify `setMode` method exists.</verify>
  <done>HintBarMode enum exists with .inspect and .alignmentGuides cases. HintBarState has mode property. HintBarContent shows alignment guides text when mode is .alignmentGuides. Collapsed alignment guides content shows [tab][space] keycaps. HintBarGlassRoot supports alignment guides mode for macOS 26+ morph animation. HintBarView has setMode() method and deferred setup so mode is known before view creation. KeyID enum includes .tab and .space cases.</done>
</task>

</tasks>

<verification>
1. `swift build` succeeds in swift/Ruler directory
2. GuideLineManager.resetRemoveMode() method exists and resets isInRemoveMode + line visibility
3. GuideLine preview pill opacity is 1.0 (not 0.7)
4. ColorCircleIndicator uses 2px/3px border widths and #292929/#E2E2E2 dynamic colors
5. HintBarMode enum exists with .inspect and .alignmentGuides
6. HintBarContent renders alignment guides text when mode is .alignmentGuides
7. Collapsed content for alignment guides shows tab + space keycaps
8. Existing inspect hint bar behavior is unchanged (regression check)
</verification>

<success_criteria>
- All polish fixes applied (remove state method, pill opacity, borders, dynamic colors)
- Hint bar content infrastructure ready for alignment guides mode
- Build succeeds with no errors
- No regression in existing inspect command hint bar
</success_criteria>

<output>
After completion, create `.planning/phases/11-hint-bar-multi-monitor-polish/11-01-SUMMARY.md`
</output>
