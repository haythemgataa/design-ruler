---
phase: 23-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - App/Sources/DesignRuler.entitlements
  - App/ExportOptions.plist
  - App/project.yml
  - App/Sources/AppDelegate.swift
autonomous: true

must_haves:
  truths:
    - "App builds in Release configuration with Hardened Runtime enabled and entitlements file linked"
    - "ExportOptions.plist specifies developer-id export method for xcodebuild -exportArchive"
    - "project.yml has separate Debug (ad-hoc) and Release (Developer ID) code signing settings"
    - "Sparkle updater starts on launch (startingUpdater: true) ready for real EdDSA key"
  artifacts:
    - path: "App/Sources/DesignRuler.entitlements"
      provides: "Minimal entitlements file for Hardened Runtime (empty dict, no exceptions)"
    - path: "App/ExportOptions.plist"
      provides: "Developer ID export method for xcodebuild -exportArchive"
    - path: "App/project.yml"
      provides: "Release signing config with ENABLE_HARDENED_RUNTIME, CODE_SIGN_ENTITLEMENTS, Manual signing style"
    - path: "App/Sources/AppDelegate.swift"
      provides: "Sparkle updater with startingUpdater: true"
  key_links:
    - from: "App/project.yml"
      to: "App/Sources/DesignRuler.entitlements"
      via: "CODE_SIGN_ENTITLEMENTS build setting"
      pattern: "CODE_SIGN_ENTITLEMENTS.*DesignRuler.entitlements"
---

<objective>
Configure the Xcode project for Developer ID code signing, Hardened Runtime, and notarization readiness.

Purpose: The app must build with Hardened Runtime enabled and proper signing settings so that CI can produce a notarized binary. Sparkle must be re-enabled (was deferred in Phase 21) so auto-updates work once real keys are configured.

Output: Entitlements file, ExportOptions.plist, updated project.yml with Release signing config, re-enabled Sparkle updater.
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-distribution/23-RESEARCH.md

Key prior decisions:
- Phase 18: CODE_SIGN_IDENTITY="-" for Debug (ad-hoc). No entitlements file was created.
- Phase 18: xcodegen info.properties injects LSUIElement into generated plist.
- Phase 21: startingUpdater: false defers EdDSA key validation. Placeholder SUPublicEDKey in Info.plist.
- Phase 21: SUFeedURL placeholder: https://github.com/haythem/design-ruler/releases/latest/download/appcast.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create entitlements file and ExportOptions.plist</name>
  <files>App/Sources/DesignRuler.entitlements, App/ExportOptions.plist</files>
  <action>
Create two new files:

**1. `App/Sources/DesignRuler.entitlements`** — Minimal entitlements file with an empty dict. No Hardened Runtime exceptions are needed. CGWindowListCreateImage and CGEventTap are governed by TCC (runtime Screen Recording permission), not by code-signing entitlements. The file must be a valid XML plist:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict/>
</plist>
```

**2. `App/ExportOptions.plist`** — Developer ID export options for `xcodebuild -exportArchive`. This tells Xcode to use Developer ID signing (not App Store distribution):

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>developer-id</string>
    <key>signingStyle</key>
    <string>automatic</string>
    <key>stripSwiftSymbols</key>
    <true/>
</dict>
</plist>
```

NOTE: Do NOT add `resources:` to Package.swift (per CLAUDE.md anti-pattern). These files are only used by the Xcode project (App target), not SPM.
  </action>
  <verify>
Both files exist and are valid XML:
```bash
xmllint --noout App/Sources/DesignRuler.entitlements
xmllint --noout App/ExportOptions.plist
```
  </verify>
  <done>Both plist files exist, are valid XML, entitlements is an empty dict, ExportOptions specifies developer-id method</done>
</task>

<task type="auto">
  <name>Task 2: Update project.yml for Release signing and re-enable Sparkle updater</name>
  <files>App/project.yml, App/Sources/AppDelegate.swift</files>
  <action>
**1. Update `App/project.yml`** — Add Release-specific code signing settings and Hardened Runtime. The current settings block has:
- `base:` with CODE_SIGN_STYLE: Automatic
- `configs: Debug:` with CODE_SIGN_IDENTITY: "-"

Replace the settings block for the "Design Ruler" target with:

```yaml
settings:
  base:
    PRODUCT_BUNDLE_IDENTIFIER: cv.haythem.designruler
    PRODUCT_NAME: "Design Ruler"
    SWIFT_VERSION: "5.9"
    MACOSX_DEPLOYMENT_TARGET: "14.0"
    ARCHS: "$(ARCHS_STANDARD)"
    ENABLE_HARDENED_RUNTIME: YES
    CODE_SIGN_ENTITLEMENTS: Sources/DesignRuler.entitlements
    CURRENT_PROJECT_VERSION: "1"
    MARKETING_VERSION: "1.0.0"
  configs:
    Debug:
      CODE_SIGN_IDENTITY: "-"
      CODE_SIGN_STYLE: Automatic
    Release:
      CODE_SIGN_IDENTITY: "Developer ID Application"
      CODE_SIGN_STYLE: Manual
      DEVELOPMENT_TEAM: "$(DEVELOPMENT_TEAM)"
```

Key changes from current:
- Move CODE_SIGN_STYLE from base to per-config (Debug=Automatic, Release=Manual)
- Add ENABLE_HARDENED_RUNTIME: YES to base (applies to both configs)
- Add CODE_SIGN_ENTITLEMENTS pointing to the entitlements file
- Add Release config with Developer ID signing settings
- DEVELOPMENT_TEAM uses build setting variable — CI passes it via xcodebuild override

**2. Update `App/Sources/AppDelegate.swift`** — Change `startingUpdater: false` to `startingUpdater: true`. This was deferred in Phase 21-03 because the placeholder SUPublicEDKey would cause a validation error. With Phase 23, the real key will be set by the user as part of setup. Re-enabling now means Sparkle will attempt to start on launch — this is correct behavior once real keys are in place.

Find the line:
```swift
startingUpdater: false,
```
Replace with:
```swift
startingUpdater: true,
```

**3. Regenerate .xcodeproj** — Run `cd App && xcodegen generate` to regenerate the Xcode project from updated project.yml. The generated .xcodeproj is committed for convenience (Phase 18 decision).

**4. Verify build** — Run `cd App && xcodebuild build -scheme "Design Ruler" -configuration Debug` to verify the project still builds. Debug config uses ad-hoc signing so it builds without a Developer ID certificate.
  </action>
  <verify>
```bash
cd App && xcodegen generate && xcodebuild build -scheme "Design Ruler" -configuration Debug 2>&1 | tail -5
```
Should show BUILD SUCCEEDED. Verify Hardened Runtime setting:
```bash
grep -A2 "ENABLE_HARDENED_RUNTIME" App/project.yml
```
  </verify>
  <done>project.yml has Debug and Release signing configs, ENABLE_HARDENED_RUNTIME=YES in base, CODE_SIGN_ENTITLEMENTS linked, Sparkle startingUpdater=true, xcodegen regenerated, Debug build succeeds</done>
</task>

</tasks>

<verification>
1. `App/Sources/DesignRuler.entitlements` exists and is valid XML with empty dict
2. `App/ExportOptions.plist` exists and contains `developer-id` method
3. `App/project.yml` has ENABLE_HARDENED_RUNTIME: YES, CODE_SIGN_ENTITLEMENTS, Release config with Developer ID
4. `App/Sources/AppDelegate.swift` has `startingUpdater: true`
5. `cd App && xcodebuild build -scheme "Design Ruler" -configuration Debug` succeeds
</verification>

<success_criteria>
Xcode project is configured for Developer ID distribution with Hardened Runtime, entitlements, and export options. Sparkle updater is re-enabled. Debug builds still work without a Developer ID certificate.
</success_criteria>

<output>
After completion, create `.planning/phases/23-distribution/23-01-SUMMARY.md`
</output>
