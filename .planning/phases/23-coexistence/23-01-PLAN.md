---
phase: 23-coexistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - App/Sources/RaycastExtensionDetector.swift
  - App/Sources/SettingsView.swift
autonomous: true

must_haves:
  truths:
    - "When Settings opens with the Raycast extension installed and banner not yet dismissed, an info banner appears above the General section"
    - "Clicking Got it dismisses the banner permanently via UserDefaults"
    - "Re-opening Settings after dismissal does not show the banner"
    - "If the extension is uninstalled and the banner was never dismissed, it does not appear on Settings open"
  artifacts:
    - path: "App/Sources/RaycastExtensionDetector.swift"
      provides: "Filesystem detection heuristic for Design Ruler Raycast extension"
      contains: "isDesignRulerInstalled"
    - path: "App/Sources/SettingsView.swift"
      provides: "Coexistence info banner above General section with Got it dismiss"
      contains: "coexistenceBannerDismissed"
  key_links:
    - from: "App/Sources/SettingsView.swift"
      to: "App/Sources/RaycastExtensionDetector.swift"
      via: "onAppear calls RaycastExtensionDetector.isDesignRulerInstalled()"
      pattern: "RaycastExtensionDetector\\.isDesignRulerInstalled"
    - from: "App/Sources/SettingsView.swift"
      to: "UserDefaults"
      via: "Got it button persists coexistenceBannerDismissed flag"
      pattern: "coexistenceBannerDismissed"
---

<objective>
Add a one-time coexistence info banner to the Settings window that detects when the Design Ruler Raycast extension is also installed.

Purpose: Users who have both the standalone app and the Raycast extension see a friendly, non-intrusive heads-up recommending they keep only one. The banner appears inline in Settings (not as a popup), is dismissed permanently with "Got it", and re-checks the filesystem on every Settings open (so removing the extension makes the banner disappear).

Output: `RaycastExtensionDetector.swift` (detection heuristic) and updated `SettingsView.swift` (inline banner).
</objective>

<execution_context>
@/Users/haythem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haythem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-coexistence/23-RESEARCH.md
@App/Sources/SettingsView.swift
@App/Sources/AppPreferences.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RaycastExtensionDetector filesystem heuristic</name>
  <files>App/Sources/RaycastExtensionDetector.swift</files>
  <action>
Create `App/Sources/RaycastExtensionDetector.swift` as an enum with a single static function `isDesignRulerInstalled() -> Bool`.

Implementation:
1. Build the extensions URL: `FileManager.default.homeDirectoryForCurrentUser.appendingPathComponent(".config/raycast/extensions")`
2. Enumerate subdirectories with `FileManager.contentsOfDirectory(at:includingPropertiesForKeys:[.isDirectoryKey],options:[.skipsHiddenFiles])`, wrapped in `try?` (returns `false` if Raycast not installed)
3. For each subdirectory, check `resourceValues(forKeys: [.isDirectoryKey])` to confirm it is a real directory (skips symlinks like `node_modules`)
4. Read `package.json` inside each directory, parse with `JSONSerialization.jsonObject(with:)` as `[String: Any]`, check `json["name"] as? String == "design-ruler"`
5. Return `true` on first match, `false` if no match after full scan
6. All filesystem operations wrapped in `try?` — any failure is graceful (returns false or continues)

Import only `Foundation`. Use `enum` (no instances needed).
  </action>
  <verify>File exists at App/Sources/RaycastExtensionDetector.swift. Contains `enum RaycastExtensionDetector`, `isDesignRulerInstalled`, `".config/raycast/extensions"`, `"design-ruler"`, `.isDirectoryKey`, `.skipsHiddenFiles`, `JSONSerialization`. Build with `cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build 2>&1 | tail -5` — should show BUILD SUCCEEDED.</verify>
  <done>RaycastExtensionDetector.swift exists, compiles, and provides a static method that scans ~/.config/raycast/extensions/*/package.json for name == "design-ruler".</done>
</task>

<task type="auto">
  <name>Task 2: Add coexistence banner to SettingsView</name>
  <files>App/Sources/SettingsView.swift</files>
  <action>
Modify `SettingsView.swift` to add an inline info banner above the General section.

**Add two @State properties** to SettingsView:
```swift
@State private var raycastExtensionDetected = false
@State private var coexistenceDismissed = false
```

**Add a computed property:**
```swift
private var showCoexistenceBanner: Bool {
    raycastExtensionDetected && !coexistenceDismissed
}
```

**Add banner Section** inside `body`'s Form, BEFORE the `Section("General")`:
```swift
if showCoexistenceBanner {
    Section {
        HStack(spacing: 12) {
            Image(systemName: "info.circle.fill")
                .foregroundStyle(.blue)
                .font(.title3)

            VStack(alignment: .leading, spacing: 4) {
                Text("Raycast Extension Detected")
                    .fontWeight(.medium)
                Text("You have both the standalone app and the Raycast extension installed. Pick whichever you prefer.")
                    .foregroundStyle(.secondary)
                    .font(.callout)
            }

            Spacer()

            Button("Got it") {
                UserDefaults.standard.set(true, forKey: "coexistenceBannerDismissed")
                withAnimation {
                    coexistenceDismissed = true
                }
            }
        }
        .padding(.vertical, 4)
    }
}
```

Tone: Friendly heads-up, neutral message, no warning language, no mention of conflicts. Single "Got it" dismiss — no action buttons. Per locked user decisions.

**Update the existing `.onAppear` modifier** to also read the dismissed flag and run detection:
```swift
.onAppear {
    launchAtLogin = SMAppService.mainApp.status == .enabled
    coexistenceDismissed = UserDefaults.standard.bool(forKey: "coexistenceBannerDismissed")
    if !coexistenceDismissed {
        raycastExtensionDetected = RaycastExtensionDetector.isDesignRulerInstalled()
    }
}
```

Key behaviors per user decisions:
- Detection is lazy — only runs when Settings opens (NOT on app launch)
- If already dismissed, skip detection entirely (optimization)
- Dismissed flag persisted in UserDefaults as `"coexistenceBannerDismissed"` (Bool)
- Once dismissed, banner never returns (even if extension reinstalled later)
- If not dismissed: banner visibility depends on live detection each time Settings opens
- `withAnimation` on dismissal for smooth collapse
  </action>
  <verify>Build succeeds: `cd /Users/haythem/conductor/workspaces/design-ruler-v2/porto/App && xcodebuild -project "Design Ruler.xcodeproj" -scheme "Design Ruler" -configuration Debug build 2>&1 | tail -5`. SettingsView.swift contains: `showCoexistenceBanner`, `raycastExtensionDetected`, `coexistenceDismissed`, `"coexistenceBannerDismissed"`, `RaycastExtensionDetector.isDesignRulerInstalled`, `"Got it"`, `"Raycast Extension Detected"`, `withAnimation`.</verify>
  <done>Settings window shows an inline info banner above the General section when the Raycast extension is detected and not yet dismissed. "Got it" dismisses permanently. Re-opening Settings re-checks the filesystem (unless already dismissed).</done>
</task>

</tasks>

<verification>
1. `App/Sources/RaycastExtensionDetector.swift` exists with `isDesignRulerInstalled()` static method
2. `App/Sources/SettingsView.swift` has coexistence banner Section above General section
3. Banner visibility gated on `raycastExtensionDetected && !coexistenceDismissed`
4. Detection only runs in `.onAppear` (lazy, not on app launch)
5. "Got it" persists `coexistenceBannerDismissed` to UserDefaults and animates dismissal
6. `.onAppear` re-reads dismissed flag + re-runs detection (unless dismissed)
7. `xcodebuild` passes — BUILD SUCCEEDED
</verification>

<success_criteria>
- New file `RaycastExtensionDetector.swift` compiles and scans `~/.config/raycast/extensions/*/package.json`
- Banner appears above General section in Settings when extension detected and not dismissed
- "Got it" dismisses permanently via UserDefaults
- Detection is lazy (only on Settings open, not app launch)
- Build succeeds with no warnings from new code
</success_criteria>

<output>
After completion, create `.planning/phases/23-coexistence/23-01-SUMMARY.md`
</output>
